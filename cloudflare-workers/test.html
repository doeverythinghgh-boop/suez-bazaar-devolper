<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù„ÙØ§Øª - BidStory</title>
  <style>
    body {
      font-family: sans-serif;
      background: #fdfeff;
      padding: 20px;
      color: #333;
    }
    input, button {
      margin: 5px 0;
      padding: 8px;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      background-color: #333;
      color: white;
      cursor: pointer;
    }
    .log {
      margin-top: 15px;
      background: #eee;
      padding: 10px;
      border-radius: 6px;
      white-space: pre-wrap;
      font-family: monospace;
    }
  </style>
</head>
<body>

  <h2>ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª (Ø±ÙØ¹ - ØªØ­Ù…ÙŠÙ„ - Ø­Ø°Ù)</h2>

  <label>ğŸ“¤ Ø§Ø®ØªØ± Ù…Ù„Ù Ù„Ù„Ø±ÙØ¹:</label>
  <input type="file" id="fileInput" />

  <button onclick="uploadFile()">ğŸš€ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù</button>

  <label>ğŸ“¥ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù (Ù„ØªØ­Ù…ÙŠÙ„Ù‡ Ø£Ùˆ Ø­Ø°ÙÙ‡):</label>
  <input type="text" id="fileName" placeholder="Ù…Ø«Ù„Ø§Ù‹: test.pdf" />

  <button onclick="downloadFile()">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</button>
  <button onclick="deleteFile()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù</button>

  <div class="log" id="log">ğŸ“Œ Ø§Ù„Ø³Ø¬Ù„ Ù‡Ù†Ø§...</div>

  <script>
    const baseUrl = "https://bidstory-files.bidsstories.workers.dev";

    async function ensureToken() {
      const existing = localStorage.getItem("X-Auth-Key");
      if (existing) return existing;

      log("ğŸ” Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ ØªÙˆÙƒÙ† Ø§Ù„Ø¯Ø®ÙˆÙ„...");
      try {
        const res = await fetch(baseUrl + "/login");
        const { token } = await res.json();
        localStorage.setItem("X-Auth-Key", token);
        log("âœ… ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙˆÙƒÙ†.");
        return token;
      } catch (err) {
        log("âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªÙˆÙƒÙ†: " + err);
        throw err;
      }
    }

    function log(msg) {
      document.getElementById("log").textContent += "\n" + msg;
    }

    async function uploadFile() {
      const token = await ensureToken();
      const file = document.getElementById("fileInput").files[0];
      if (!file) return log("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ù„Ù.");

      log("ğŸŸ¢ ğŸš€ Ø¨Ø¯Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù...");
      const formData = new FormData();
      formData.append("file", file);

      try {
        const res = await fetch(baseUrl + "/upload", {
          method: "POST",
          headers: { "X-Auth-Key": token },
          body: formData
        });

        const result = await res.json();
        if (res.ok) {
          log("âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù: " + result.file);
        } else {
          log("âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: " + result.error);
        }
      } catch (err) {
        log("âŒ ğŸ›‘ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù: " + err);
      }
    }

    async function downloadFile() {
      const token = await ensureToken();
      const fileName = document.getElementById("fileName").value.trim();
      if (!fileName) return log("âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù.");

      log("ğŸ”„ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù...");
      try {
        const res = await fetch(`${baseUrl}/download?file=${encodeURIComponent(fileName)}`, {
          method: "GET",
          headers: { "X-Auth-Key": token }
        });

        if (!res.ok) {
          const err = await res.json();
          return log("âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„: " + err.error);
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        a.click();
        log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­.");
      } catch (err) {
        log("âŒ ğŸ›‘ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„: " + err);
      }
    }

    async function deleteFile() {
      const token = await ensureToken();
      const fileName = document.getElementById("fileName").value.trim();
      if (!fileName) return log("âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù.");

      log("âš ï¸ Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù...");
      try {
        const res = await fetch(`${baseUrl}/delete?file=${encodeURIComponent(fileName)}`, {
          method: "DELETE",
          headers: { "X-Auth-Key": token }
        });

        const result = await res.json();
        if (res.ok) {
          log("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù: " + result.file);
        } else {
          log("âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: " + result.error);
        }
      } catch (err) {
        log("âŒ ğŸ›‘ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: " + err);
      }
    }
  </script>
</body>
</html>
