<!DOCTYPE html>
<html lang="ar" dir="rtl" id="html-root">

<head id="head-section">
    <meta charset="UTF-8" id="meta-charset">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" id="meta-viewport">
    <title id="page-title">ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÇÿØŸÖ</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet"
        id="font-link">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.2/css/all.css" id="fontawesome-link">

    <link rel="stylesheet" href="style.css" id="main-stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" id="sweetalert-script"></script>

    <!-- Notification Dependencies -->
    <script src="../js/config.js"></script>
    <script src="../js/network.js"></script>
    <script src="../js/globalVariable.js"></script>
    <script src="../notification/notificationSetUp.js"></script>
    <script src="../notification/notificationTools.js"></script>
    <script src="../notification/notification-db-manager.js"></script>

    <script>
        // Initialize userSession for notificationTools.js
        window.userSession = JSON.parse(localStorage.getItem("loggedInUser")) || null;
    </script>

    <script src="./main.js" type="module" id="main-script"></script>
</head>

<body id="body-content">
    <div class="container" id="main-container">
        <!-- ÿπÿ±ÿ∂ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≠ÿßŸÑŸä (ÿ™ŸÖ ŸÜŸÇŸÑŸá ÿ•ŸÑŸâ ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠) -->
        <main id="main-content">
            <!-- ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä ŸÑŸÑÿ≠ÿßŸÑÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© -->

            <!-- ‚úÖ ÿ¨ÿØŸäÿØ: ÿ±ÿßÿ®ÿ∑ ÿπÿ±ÿ∂ ÿµŸàÿ± ÿßŸÑÿ∑ŸÑÿ® ÿßŸÑÿÆÿßÿµ -->
            <div style="text-align:center; margin-bottom:15px; display:none;" id="orderPhotoLinkContainer">
                <a href="#" id="orderPhotoLink"
                    style="color:#007bff; font-weight:bold; text-decoration:underline; font-size:1rem; display:inline-flex; align-items:center; gap:8px; padding: 5px 10px; background: #eef2f7; border-radius: 20px;">
                    <i class="fas fa-images"></i> ÿπÿ±ÿ∂ ÿµŸàÿ± ÿßŸÑÿ∑ŸÑÿ® ÿßŸÑÿÆÿßÿµ
                </a>
            </div>

            <div class="stepper-container" id="primary-stepper-container">
                <div class="stepper-wrapper" id="primary-stepper-wrapper">
                    <!-- ÿßŸÑÿÆÿ∑Ÿàÿ© 1: ŸÖÿ±ÿßÿ¨ÿπÿ© -->
                    <div id="step-review" class="step-item review">
                        <div class="step-circle" id="step-review-circle">
                            <i class="fas fa-list-check" id="step-review-icon"></i>
                        </div>
                        <div class="step-label" id="step-review-label">ŸÖÿ±ÿßÿ¨ÿπÿ©</div>
                    </div>

                    <!-- ÿßŸÑÿÆÿ∑Ÿàÿ© 2: ŸÖÿ§ŸÉÿØ -->
                    <div id="step-confirmed" class="step-item confirmed">
                        <div class="step-circle" id="step-confirmed-circle">
                            <i class="fas fa-hand-peace" id="step-confirmed-icon"></i>
                        </div>
                        <div class="step-label" id="step-confirmed-label">ŸÖÿ§ŸÉÿØ</div>
                    </div>

                    <!-- ÿßŸÑÿÆÿ∑Ÿàÿ© 3: ÿ¥Ÿèÿ≠ŸÜ (ŸÜÿ¥ÿ∑ÿ©) -->
                    <div id="step-shipped" class="step-item shipped">
                        <div class="step-circle" id="step-shipped-circle">
                            <i class="fas fa-truck" id="step-shipped-icon"></i>
                        </div>
                        <div class="step-label" id="step-shipped-label">ÿ¥Ÿèÿ≠ŸÜ</div>
                    </div>

                    <!-- ÿßŸÑÿÆÿ∑Ÿàÿ© 4: ÿ™ŸÖ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ -->
                    <div id="step-delivered" class="step-item delivered">
                        <div class="step-circle" id="step-delivered-circle">
                            <i class="fas fa-box-open" id="step-delivered-icon"></i>
                        </div>
                        <div class="step-label" id="step-delivered-label">ÿ™ŸÖ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ</div>
                    </div>
                </div>
            </div>

            <!-- ÿ≠ÿßŸàŸäÿ© ŸàÿµŸÅ ÿßŸÑÿÆÿ∑Ÿàÿ© -->
            <div id="step-description-container" class="step-description"
                style="text-align: center; margin-top: 1.5rem; font-weight: bold; color: #007bff; font-size: 0.9rem;">
                <!-- ÿ≥Ÿäÿ™ŸÖ ÿ•ÿØÿ±ÿßÿ¨ ÿßŸÑŸàÿµŸÅ ŸáŸÜÿß ÿ®Ÿàÿßÿ≥ÿ∑ÿ© JavaScript -->
            </div>

            <!-- ÿ≠ÿßŸàŸäÿ© ÿ±ÿ≥ÿßŸÑÿ© ÿπÿØŸÖ ÿßŸÑÿ≥ŸÖÿßÿ≠ -->
            <div id="permission-denied-message" class="alert-message"></div>

            <!-- ÿ¥ÿ±Ÿäÿ∑ ŸÖŸÜŸÅÿµŸÑ ŸÑŸÑÿ≠ÿßŸÑÿßÿ™ ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ© -->
            <div class="stepper-container" style="margin-top: 2.5rem;" id="secondary-stepper-container">
                <div class="stepper-wrapper" style="justify-content: center; gap: 0rem;" id="secondary-stepper-wrapper">
                    <!-- ŸÖŸÑÿ∫Ÿä -->
                    <div id="step-cancelled" class="step-item cancelled">
                        <div class="step-circle" id="step-cancelled-circle">
                            <i class="fa-solid fa-circle-xmark" id="step-cancelled-icon"></i>
                        </div>
                        <div class="step-label" id="step-cancelled-label">ŸÖŸÑÿ∫Ÿä</div>
                    </div>

                    <!-- ŸÖÿ±ŸÅŸàÿ∂ -->
                    <div id="step-rejected" class="step-item rejected">
                        <div class="step-circle" id="step-rejected-circle">
                            <i class="fas fa-thumbs-down" id="step-rejected-icon"></i>
                        </div>
                        <div class="step-label" id="step-rejected-label">ŸÖÿ±ŸÅŸàÿ∂</div>
                    </div>

                    <!-- ŸÖÿ±ÿ™ÿ¨ÿπ -->
                    <div id="step-returned" class="step-item returned">
                        <div class="step-circle" id="step-returned-circle">
                            <i class="fa-solid fa-arrow-rotate-left" id="step-returned-icon"></i>
                        </div>
                        <div class="step-label" id="step-returned-label">ŸÖÿ±ÿ™ÿ¨ÿπ</div>
                    </div>
                </div>
            </div>

            <!-- ÿ≠ÿßŸàŸäÿ© ŸàÿµŸÅ ÿßŸÑÿÆÿ∑Ÿàÿßÿ™ ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ© (5-7) -->
            <div id="secondary-step-description-container"
                style="text-align: center; margin-top: 1.5rem; font-weight: bold; color: red; font-size: 0.9rem;">
            </div>
        </main>
    </div>
</body>

</html>
<script type="module">
    import { ordersData, initializationPromise } from './config.js';

    // Steps definition - static configuration for the stepper
    const DEFAULT_STEPS = [
        { id: "step-review", no: "1" },
        { id: "step-confirmed", no: "2" },
        { id: "step-shipped", no: "3" },
        { id: "step-delivered", no: "4" },
        { id: "step-cancelled", no: "5" },
        { id: "step-rejected", no: "6" }
    ];

    // User Permissions definition - static configuration
    const DEFAULT_USERS = [
        {
            type: "buyer",
            allowedSteps: ["step-review", "step-confirmed", "step-delivered", "step-cancelled", "step-returned"]
        },
        {
            type: "seller",
            allowedSteps: ["step-review", "step-confirmed", "step-shipped", "step-rejected", "step-cancelled"]
        },
        {
            type: "courier",
            allowedSteps: ["step-shipped", "step-delivered"]
        },
        {
            type: "admin",
            allowedSteps: ["step-review", "step-confirmed", "step-shipped", "step-delivered", "step-cancelled", "step-rejected", "step-returned"]
        }
    ];

    document.addEventListener('DOMContentLoaded', () => {
        // 1. Data Bridging: Fetch data from parent window if available
        if (window.parent && window.parent.globalStepperAppData && window.initializeStepperData) {
            console.log("üîó [StepperOnly] Found parent data, bridging...");
            const parentData = window.parent.globalStepperAppData;

            const control = {
                currentUser: {
                    idUser: parentData.idUser,
                    type: "unknown" // Will be determined by logic
                },
                steps: DEFAULT_STEPS,
                users: DEFAULT_USERS
            };
            const orders = parentData.ordersData || [];

            // Inject data into the app
            window.initializeStepperData(control, orders);
        } else {
            console.warn("‚ö†Ô∏è [StepperOnly] No parent data found or initializeStepperData missing.");
        }

        // 2. Photo Link Logic (Existing)
        const checkData = setInterval(() => {
            // Need to check the exported ordersData, or wait for initialization
            if (ordersData && ordersData.length > 0) {
                clearInterval(checkData);
                initPhotoLink();
            }
        }, 500);

        function initPhotoLink() {
            const linkContainer = document.getElementById('orderPhotoLinkContainer');
            const link = document.getElementById('orderPhotoLink');

            if (ordersData.length > 0) {
                const order = ordersData[0];
                const item = order.order_items && order.order_items[0];

                console.log("[StepperOnly] Checking order for photo link:", {
                    total_amount: order.total_amount,
                    type: typeof order.total_amount,
                    condition: (order.total_amount == 0)
                });

                // Only show for special orders where total_amount is 0
                if (item && order.total_amount == 0) {
                    const u = order.user_key;
                    const s = item.seller_key;
                    const p = item.product_key;
                    const o = order.order_key;

                    link.onclick = (e) => {
                        e.preventDefault();
                        window.parent.orderPhotoParams = { u, s, p, o };
                        window.parent.mainLoader(`../pages/orderPhoto.html?u=${u}&s=${s}&p=${p}&o=${o}`, "index-orderPhoto-container", 0, undefined, "showHomeIcon", true);
                    };

                    linkContainer.style.display = 'block';
                } else {
                    linkContainer.style.display = 'none';
                }
            }
        }
    });
</script>