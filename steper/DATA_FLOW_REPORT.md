# تقرير تحليل تدفق البيانات والتوافق (Data Flow & Consistency Report)

يحلل هذا التقرير كيفية إدارة البيانات في مجلد `steper`، بدءاً من العرض في الواجهة (UI)، مروراً بالتخزين المحلي (LocalStorage)، ووصولاً إلى التخزين السحابي (Cloud/Server)، وكيفية ضمان التزامن بينهم.

## 1. نموذج البيانات (Data Model)

يعتمد التطبيق على ثلاث طبقات للبيانات:
1.  **الذاكرة (In-Memory)**: متغيرات `globalStepperAppData` و `ordersData` في `config.js`. تعتبر المصدر الفوري لتحديث واجهة المستخدم.
2.  **التخزين المحلي (LocalStorage)**: يستخدم لحفظ حالة التطبيق (`steps`, `dates`, `items`) لضمان الاستمرارية عبر إعادة التحميل. المفتاح المستخدم يعتمد على `order_key`.
3.  **التخزين السحابي (Server/Cloud)**: يتم فيه حفظ حالات المنتجات (`item_status`) داخل حقل `order_status` في قاعدة البيانات.

---

## 2. تدفق البيانات (Data Flow)

### أ. قراءة البيانات (Initialization)
عند بدء التطبيق (`main.js` -> `initApp`):
1.  **جلب البيانات**: يتم جلب `controlData` و `ordersData` (محاكاة عبر Promise في `dataFetchers.js`).
2.  **دمج الحالة (`stateManagement.js` -> `initializeState`)**:
    *   يتم قراءة الحالة المخزنة محلياً (`getAppState`).
    *   **أولوية السيرفر**: يتم فحص `ordersData` القادم من السيرفر. إذا كان هناك حالة لمنتج (`item.item_status`) تختلف عما في التخزين المحلي، يتم **اعتماد حالة السيرفر وتحديث التخزين المحلي** (Self-Correction/Sync).
    *   يتم دمج البيانات وتحديث المتغيرات العالمية.

### ب. كتابة البيانات (User Action & Saving)
عندما يقوم المستخدم بتغيير حالة منتج (مثلاً في `sellerPopups.js`):
1.  **إجراء المستخدم**: يضغط المستخدم على Checkbox ويحفظ.
2.  **تحديث الحالة (`stateManagement.js` -> `saveItemStatus`)**:
    *   **تحديث الذاكرة والـ LocalStorage**:
        *   يتم تحديث `globalStepperAppData`.
        *   يتم الحفظ فوراً في `LocalStorage` عبر `saveAppState`.
    *   **تحديث السيرفر (Server Sync)**:
        *   يتم استدعاء `updateServerItemStatus` في `dataFetchers.js`.
        *   يتم إرسال طلب `POST` إلى `/api/update-item-status`.
        *   **لا يتم انتظار استجابة السيرفر** لتحديث الواجهة (Optimistic Update)، مما يضمن استجابة سريعة.

### ج. التحديث الفوري للبيانات المحلية (`updateLocalOrderStatus` في `dataFetchers.js`)
*   يوجد منطق خاص لتحديث `ordersData` في الذاكرة فوراً بعد إرسال طلب السيرفر.
*   يقوم هذا المنطق بتحليل النص JSON الموجود داخل `order_status`، تعديل القيمة المطلوبة، وإعادة تركيبه.
*   **الهدف**: ضمان أن أي أجزاء أخرى من الكود تقرأ من `ordersData` (مثل `roleAndStepDetermination.js`) ترى التعديلات فوراً دون الحاجة لإعادة جلب البيانات من السيرفر.

---

## 3. التوافق (Consistency Analysis)

| الطبقة | الحالة | الملاحظات |
| :--- | :--- | :--- |
| **المعروض للمستخدم (UI)** | ✅ متزامن (Optimistic) | يتم تحديث الواجهة فوراً بعد الحفظ المحلي، قبل استجابة السيرفر. يعتمد على `uiUpdates.js` الذي يقرأ من الحالة المحدثة. |
| **التخزين المحلي (Local)** | ✅ متزامن | يتم الحفظ فيه في نفس اللحظة التي يتم فيها تحديث الذاكرة. |
| **التخزين السحابي (Cloud)** | ⚠️ غير متزامن لحظياً (Async) | يتم إرسال الطلب في الخلفية. في حال فشل الاتصال، قد يحدث تباين مؤقت حتى إعادة تحميل الصفحة (حيث يعمل منطق `initializeState` على المصالحة). |
| **الذاكرة (Memory)** | ✅ متزامن | يتم تحديث بنية `globalStepperAppData` و `ordersData` يدوياً لضمان انعكاس التغييرات فوراً على باقي منطق التطبيق. |

### نقاط القوة:
1.  **الاستجابة السريعة**: لا ينتظر المستخدم تحميل الشبكة.
2.  **التعافي الذاتي (Self-Healing)**: عند إعادة تحميل الصفحة، تكون الأولوية لبيانات السيرفر، مما يصحح أي أخطاء تزامنية سابقة.
3.  **آلية القفل (Locking)**: يتم التعامل معها بنفس الآلية (تحديث محلي فوري + حفظ سيرفر)، مما يمنع المستخدم من التعديل فوراً حتى لو كان الإنترنت بطيئاً.

### نقاط الضعف المحتملة:
1.  **خطأ الشبكة الصامت**: إذا فشل طلب `updateServerItemStatus`، يظهر Error في الكونسول فقط. المستخدم سيظن أن البيانات حفظت (لأنها في LocalStorage)، لكن عند فتح التطبيق من جهاز آخر لن يجدها. (الحل المقترح مستقبلاً: Retry Mechanism أو تنبيه المستخدم).

---

## 4. الخلاصة

النظام مصمم بشكل جيد ليعمل بأسلوب **"Local First, Sync Later"** جزئياً.
*   **ما يراه المستخدم**: هو انعكاس مباشر للذاكرة والتخزين المحلي.
*   **ما يتم توفيره**: تزامن قوي عند البدء (Init) وتزامن تفاؤلي (Optimistic) عند التعديل.

النظام متوافق بشكل عام، مع اعتماد قوي على مصداقية بيانات السيرفر عند البدء لتصحيح التخزين المحلي.
