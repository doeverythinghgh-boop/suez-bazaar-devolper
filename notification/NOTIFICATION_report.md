## 1. إدارة الإعدادات المركزية (Cloudflare R2)

### واجهة الإدارة (`notification/page/settings.js`)

| البند | التفاصيل |
|------|----------|
| التحميل (Load) | يتم جلب ملف `notification_config.json` مباشرة من الرابط العام (R2 Public Bucket).<br>- تم استخدام `cache-busting` لضمان جلب أحدث نسخة. |
| الحفظ (Save) | يتم رفع ملف JSON المحدث إلى السحابة باستخدام `uploadFile2cf` عند الحفظ. |

### نقطة البداية (`index.html` & `notificationTools.js`)

| البند | التفاصيل |
|------|----------|
| التحميل المسبق | يتم جلب التكوين عند بدء التشغيل وحفظه في `window.globalNotificationConfig`. |
| المنطق | دالة `shouldNotify` تتحقق دائماً من هذا التكوين المركزي قبل إرسال أي إشعار. |

---

## 2. تكامل إشعارات المراحل (Step Notifications Integration)

تم ربط دوال الإشعارات (`notifyOnStepActivation`) بأزرار الحفظ في نوافذ التحكم بالمراحل (`Popups`).

### أ. نافذة البائع (`steper/sellerPopups.js`)

#### عند تأكيد الطلب (Confirmation Save)

| العنصر | التفاصيل |
|--------|----------|
| الاستدعاء | يتم استدعاء `window.notifyOnStepActivation` بالمعامل `step-confirmed`. |
| المستلمون | المشتري (تم تأكيد طلبك)، الإدارة، وشركات التوصيل (طلب جاهز للشحن). |
| حالة الرفض | إذا تضمنت العملية رفض منتجات، يتم إرسال إشعار إضافي `step-rejected` للمشتري. |

#### عند شحن الطلب (Shipping Save)

| العنصر | التفاصيل |
|--------|----------|
| تخصيص هام | تم قصر الإشعار هنا على **المشتري فقط**. |
| آلية التنفيذ | يتم استدعاء `window.notifyBuyerOnStepChange` مباشرة بعد التحقق من الإذن عبر `shouldNotify`. |
| المستلمون | المشتري فقط (تم شحن طلبك). لا يتم إزعاج الإدارة أو شركة التوصيل بهذه الخطوة. |

### ب. نافذة المشتري (`steper/buyerPopups.js`)

#### عند مراجعة المنتجات (Review Save)

| العنصر | التفاصيل |
|--------|----------|
| الشرط | إذا قام المشتري بإلغاء منتجات. |
| الاستدعاء | يتم استدعاء `notifyOnStepActivation` بالمعامل `step-cancelled`. |
| المستلمون | البائع (منتجات ملغاة). |

#### عند استلام الطلب (Delivery Save)

| العنصر | التفاصيل |
|--------|----------|
| الشرط | عند تأكيد الاستلام. |
| الاستدعاء | يتم استدعاء `notifyOnStepActivation` بالمعامل `step-delivered`. |
| المستلمون | البائع (تم تسليم الطلب)، والإدارة. |

---

## 3. التحقق (Verification)

| # | البند | التفاصيل |
|---|------|----------|
| 1 | إشعارات الشراء | تعمل من `cardPackage.html` عند إتمام الطلب. |
| 2 | إعدادات الإشعارات | يتم جلبها من JSON المركزي. إذا تم تعطيل إشعار معين (مثلاً تعطيل `step-shipped` للمشتري)، لن يتم إرسال الإشعار حتى لو تم الضغط على زر الشحن. |
| 3 | البيانات | يتم استخراج بيانات الهواتف/التوكنات ديناميكياً من الطلب باستخدام دالة `extractNotificationMetadata` لضمان الدقة. |

## ملاحظات فنية

| الملاحظة | الشرح |
|----------|-------|
| احترام الإعدادات | تعتمد جميع الإشعارات على دالة `window.shouldNotify` لضمان احترام رغبة المدير. |
| الأداء | الكود مصمم ليعمل بالتوازي (Non-blocking) مع عمليات الحفظ، بحيث لا يتأثر أداء الواجهة بعملية إرسال الإشعارات. |
