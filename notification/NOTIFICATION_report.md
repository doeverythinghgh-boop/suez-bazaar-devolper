## 1. إدارة الإعدادات المركزية (Cloudflare R2)

### واجهة الإدارة (`notification/page/settings.js`)

| البند | التفاصيل |
|------|----------|
| التحميل (Load) | يتم جلب ملف `notification_config.json` مباشرة من الرابط العام (R2 Public Bucket).<br>- تم استخدام `cache-busting` لضمان جلب أحدث نسخة. |
| الحفظ (Save) | يتم رفع ملف JSON المحدث إلى السحابة باستخدام `uploadFile2cf` عند الحفظ. |

### نقطة البداية (`index.html` & `notificationTools.js`)

| البند | التفاصيل |
|------|----------|
| التحميل المسبق | يتم جلب التكوين عند بدء التشغيل وحفظه في `window.globalNotificationConfig`. |
| المنطق | دالة `shouldNotify` تتحقق دائماً من هذا التكوين المركزي قبل إرسال أي إشعار. |
| حالة النظام | يتم تتبع `seller_key` لكل صنف في الذاكرة (`stateManagement.js`) لضمان سرعة تحديد البائع المعني عند الإلغاء أو الاستلام. |

---

## 2. تكامل إشعارات المراحل (Step Notifications Integration)

تم ربط دوال الإشعارات (`notifyOnStepActivation`) بأزرار الحفظ في نوافذ التحكم بالمراحل (`Popups`) مع ميزة **الاستهداف الموجه**.

### أ. نافذة البائع (`steper/sellerPopups.js`)

#### عند تأكيد الطلب (Confirmation Save)

| العنصر | التفاصيل |
|--------|----------|
| الاستدعاء | يتم استدعاء `window.notifyOnStepActivation` بالمعامل `step-confirmed`. |
| المستلمون | المشتري، الإدارة، وشركات التوصيل. |
| تصفية البائعين | يتم إرسال الإشعار لبقية البائعين في الطلب (إن وُجدوا) مستثنياً البائع الذي قام بالإجراء حالياً لمنع الإزعاج. |

#### عند شحن الطلب (Shipping Save)

| العنصر | التفاصيل |
|--------|----------|
| المستلمون | المشتري فقط + البائعين الآخرين المتأثرين بالشحن (إن وُجدوا)، مع استثناء البائع الحالي. |

### ب. نافذة المشتري (`steper/buyerPopups.js`)

#### عند مراجعة المنتجات (Review Save)

| العنصر | التفاصيل |
|--------|----------|
| الشرط | إذا قام المشتري بإلغاء منتجات. |
| الاستهداف الموجه | يتم استخراج مفاتيح البائعين (`sellerKeys`) للأصناف الملغاة فقط. |
| المستلمون | **البائع صاحب المنتج الملغى فقط**، ولا يتم إزعاج بقية بائعي الطلب. |

#### عند استلام الطلب (Delivery Save)

| العنصر | التفاصيل |
|--------|----------|
| الاستهداف الموجه | يتم تصفية البائعين بحيث لا يصل إشعار "تم التسليم" إلا للبائع الذي تم استلام أصنافه فعلياً. |
| المستلمون | البائع المعني، والإدارة. |

---

## 3. التحقق (Verification)

| # | البند | التفاصيل |
|---|------|----------|
| 1 | إشعارات الشراء | تعمل من `cardPackage.html` عند إتمام الطلب للجميع. |
| 2 | الاستهداف الدقيق | استخدام دالة `extractRelevantSellerKeys` لضمان وصول الإشعارات لمن يهمه الأمر فقط. |
| 3 | منع الإشعارات الذاتية | البائع لا يتلقى إشعار دفع (Push) عن إجراء قام به هو بنفسه. |
| 4 | البيانات | يتم استخراج بيانات الهواتف/التوكنات ديناميكياً من الطلب باستخدام دالة `extractNotificationMetadata` لضمان الدقة. |

## ملاحظات فنية

| الملاحظة | الشرح |
|----------|-------|
| احترام الإعدادات | تعتمد جميع الإشعارات على دالة `window.shouldNotify` لضمان احترام رغبة المدير. |
| تتبع البائعين | تمت إضافة `seller_key` لهيكل البيانات في `stateManagement.js` لدعم الاستهداف الموجه في المراحل الفرعية (ملغي، مرتجع، مرفوض). |
| الأداء | الكود مصمم ليعمل بالتوازي (Non-blocking) مع عمليات الحفظ، بحيث لا يتأثر أداء الواجهة بعملية إرسال الإشعارات. |
