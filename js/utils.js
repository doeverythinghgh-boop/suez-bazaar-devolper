/**
 * @file js/utils.js
 * @description ูุญุชูู ูุฐุง ุงูููู ุนูู ุฏูุงู ูุณุงุนุฏุฉ ุนุงูุฉ ูููู ุงุณุชุฎุฏุงููุง ูู ุฃู ููุงู ูู ุงููุดุฑูุน.
 * @param {boolean} [showAlert=false] - ุฅุฐุง ูุงูุช `true`ุ ุณุชุนุฑุถ ุงูุฏุงูุฉ ุชูุจูููุง ุนูุฏ ุงููุทุงุน ุงูุงุชุตุงู.
 */
// ๐ฆ ุชุฎุฒูู ูุคูุช ูุญุงูุฉ ุงูุงุชุตุงู
let lastConnectionCheck = 0;
let isConnectedCache = false;
const CONNECTION_CHECK_INTERVAL = 3000; // 3 ุซูุงูู

async function checkInternetConnection(showAlert = true) {
  // ูู ุงูุฃูุถู ุฏุงุฆููุง ุงูุชุญูู ูู ูุฌูุฏ ุงููุงุฆู 'Android' ูุจู ุงุณุชุฎุฏุงูู
// ูุฐุง ูุถูู ุฃู ุงูููุฏ ูู ูุณุจุจ ุฎุทุฃ ุฅุฐุง ุชู ูุชุญู ูู ูุชุตูุญ ุนุงุฏู ุฎุงุฑุฌ ุงูุชุทุจูู
if (window.Android && typeof window.Android.checkInternetWithToast === 'function') {
    console.log("ุณูุชู ุงูุขู ูุญุต ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช ุนุจุฑ ููุฏ Kotlin...");

    // ุงุณุชุฏุนุงุก ุงูุฏุงูุฉ ูุจุงุดุฑุฉ
    const hasInternet = window.Android.checkInternetWithToast();

    if (hasInternet) {
        console.log("ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช ููุฌูุฏ. ุงููููุฉ ุงููุณุชููุฉ:", hasInternet);
    } else {
        console.log("ูุง ููุฌุฏ ุงุชุตุงู ุจุงูุฅูุชุฑูุช. ุงููููุฉ ุงููุณุชููุฉ:", hasInternet);
        // ุงูุฏุงูุฉ ูู Kotlin ุณุชููู ุชููุงุฆููุง ุจุฅุธูุงุฑ ุฑุณุงูุฉ Toast ูููุณุชุฎุฏู
    }
    // โ ุฅุตูุงุญ: ูุฌุจ ุฃู ุชุนูุฏ ุงูุฏุงูุฉ ุจุงููููุฉ ุงููุณุชููุฉ ูู ุงูุฃูุฏุฑููุฏ ูุจุงุดุฑุฉ ูุชุชููู ููุง.
    return hasInternet;
} 
/////////////
  const now = Date.now();

  // ๐ฆ ุงุณุชุฎุฏุงู ุงููุชูุฌุฉ ุงููุฎุฒูุฉ ุฅุฐุง ูุงู ุขุฎุฑ ูุญุต ุญุฏูุซูุง
  if (now - lastConnectionCheck < CONNECTION_CHECK_INTERVAL) {
    console.log(`[ูุญุต ุงูุดุจูุฉ] ุงุณุชุฎุฏุงู ุงููุชูุฌุฉ ุงููุฎุจุฃุฉ: ${isConnectedCache}`);
    return isConnectedCache;
  }

  // ุณูุชู ุชุญุฏูุซ ููุช ุงููุญุต ูู ุงูููุงูุฉ ูููุง ุญุตู
  lastConnectionCheck = now;

  try {
    // 1๏ธโฃ ูุญุต navigator.onLine
    if (!navigator.onLine) {
      if (showAlert) {
        Swal.fire('ูุง ููุฌุฏ ุงุชุตุงู ุจุงูุฅูุชุฑูุช', 'ูุฑุฌู ุงูุชุญูู ูู ุงุชุตุงูู ุจุงูุดุจูุฉ.', 'error');
      }
      isConnectedCache = false;
      return false;
    }

    // 2๏ธโฃ ุงุฎุชุจุงุฑ ุงุชุตุงู ูุนูู ุนุจุฑ FETCH
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 3000); // 3 ุซูุงูู

    // โ ุฅุตูุงุญ: ุงุณุชุฎุฏุงู ูุถุน 'no-cors' ูุฒูุงุฏุฉ ุงูููุซูููุฉ ูุชุฌูุจ ูุดุงูู CORS.
    // ูุฐุง ุงููุถุน ูุง ูุนูุฏ status code ุญููููุ ููู ูุฌุงุญ ุงูุทูุจ ููุณู ูููู ูุชุฃููุฏ ุงูุงุชุตุงู.
    const response = await fetch("https://www.gstatic.com/generate_204", {
      method: "GET",
      mode: "no-cors", // ุงูุณูุงุญ ุจุงูุทูุจ ุฏูู ุงูุญุงุฌุฉ ูุงุณุชุฌุงุจุฉ CORS ูุงููุฉ
      signal: controller.signal,
    });

    clearTimeout(timeout);

    // 3๏ธโฃ ุฅุฐุง ูู ูุญุฏุซ ุฎุทุฃ ูู ุงูุทูุจ (ูู ูุฏุฎู ูู catch)ุ ููุฐุง ูุนูู ุฃู ุงูุงุชุตุงู ููุฌูุฏ.
    console.log("[ูุญุต ุงูุดุจูุฉ] ุชู ุชุฃููุฏ ุงูุงุชุตุงู ุจูุฌุงุญ.");
    isConnectedCache = true;
    return true;

  } catch (error) {
    // ุฅุฐุง ูุดู ุงูุทูุจ (ุจุณุจุจ ุงููุทุงุน ุงูุดุจูุฉ ุฃู ุงูุชูุงุก ุงููููุฉ)ุ ููุฐุง ูุนูู ุนุฏู ูุฌูุฏ ุงุชุตุงู.
    console.warn("[ูุญุต ุงูุดุจูุฉ] ูุดู ุงุฎุชุจุงุฑ ุงูุงุชุตุงู:", error.name === 'AbortError' ? 'ุงูุชูุช ุงููููุฉ' : error.message);
    // โ ุชุญุณูู: ุนุฑุถ ุงูุชูุจูู ููุท ุฅุฐุง ูุงู ูุทููุจูุง ููู ูุชู ุนุฑุถู ุจุงููุนู
    // (ุงูุฏุงูุฉ ุณุชุนุฑุถู ูุฑุฉ ูุงุญุฏุฉ ุนูุฏ ูุดู navigator.onLine)
    if (showAlert) {
        Swal.fire('ูุง ููุฌุฏ ุงุชุตุงู ุจุงูุฅูุชุฑูุช', 'ูุฑุฌู ุงูุชุญูู ูู ุงุชุตุงูู ุจุงูุดุจูุฉ.', 'error');
    }
    isConnectedCache = false;
    return false;
  }
}

/**
 * โ ุฌุฏูุฏ: ูุญูู ุงูุฃุฑูุงู ุงูููุฏูุฉ (ู-ูฉ) ุฅูู ุฃุฑูุงู ุฅูุฌููุฒูุฉ (0-9) ูู ุณูุณูุฉ ูุตูุฉ.
 * ูุฐู ุงูุฏุงูุฉ ูููุฏุฉ ููุนุงูุฌุฉ ูุฏุฎูุงุช ุงููุณุชุฎุฏู ุงูุชู ูุฏ ุชุญุชูู ุนูู ุฃุฑูุงู ุจุฃู ูู ุงูุตูุบุชูู.
 * @param {string} str - ุงูุณูุณูุฉ ุงููุตูุฉ ุงูุชู ูุฏ ุชุญุชูู ุนูู ุฃุฑูุงู.
 * @returns {string} - ุงูุณูุณูุฉ ุงููุตูุฉ ุจุนุฏ ุชุญููู ุงูุฃุฑูุงู ุฅูู ุงูุตูุบุฉ ุงูุฅูุฌููุฒูุฉ.
 */
function normalizeDigits(str) {
  if (!str) return '';
  const easternArabicNumerals = /[\u0660-\u0669]/g; // ูุทุงู ุงูุฃุฑูุงู ุงูุนุฑุจูุฉ ุงูุดุฑููุฉ (ุงูููุฏูุฉ)
  return str.replace(easternArabicNumerals, d => d.charCodeAt(0) - 0x0660);
}

/**
 * โ ุฌุฏูุฏ: ูููู ุจุชูููุญ ูุชูุญูุฏ ุงููุต ุงูุนุฑุจู.
 * ูุฒูู ุนูุงูุงุช ุงูุชุดููู ูููุญุฏ ุฃุดูุงู ุงูุญุฑูู (ุงูููุฒุงุช ูุงูุชุงุก ุงููุฑุจูุทุฉ).
 * ูููุฏ ุฌุฏูุง ูุนูููุงุช ุงูุจุญุซ ูุงูููุงุฑูุฉ ูุถูุงู ุชุทุงุจู ุงููุตูุต ุจุบุถ ุงููุธุฑ ุนู ุงูุชุดููู.
 * @param {string} text - ุงููุต ุงูุนุฑุจู ุงููุฑุงุฏ ุชูููุญู.
 * @returns {string} - ุงููุต ุจุนุฏ ุฅุฒุงูุฉ ุงูุชุดููู ูุชูุญูุฏ ุงูุญุฑูู.
 */
function normalizeArabicText(text) {
  if (!text) return "";

  // ุฅุฒุงูุฉ ุงูุชุดููู
  text = text.replace(/[\u064B-\u0652]/g, "");

  // ุชูุญูุฏ ุงูููุฒุงุช (ุฃุ ุฅุ ุข) ุฅูู ุง
  text = text.replace(/[ุขุฃุฅ]/g, "ุง");

  // ุชุญููู ุงูุชุงุก ุงููุฑุจูุทุฉ (ุฉ) ุฅูู ู
  text = text.replace(/ุฉ/g, "ู");

  // ุชูุญูุฏ ุญุฑู ุงููุงุก (ู / ู) ุฅูู ู
  text = text.replace(/[ู]/g, "ู");

  // ุฅุฒุงูุฉ ุงููุฏ (ููู)
  text = text.replace(/ู+/g, "");

  // ุฅุฒุงูุฉ ุงููุณุงูุงุช ุงูููุฑุฑุฉ
  text = text.replace(/\s+/g, " ").trim();

  return text;
}

/**
 * โ ุฌุฏูุฏ: ููุชูู ุฅูู ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู ูููุชุญ ูุงูุฐุฉ ุณุฌู ุงูุฅุดุนุงุฑุงุช ุนูุฏ ุงูุชุญููู.
 * ูุณุชุฎุฏู sessionStorage ูุชูุฑูุฑ ุทูุจ ูุชุญ ุงููุงูุฐุฉ ุฅูู ุงูุตูุญุฉ ุงูุชุงููุฉ.
 */
function redirectToLoginAndShowNotifications() {
  const loggedInUserJSON = localStorage.getItem("loggedInUser");

  if (loggedInUserJSON) {
    const user = JSON.parse(loggedInUserJSON);

    // ุงูุชุฃูุฏ ูู ุฃู ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎููู ููุคูู ูุฑุคูุฉ ุงูุฅุดุนุงุฑุงุช ูุจู ุงูุชูุฌูู
    // isUserEligibleForNotifications() ูุนุฑูุฉ ูู auth.js
    if (typeof isUserEligibleForNotifications === 'function' && isUserEligibleForNotifications(user)) {
      sessionStorage.setItem('openNotificationsOnLoad', 'true');
      window.location.href = 'login.html';
    }
  }
}
