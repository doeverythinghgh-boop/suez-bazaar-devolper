# ๐ฆ ุชูุซูู ูุธุงู ุณูุฉ ุงููุดุชุฑูุงุช (CardPackage)

ูุฐุง ุงููุณุชูุฏ ููุฏู ุดุฑุญุงู ุชูููุงู ุดุงููุงู ูููุตูุงู ูุทุฑููุฉ ุนูู ูุญุฏุฉ `CardPackage` ุงููุณุคููุฉ ุนู ุฅุฏุงุฑุฉ ุณูุฉ ุงููุดุชุฑูุงุชุ ุญุณุงุจ ุชูุงููู ุงูุชูุตูู ุงูุฐููุ ูุฅุชูุงู ุนูููุฉ ุงูุดุฑุงุก.

---

## ๐ ูููููุฉ ุงููููุงุช ูุงููุฌูุฏุงุช

ููุน ุงูููุฏ ุงููุตุฏุฑู ูู `pages/cardPackage/` ูุชู ุชูุณูู ุงูููุทู ุฅูู ูุญุฏุงุช ุตุบูุฑุฉ ูุชุฎุตุตุฉ (Modular Architecture) ูุณูููุฉ ุงูุตูุงูุฉ.

### 1. ุงููุฌูุฏ `js/` (ุงููุญุฏุงุช ุงูุจุฑูุฌูุฉ)

| ุงูููู | ุงููุธููุฉ ูุงููุณุคูููุฉ |
| :--- | :--- |
| **`cartPackage-init.js`** | **ููุทุฉ ุงูุจุฏุงูุฉ:** ูููู ุจุชููุฆุฉ ุงูุตูุญุฉุ ุชุญููู ุงูููุฏุฑุ ูุงุณุชุฏุนุงุก ุฏุงูุฉ ุชุญููู ุงูุณูุฉ ุงูุฑุฆูุณูุฉ. |
| **`cartPackage-ui.js`** | **ุงูุนุฑุถ:** ูุณุคูู ุนู ุงูุฑุณู (Rendering) ูุนูุงุตุฑ ุงูุณูุฉุ ุชุญุฏูุซ ุงูููุฎุต (Summary)ุ ูุนุฑุถ ูุงูุฐุฉ ุชูุงุตูู ุงูุชูุตูู. |
| **`cartPackage-events.js`** | **ุงูุฃุญุฏุงุซ:** ูุฑุจุท ุงูุฃุฒุฑุงุฑ (ุญุฐูุ ุฒูุงุฏุฉุ ููุตุงูุ ุฅุชูุงู ุงูุดุฑุงุก) ุจุงููุธุงุฆู ุงูุจุฑูุฌูุฉ ุงูููุงุณุจุฉ. |
| **`cartPackage-checkout.js`** | **ุงูุดุฑุงุก:** ูุฏูุฑ ุนูููุฉ ุฅุชูุงู ุงูุทูุจุ ุงูุชุญูู ูู ุงูุฌูุณุฉุ ุจูุงุก ูุงุฆู ุงูุทูุจุ ูุฅุฑุณุงูู ููุฎุงุฏู. |
| **`cartPackage-api.js`** | **ุงูุงุชุตุงู:** ูุงุฌูุฉ (Adapter) ุจุณูุทุฉ ูุฅุฑุณุงู ุทูุจุงุช HTTP (ูุซู `createOrder`) ุฅูู ุงูุจุงู ุฅูุฏ. |
| **`cartPackage-notes.js`** | **ุงูููุงุญุธุงุช:** ูุฏูุฑ ููุทู ุฅุถุงูุฉ ูุชุนุฏูู ูุญูุธ ุงูููุงุญุธุงุช ุงูุฎุงุตุฉ ุจูู ููุชุฌ ูู ุงูุณูุฉ. |
| **`deliveryService.js`** | **ูุฏูุฑ ุงูุชูุตูู:** ุงููุงูุณุชุฑู ุงูุฐู ูุฑุจุท ุจูู ุญุณุงุจ ุงููุณุงุฑ ูุญุณุงุจ ุงูุชูููุฉ ูุฌูุจ ุงูุชูููุฉ ุงูููุงุฆูุฉ. |
| **`smartDeliveryRoute.js`** | **ุงููุณุงุฑ ุงูุฐูู:** ุฎูุงุฑุฒููุฉ ุฐููุฉ ุชุญุฏุฏ ุฃูุตุฑ ูุณุงุฑ ููุฑ ุจุฌููุน ุงูุจุงุฆุนูู (TSP Algorithm). |
| **`deliveryCostCalculator.js`** | **ุญุงุณุจุฉ ุงูุชูููุฉ:** ุฏุงูุฉ ูููุฉ (Pure Function) ุชุญุณุจ ุงููููุฉ ุงููุงููุฉ ุจูุงุกู ุนูู ุงููุณุงูุฉ ูุงูุนูุงูู ุงูุฃุฎุฑู. |
| **`deliveryConfigLoader.js`** | **ุงูุฅุนุฏุงุฏุงุช:** ุชุญููู ุฅุนุฏุงุฏุงุช ุงูุชูุตูู ูู ููู JSON ูุชุฎุฒูููุง ูุคูุชุงู (Caching). |

### 2. ุงููุฌูุฏ `data/` (ุงูุจูุงูุงุช)

| ุงูููู | ุงููุธููุฉ |
| :--- | :--- |
| **`delivery_config.json`** | ููู ุชูููู ูุฑูุฒู ูุญุชูู ุนูู ุฌููุน ุซูุงุจุช ูุนูุงูู ุญุณุงุจ ุงูุชูููุฉ (ูุซู ุณุนุฑ ุงูููููุ ุนูุงูู ุงูุทูุณุ ุงูุฎุตููุงุช). |

---

## ๐๏ธ ุชุฏูู ุงูุจูุงูุงุช ูุงูุนูููุงุช (Workflows)

### 1. ุชููุฆุฉ ุงูุตูุญุฉ (Initialization)
- ูุจุฏุฃ ุงูุนูู ูู `cartPackage-init.js`.
- ูุชู ุงุณุชุฏุนุงุก `cartPage_loadCart` ูู `cartPackage-ui.js`.
- ูุชู ุฅุนุฏุงุฏ ูุณุชูุนู ุงูุฃุญุฏุงุซ ุนุจุฑ `cartPage_setupEventListeners` ูู `cartPackage-events.js`.

### 2. ุชุญููู ูุนุฑุถ ุงูุณูุฉ (Rendering)
- ุฏุงูุฉ `cartPage_loadCart` ุชูุฑุฃ ุงูุณูุฉ ูู `localStorage`.
- ุฅุฐุง ูุงูุช ุงูุณูุฉ ูุงุฑุบุฉ: ุชุธูุฑ ุดุงุดุฉ "ุงูุณูุฉ ูุงุฑุบุฉ".
- ุฅุฐุง ูุงูุช ููุชูุฆุฉ:
  1. ูุชู ุชูููุฏ HTML ููู ููุชุฌ.
  2. ูุชู ุญุณุงุจ ูุนุฑุถ ุงููุฌููุน ุงูุฃููู (Subtotal).
  3. **ุงูุฃูู:** ูุชู ุงุณุชุฏุนุงุก ุญุณุงุจ ุชูููุฉ ุงูุชูุตูู ุงูุฐููุฉ ูุชุญุฏูุซ ุงูุณุนุฑ ุงูููุงุฆู (ุงูุธุฑ ุงููุณู ุงูุชุงูู).

### 3. ูุธุงู ุงูุชูุตูู ุงูุฐูู (Smart Delivery System) ๐ง

ูุฐุง ูู ุงูุฌุฒุก ุงูุฃูุซุฑ ุชุนููุฏุงู ูุฐูุงุกู ูู ุงููุธุงู. ุงูุนูููุฉ ุชุชู ูุงูุชุงูู:

#### ุฃ. ุชุญุฏูุฏ ุงูููุงูุน (`deliveryService.js`)
- **ุงูููุชุจ (Start Point):** ูุชู ุฌูุจู ูู ุงูุฅุนุฏุงุฏุงุช.
- **ุงูุนููู (End Point):** ูุชู ุฌูุจู ูู ุฌูุณุฉ ุงููุณุชุฎุฏู (`userSession`) ุฃู ุงุณุชุฎุฏุงู ูููุน ุงูุชุฑุงุถู.
- **ุงูุจุงุฆุนูู (Waypoints):** ูุชู ุงุณุชุฎุฑุงุฌ ุฅุญุฏุงุซูุงุช ูุฑูุฏุฉ ููู ุจุงุฆุน ููุฌูุฏ ูู ุงูุณูุฉ.

#### ุจ. ุญุณุงุจ ุงููุณุงุฑ ุงูุฃูุซู (`smartDeliveryRoute.js`)
- ุชุณุชุฎุฏู ุฎูุงุฑุฒููุฉ **Brute-force Permutation** ูุชุฌุฑุจุฉ ูู ุงูุชุฑุชูุจุงุช ุงูููููุฉ ูุฒูุงุฑุฉ ุงูุจุงุฆุนูู.
- ุงููุณุงุฑ ูููู ุฏุงุฆูุงู: **ุงูููุชุจ โฌ๏ธ ุงูุจุงุฆุนูู (ุจุฃูุตุฑ ุชุฑุชูุจ) โฌ๏ธ ุงูุนููู**.
- ุงููุชูุฌุฉ ูู "ุงููุณุงูุฉ ุงููููุฉ" ุงููุญุณูุจุฉ ุจุฏูุฉ ุจูุงุกู ุนูู ุชุฑุชูุจ ุงูุฒูุงุฑุฉ ุงูุฃูุซู.

#### ุฌ. ุญุณุงุจ ุงูุชูููุฉ ุงููุงููุฉ (`deliveryCostCalculator.js`)
ุชุฃุฎุฐ ุงููุณุงูุฉ ุงููุญุณูุจุฉ ูุชุทุจู ุนูููุง ูุนุงุฏูุฉ ูุนูุฏุฉ ุจูุงุกู ุนูู `delivery_config.json`:

$$
\text{Total Cost} = \text{Base Fee} + (\text{Distance} \times \text{Price/KM}) + \text{Additions} - \text{Discounts}
$$

**ุงูุนูุงูู ุงููุคุซุฑุฉ (Factors):**
1. **ุญูููุฉ ุซูููุฉ:** ุฅุฐุง ูุงู ุงูููุชุฌ ูุญุชุงุฌ ุดุงุญูุฉุ ูุชู ุชุทุจูู `special_vehicle_factor`.
2. **ุงูุทูุณ:** ุฒูุงุฏุฉ ุงูุชูููุฉ ูู ุงููุทุฑ (`weather_factors`).
3. **ุงูููุทูุฉ:** ุชูููุฉ ุฅุถุงููุฉ ููููุงุทู ุงูุจุนูุฏุฉ (`location_factors`).
4. **ุชูููู ุงูุณุงุฆู:** ุฎุตู ุฅุฐุง ูุงู ุงูุณุงุฆู ููุชุงุฒุงู (`driver_rating_config`).
5. **ูููุฉ ุงูุทูุจ:** ุฑุณูู ุฅุถุงููุฉ ููุทูุจุงุช ุจุงูุธุฉ ุงูุซูู (`high_order_fee`).
6. **ุฎุตู ุชุดุฌูุนู:** ููุทูุจุงุช ุงูุตุบูุฑุฉ (`discount_value`).
 
 #### ุฏ. ุงูุจุงุฆุนูู ุงูุฐูู ูููููู ุจุงูุชูุตูู ุจุฃููุณูู (Self-Delivery) ๐ค
 ูุชููุฒ ุงููุธุงู ุจุงููุฑููุฉ ูู ุงูุชุนุงูู ูุน ุงูุจุงุฆุนูู ุงูุฐูู ููุชูููู ุฃุณุทูู ุชูุตูู ุฎุงุต ุจูู ุฃู ููุถููู ุงูุชูุตูู ุจุฃููุณูู (`isDelevred: 1`):
 - **ุงุณุชุซูุงุก ุงููุณุงุฑ:** ูุชู ุงุณุชุจุนุงุฏ ูุคูุงุก ุงูุจุงุฆุนูู ุชูุงูุงู ูู ุญุณุงุจุงุช "ุงููุณุงุฑ ุงูุฐูู" ูุญูุธ ููุช ูุฌูุฏ ููุฏูุจ ุงูุชุทุจูู.
 - **ุฅุนูุงุก ุงูุฑุณูู:** ุฅุฐุง ูุงู **ุฌููุน** ุงูุจุงุฆุนูู ูู ุงูุณูุฉ ููุตููู ุจุฃููุณููุ ูุชู ุชุตููุฑ ุฑุณูู ุงูุชูุตูู ุงูุซุงุจุชุฉ (`FIXED_DELIVERY_FEE`) ูุฅุฎูุงุก ุตู ุงูุชูุตูู ูู ููุฎุต ุงูุทูุจ ูุชุจุณูุท ุงูุชุฌุฑุจุฉ ูููุณุชุฎุฏู.
 - **ุงูุชูุตูู ุงููุฌูู:** ูู ุญุงูุฉ ูุฌูุฏ ุจุงุฆุนูู ูุชุทูุนูู ูุขุฎุฑูู ูุญุชุงุฌูู ููููุฏูุจุ ูุชู ุญุณุงุจ ุงููุณุงุฑ ูุงูุฑุณูู ููุท ููุจุงุฆุนูู ุงูุฐูู ูุญุชุงุฌูู ููููุฏูุจ.

#### ูู. ุงูุญุฏ ุงูุฃุฏูู ููุทูุจุงุช ูุงูุชุญูู ูุจู ุงูุดุฑุงุก ๐
ูุชู ุชุฎุฒูู ุชูุถููุงุช ุงูุจุงุฆุน ูู ุจูุงูุงุช ุงููุณุชุฎุฏู ุงูุฎุงุตุฉ ุจู:
- **`isDelevred`**: ุชูุฑุฑ ูุง ุฅุฐุง ูุงู ุงูุจุงุฆุน ูุดููู ูุธุงู ุงูุชูุตูู ุงูุฐูู ุฃู ูุง (ูููุฉ 1 ุชุนูู ุชูุตูู ุฐุงุชู).
- **`limitPackage`**: ุชุญุฏุฏ ุงูุญุฏ ุงูุฃุฏูู ููููุฉ ุงููุดุชุฑูุงุช ูู ูุฐุง ุงูุจุงุฆุน ูุฅุชูุงู ุงูุทูุจ.
- **ุชุญุฏูุซ ุงูุจูุงูุงุช**: ูููู ูููุณุชุฎุฏู ุถุจุท ูุฐู ุงูุฅุนุฏุงุฏุงุช ุนูุฏ "ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ" ุฃู ูู ุฎูุงู "ุชุนุฏูู ุงูููู ุงูุดุฎุตู" ุนุจุฑ ูุงุฌูุฉ ูุฎุตุตุฉ.
- **ุงูุชุฏููู**: ุนูุฏ ูุญุงููุฉ ุฅุชูุงู ุงูุดุฑุงุกุ ูููู ุงููุธุงู ุจูุญุต ุณูุฉ ุงููุดุชุฑูุงุช ูููุงุฑูุฉ ุฅุฌูุงูู ูุดุชุฑูุงุช ูู ุจุงุฆุน ุจู `limitPackage` ุงูุฎุงุต ุจูุ ูุฅุฐุง ูู ูุณุชููู ุงูุดุฑุท ุชุธูุฑ ุฑุณุงูุฉ ุชูุจูู ุชููุน ุงูุดุฑุงุก ุญุชู ุงููุตูู ููุญุฏ ุงูุฃุฏูู.

### 4. ุฅุชูุงู ุงูุดุฑุงุก (Checkout Flow)
- ุนูุฏ ุงูุถุบุท ุนูู "ุฅุชูุงู ุงูุดุฑุงุก" (`cartPackage-checkout.js`):
  1. ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู.
  2. ุฅุนุงุฏุฉ ุญุณุงุจ ุงููุฌููุน ุงูููู ูุถูุงู ุงูุฏูุฉ.
  3. ุฅูุดุงุก `order_key` ูุฑูุฏ.
  4. ุชุฌููุฒ ูุงุฆู ุงูุทูุจ (`orderData`).
  5. ุนุฑุถ ูุงูุฐุฉ ุชุฃููุฏ (Swal) ูุน ุงูุณุนุฑ ุงูููุงุฆู.
  6. ุนูุฏ ุงูููุงููุฉุ ูุชู ุงูุฅุฑุณุงู ุนุจุฑ `createOrder` ุฅูู `/api/orders`.
  7. ุชูุนูู ุงูุฅุดุนุงุฑุงุช (`handlePurchaseNotifications`).
  8. ุชูุฑูุบ ุงูุณูุฉ ูุนุฑุถ ุฑุณุงูุฉ ูุฌุงุญ.

---

## โ๏ธ ุงูุชุนุฏูู ูุงูุชุฎุตูุต (Configuration)

ูุชุบููุฑ ุฃุณุนุงุฑ ุงูุชูุตูู ุฃู ุงูุนูุงููุ ูุง ุชุญุชุงุฌ ูุชุนุฏูู ุงูููุฏ. ููุท ุนุฏู ููู `pages/cardPackage/data/delivery_config.json`:

```json
{
    "defaults": {
        "base_fee": 15,          // ุงูุฑุณูู ุงูุฃุณุงุณูุฉ (ูุชุญ ุงูุนุฏุงุฏ)
        "price_per_km": 5,       // ุณุนุฑ ุงููููููุชุฑ
        "high_order_fee": 20,    // ุฑุณูู ุงูุทูุจ ุงูุบุงูู
        "currency_symbol": "ุฌ.ู" // ุงูุนููุฉ
    },
    "weather_factors": { ... },  // ุนูุงูู ุงูุทูุณ
    "vehicle_factors": { ... }   // ุนูุงูู ุงููุฑูุจุฉ
}
```

---

## ๐ก ููุงุญุธุงุช ูุงูุฉ ูููุทูุฑูู

1. **ุงูุงุนุชูุงุฏูุฉ:** `deliveryService.js` ูุนุชูุฏ ุจุดูู ููู ุนูู ุชุญููู ุงูุฅุนุฏุงุฏุงุช ุฃููุงู.
2. **ุงูุฃุฏุงุก:** ุฎูุงุฑุฒููุฉ ุงููุณุงุฑ (`smartDeliveryRoute.js`) ููุชุงุฒุฉ ูุนุฏุฏ ุจุงุฆุนูู ูููู (ุฃูู ูู 8). ุฅุฐุง ุฒุงุฏ ุงูุนุฏุฏ ุนู ุฐููุ ูุฏ ุชุญุชุงุฌ ุฅูู ุชุญุณูู ุงูุฎูุงุฑุฒููุฉ (Heuristic Approach).
3. **ุงูุชูุซูู:** ุชู ุชูุซูู ุฌููุน ุงูุฏูุงู ุจู JSDoc ุจุงููุบุฉ ุงูุฅูุฌููุฒูุฉ ุฏุงุฎู ุงูููุฏ ูุณูููุฉ ุงูุชุชุจุน.
 4. **ุงูุงุณุชุซูุงุกุงุช:** ูุชู ูุญุต ุญูู `isDelevred` ุฃู `sellerIsDelevred` ูู ูู ููุชุฌ ุจุงูุณูุฉ ูุชุญุฏูุฏ ุณูุงุณุฉ ุงูุชูุตูู ุงููุทุจูุฉ.

ุชู ุฅุนุฏุงุฏ ูุฐุง ุงูููู ุจูุงุกู ุนูู ุชุญููู ุงูููุฏ ูู ุงูุฅุตุฏุงุฑ ุงูุญุงูู.
