# نظام بناء المشروع والتشفير (Build System & Obfuscation)

يشرح هذا الملف كيفية عمل نظام البناء (Build System) الخاص بالمشروع، وكيفية توليد مجلد `dist` الذي يمثل النسخة النهائية المحمية والجاهزة للنشر.

## 1. نظرة عامة
الهدف من نظام البناء هو تشفير كافة ملفات JavaScript الخاصة بالمشروع بشكل مستقل وحماية الكود المصدري من الهندسة العكسية. تعتمد هذه العملية على سكربت `build.js` الذي يعمل ببيئة Node.js.

### المخرجات الرئيسية:
- **مجلد `dist`**: يحتوي على نسخة كاملة من المشروع بنفس هيكل المجلدات الأصلي.
- **تشفير فردي للملفات**: كل ملف JavaScript يتم تشفيره بشكل مستقل وحفظه في مساره المقابل داخل `dist`.
- **ملفات HTML أصلية**: يتم نسخ ملفات HTML كما هي، مما يحافظ على ترتيب تحميل السكربتات الأصلي ويضمن استقرار التطبيق.

---

## 2. بيئة التطوير مقابل الإنتاج (Development vs Production)

هناك فرق جوهري بين المجلد الرئيسي ومجلد `dist` في دورة حياة المشروع:

### أ. التطوير المحلي (Local Development)
- **الملف الرئيسي**: `index.html` الموجود في جذر المشروع.
- **الاستخدام**: بيئة العمل اليومية للمطور.
- **المحتوى**: يستخدم ملفات الكود المصدري المباشرة (غير مشفرة)، مما يسهل عملية التعديل واكتشاف الأخطاء (Debugging).

### ب. الإنتاج والنشر (Production & Deployment)
- **الملف الرئيسي**: `dist/index.html`.
- **الاستخدام**: النسخة النهائية التي يتم نشرها للمستخدمين (مثلاً عبر Cloudflare Pages).
- **المحتوى**: ملفات معالجة ومشفرة بالكامل لضمان أفضل أداء وأعلى درجات الأمان.

### ج. تطبيق الأندرويد (Android WebView)
- **الاستخدام**: يعمل التطبيق كـ "موقع محلي" داخل الهاتف.
- **المحتوى**: يعتمد التطبيق حصرياً على ملفات مجلد `dist`، حيث يتم عرضها داخل `WebView`. هذا يضمن أن التطبيق يعمل دائماً بالنسخة المحمية والمحسنة، تماماً مثل نسخة الإنتاج على الويب.

---

## 3. كيفية عمل سكربت `build.js`
يقوم السكربت بتنفيذ الخطوات التالية بالترتيب:

### أ. تنظيف البيئة (Cleanup)
يتم حذف مجلد `dist` القديم إن وجد لضمان أن النسخة الناتجة حديثة تماماً ولا تحتوي على ملفات قديمة.

### ب. نسخ الأصول والمجلدات (Assets Copying)
يتم نسخ المجلدات الحيوية بما تحتويه من ملفات CSS وصور ومكتبات خارجية إلى مجلد `dist`:
- `assets/`: المكتبات الخارجية والخطوط.
- `style/`: ملفات CSS الأساسية.
- `images/`: الصور والرموز.
- `notification/`: ملفات نظام الإشعارات.
- `shared/`: ملفات البيانات المشتركة.
- `location/`: ملفات الخرائط والمواقع.
- `js/`: ملفات الجافاسكريبت الأساسية.
- `pages/`: كافة الصفحات والمكونات الفرعية.
- `steper/`: نظام تتبع الطلبات.

### ج. التشفير الفردي (Individual Obfuscation)
يتم البحث عن كافة ملفات `.js` (التي ليست مكتبات خارجية أو مصغرة بالفعل) وتشفيرها بشكل منفصل:
- يتم استخدام مكتبة `javascript-obfuscator` مع تعطيل خيار `renameGlobals`.
- **السبب**: تعطيل `renameGlobals` يضمن أن الملفات المختلفة تظل قادرة على التواصل مع بعضها واستدعاء الدوال العالمية لبعضها البعض رغم تشفير محتوى الدوال وأسماء المتغيرات الداخلية.

### د. حماية نظام الـ Service Worker
يتم تشفير ملفات الجذر الخاصة بالمتصفح مثل `sw.js` و `firebase-messaging-sw.js` لضمان حماية منطق التخزين المؤقت والإشعارات.

### هـ. معالجة ملفات HTML
يتم نسخ كافة ملفات HTML إلى مجلد `dist` مع الحفاظ على مسارات السكربتات الأصلية. هذا يضمن تحميل المكتبات (مثل Leaflet و SweetAlert2) بترتيبها الصحيح وتجنب أخطاء التعريف (ReferenceError).

---

## 4. كيفية التشغيل
لإنشاء نسخة جديدة مشفرة، نفذ الأمر التالي في التيرمينال:

```bash
node build.js
```

بمجرد الانتهاء، ستجد نسخة كاملة وجاهزة للنشر داخل مجلد `dist`.

---

## 5. ملاحظات تقنية هامة

> [!TIP]
> **استقرار التطبيق**: بفضل التشفير الفردي، تمت معالجة مشاكل ترتيب التحميل التي كانت تظهر في نظام التجميع السابق (Bundle)، وأصبح التطبيق يعمل بنفس سلالة نسخة التطوير.

> [!WARNING]
> **إصدارات الملفات**: عند رفع نسخة جديدة، قد يحتاج المستخدمون لعمل `Hard Reload` أو مسح الـ Cache لضمان تحميل الملفات الجديدة.

---

## 6. الملفات المشمولة في البناء
- كافة ملفات `.js` المبرمجة داخل المشروع.
- كافة ملفات `.html`.
- كافة الأصول (CSS, Images, Fonts, Icons).
- ملفات الإعدادات والـ Manifest.
