# نظام بناء المشروع والتشفير (Build System & Obfuscation)

يشرح هذا الملف كيفية عمل نظام البناء (Build System) الخاص بالمشروع، وكيفية توليد مجلد `dist` الذي يمثل النسخة النهائية المحمية والجاهزة للنشر.

## 1. نظرة عامة
الهدف من نظام البناء هو تشفير كافة ملفات JavaScript الخاصة بالمشروع بشكل مستقل وحماية الكود المصدري من الهندسة العكسية. تعتمد هذه العملية على سكربت `build.js` الذي يعمل ببيئة Node.js.

### المخرجات الرئيسية:
- **مجلد `dist`**: يحتوي على نسخة كاملة من المشروع بنفس هيكل المجلدات الأصلي.
- **تشفير فردي للملفات**: كل ملف JavaScript يتم تشفيره بشكل مستقل وحفظه في مساره المقابل داخل `dist`.
- **ملفات HTML أصلية**: يتم نسخ ملفات HTML كما هي، مما يحافظ على ترتيب تحميل السكربتات الأصلي ويضمن استقرار التطبيق.

---

## 2. بيئة التطوير مقابل الإنتاج (Development vs Production)

هناك فرق جوهري بين المجلد الرئيسي ومجلد `dist` في دورة حياة المشروع:

### أ. التطوير المحلي (Local Development)
- **الملف الرئيسي**: `index.html` الموجود في جذر المشروع.
- **الاستخدام**: بيئة العمل اليومية للمطور.
- **المحتوى**: يستخدم ملفات الكود المصدري المباشرة (غير مشفرة)، مما يسهل عملية التعديل واكتشاف الأخطاء (Debugging).

### ب. الإنتاج والنشر (Production & Deployment)
- **الملف الرئيسي**: `dist/index.html`.
- **الاستخدام**: النسخة النهائية التي يتم نشرها للمستخدمين (مثلاً عبر Cloudflare Pages).
- **المحتوى**: ملفات معالجة ومشفرة بالكامل لضمان أفضل أداء وأعلى درجات الأمان.

### ج. تطبيق الأندرويد (Android WebView)
- **الاستخدام**: يعمل التطبيق كـ "موقع محلي" داخل الهاتف.
- **المحتوى**: يعتمد التطبيق حصرياً على ملفات مجلد `dist`، حيث يتم عرضها داخل `WebView`. هذا يضمن أن التطبيق يعمل دائماً بالنسخة المحمية والمحسنة، تماماً مثل نسخة الإنتاج على الويب.

---

## 3. إدارة المستودعات (Repositories)

لضمان عدم تداخل الملفات وتسهيل عملية النشر، تم فصل المشروع إلى مستودعين:

1. **المستودع الرئيسي (Main Repository)**:
   - **الرابط**: `https://github.com/doeverythinghgh-boop/bazaar.git`
   - **المحتوى**: يحتوي على الكود المصدري الأصلي (Source Code)، بما في ذلك ملفات التكوين والتوثيق والموارد غير المشفرة.
   - **الهدف**: التطوير، التعديل، وإدارة الإصدارات الأساسية.

2. **مستودع التوزيع (Distribution Repository)**:
   - **الرابط**: `https://github.com/doeverythinghgh-boop/_bazaar.git`
   - **المسار المحلي**: `dist/`
   - **المحتوى**: يحتوي فقط على النسخة النهائية المشفرة (Production Build).
   - **الهدف**: النشر المباشر (Deployment) عبر Cloudflare Pages أو لاستخدامه في تطبيق Android.

> [!NOTE]
> يتم تجاهل مجلد `dist` في المستودع الرئيسي (عبر `.gitignore`) لمنع ازدواجية الملفات أو رفع الملفات المشفرة إلى مستودع الكود المصدري.

---

## 4. كيفية عمل سكربت `build.js`
يقوم السكربت بتنفيذ الخطوات التالية بالترتيب:

### أ. تنظيف البيئة (Cleanup)
يتم حذف مجلد `dist` القديم إن وجد لضمان أن النسخة الناتجة حديثة تماماً ولا تحتوي على ملفات قديمة.

### ب. نسخ الأصول والمجلدات (Assets Copying)
يتم نسخ المجلدات الحيوية بما تحتويه من ملفات CSS وصور ومكتبات خارجية إلى مجلد `dist` باستثناء المجلدات المستبعدة (مثل `function` و `api` و `note`):
- `assets/`: المكتبات الخارجية والخطوط.
- `style/`: ملفات CSS الأساسية.
- `images/`: الصور والرموز.
- `notification/`: ملفات نظام الإشعارات.
- `shared/`: ملفات البيانات المشتركة.
- `location/`: ملفات الخرائط والمواقع.
- `js/`: ملفات الجافاسكريبت الأساسية.
- `pages/`: كافة الصفحات والمكونات الفرعية.
- `steper/`: نظام تتبع الطلبات.

### ج. التشفير الفردي وتحسين الحجم (Individual Obfuscation & Size Optimization)
يتم البحث عن كافة ملفات `.js` وتشفيرها بشكل منفصل مع مراعاة التوازن بين الحماية وحجم الملف:
- يتم استخدام `javascript-obfuscator` مع تعطيل `renameGlobals` للحفاظ على التواصل بين الملفات.
- **تحسين الحجم**: تم تعطيل `deadCodeInjection` و `unicodeEscapeSequence` وتقليل عتبات (Thresholds) التشفير جزئياً لتقليل حجم الملفات النهائية وتجنب تضخم مستودع الـ `dist`.

### د. حماية نظام الـ Service Worker
يتم تشفير ملفات الجذر الخاصة بالمتصفح مثل `sw.js` و `firebase-messaging-sw.js` لضمان حماية منطق التخزين المؤقت والإشعارات.

### هـ. معالجة وتصغير ملفات HTML و CSS
يتم معالجة ملفات التنسيق والهيكل لتقليل الحجم وتحسين الأمان:
- **ملفات CSS**: يتم استخدام مكتبة `clean-css` لحذف المسافات والتعليقات وتصغير الكود بالكامل، مما يجعل قراءته صعبة ويقلل وقت تحميل الصفحة.
- **ملفات HTML**: يتم استخدام `html-minifier-terser` لحذف التعليقات، تصغير المسافات البيضاء، وتصغير الأكواد المدمجة (Internal Styles)، مع الحفاظ على سلامة بنية الصفحة والروابط بين الملفات.

### و. توليد فهرس الملفات والتحقق من السلامة (File Manifest & SHA-256)
هذه خطوة حيوية لضمان سلامة النسخة النهائية:
1. يتم مسح كافة ملفات مجلد `dist` (بما فيها الصور والخطوط وCSS).
2. يتم حساب بصمة **SHA-256** للمحتوى **الأصلي** (قبل التشفير) لكل ملف.
3. يتم توليد روابط تحميل مباشرة من GitHub (Raw URLs) للملفات المشفرة.
4. يتم تحديث ملف `dist/version.json` بهذا الفهرس الشامل.

### ز. النشر التلقائي (Auto Deployment)
بعد نجاح البناء وتحديث الفهرس، يقوم السكربت تلقائياً بعمل `Push` للملفات المشفرة إلى مستودع `_bazaar` لضمان مزامنة نسخة الإنتاج فوراً.

---

## 5. نظام التحقق من سلامة الملفات (File Integrity System)

يعد ملف `dist/version.json` هو العقل المدبر لعملية التحديث والتحقق، ويحتوي على:
- **`version`**: رقم الإصدار الحالي.
- **`lastUpdated`**: توقيت آخر بناء للنسخة.
- **`files`**: مصفوفة تحتوي على كل ملف في المشروع:
    - `path`: رابط GitHub لتحميل النسخة المشفرة.
    - `hash`: بصمة SHA-256 للملف الأصلي (للمصادقة).
    - `size`: حجم الملف النهائي بالبايت في مجلد `dist` (بعد التشفير والتصغير).

> [!IMPORTANT]
> **لماذا بصمة الملف الأصلي؟**
> لأن التشفير ينتج كوداً متغيراً في كل مرة، فإن الاعتماد على بصمة الملف الأصلي يضمن أن الملف المشفر -مهما اختلف شكله- قد نتج عن مصدر كود نظيف وموثوق تم التحقق منه مسبقاً. كما أن وجود **الحجم النهائي** (Size) يساعد في التحقق من اكتمال عملية التحميل.

---

## 6. كيفية التشغيل
لإنشاء نسخة جديدة مشفرة، نفذ الأمر التالي في التيرمينال:

```bash
node build.js
```

---

## 7. ملاحظات تقنية هامة

> [!TIP]
> **استقرار التطبيق**: بفضل التشفير الفردي، أصبح التطبيق يعمل بنفس سلالة نسخة التطوير وتجنب مشاكل الـ Bundle.

> [!WARNING]
> **إدارة المساحة**: تم تحسين إعدادات التشفير لتقليل تضخم مستودع الـ `dist` الناتج عن التغييرات الجذرية في الكود المشفر.

---

## 8. الملفات المشمولة في البناء
- كافة ملفات `.js` و `.html` و الأصول (CSS, Images, Fonts).
- **الفهرس الرقمي**: `dist/version.json`.
- **المستبعدات**: يتم استبعاد `api/`, `note/`, `function/`, و `docs/`.
