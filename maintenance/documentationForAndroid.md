# تحذير هام هذا الملف ليس له علاقة مباشرة بملفات المشروع هو فقط يشرح كيفيه عمل المشروع كموقع محلي داخل تطبيق الاندرويد 
# التوثيق الشامل والنهائي لمشروع Bazaar Android

يهدف هذا المستند إلى توفير مرجع كامل ومفصل لبنية المشروع، طريقة عمله، والتقنيات المستخدمة فيه، وذلك لضمان سهولة الصيانة والتطوير المستقبلي.

---

## أقسام رئيسية

1.  [الفلسفة والبنية المعمارية](#1-الفلسفة-والبنية-المعمارية)
2.  [هيكلية المشروع وأهم الملفات](#2-هيكلية-المشروع-وأهم-الملفات)
3.  [تدفق البيانات وإدارة الحالة](#3-تدفق-البيانات-وإدارة-الحالة)
4.  [شرح المكونات الأساسية (الكلاسات)](#4-شرح-المكونات-الأساسية-الكلاسات)
5.  [سيناريوهات العمل الرئيسية (Workflows)](#5-سيناريوهات-العمل-الرئيسية-workflows)
6.  [الجسر مع JavaScript](#6-الجسر-مع-javascript)
7.  [المكتبات والأذونات المستخدمة](#7-المكتبات-والأذونات-المستخدمة)
8.  [بناء التطبيق: الضغط، التعمية، والتوقيع](#8-بناء-التطبيق-الضغط-التعمية-والتوقيع)
9.  [اعتبارات الأمان وتوصيات](#9-اعتبارات-الأمان-وتوصيات)

---

## 1. الفلسفة والبنية المعمارية

(نفس المحتوى السابق)

---

## 2. هيكلية المشروع وأهم الملفات

(نفس المحتوى السابق)

---

## 3. تدفق البيانات وإدارة الحالة

(نفس المحتوى السابق)

---

## 4. شرح المكونات الأساسية (الكلاسات)

### 4.1. `MainActivity.kt`
- **الغرض**: مركز التنسيق الأعلى ونقطة الدخول للتطبيق.
- **المسؤوليات**:
    - تهيئة جميع "المدراء" (Managers).
    - عرض مربع حوار التحديث: عند إبلاغها من `UpdateManager` بوجود تحديث، تقوم بعرض `AlertDialog` **غير قابل للإلغاء** للمستخدم، مع عرض حجم التحديث **دائماً بالميجابايت (MB)**، مع زيادة الدقة للأحجام الصغيرة جداً (3 منازل عشرية بدلاً من 2).
    - إعادة تشغيل التطبيق: تحتوي على وظيفة `restartApp` لإعادة تشغيل التطبيق بشكل نظيف بعد اكتمال التحديث.
    - جدولة الفحص الدوري: عند بدء تشغيل التطبيق، تقوم بجدولة `UpdateWorker` للعمل بشكل دوري كل ساعة.

### 4.2. `WebViewManager.kt`
- **الغرض**: مسؤول عن كل ما يتعلق بإعداد وتكوين `WebView`.
- **المسؤوليات**: تفعيل إعدادات `WebView`، ربط `WebAppInterface`، وتعيين `WebViewClient` مخصص لاعتراض طلبات `mailto:` و `tel:` وتوجيهها للتطبيقات المناسبة.

### 4.3. `UpdateManager.kt`
- **الغرض**: مسؤول عن إدارة دورة حياة محتوى الويب بالكامل، من الإعداد الأولي إلى التحديثات الذكية.
- **المسؤوليات**:
    -   **`setupLocalContent`**: تنفيذ الإعداد الأولي عند أول تشغيل للتطبيق.
    -   **`checkForUpdates`**: فحص وجود تحديثات عن بعد بمقارنة `version.json`. يقوم بحساب إجمالي حجم التنزيل **بالبايت (Bytes)** ويمرره مع `version.json` الجديد إلى `MainActivity`.
    -   **`downloadAndApplyUpdate`**: يتم استدعاؤها **فقط** بعد موافقة المستخدم. تستقبل `version.json` الجديد، وتقوم بتنزيل الملفات المطلوبة، وفي حالة النجاح، تحفظ `version.json` الجديد وتطلب من `MainActivity` إعادة تشغيل التطبيق.

### 4.4. `UpdateWorker.kt`
- **الغرض**: عامل يعمل في الخلفية (`WorkManager`) لفحص وجود تحديثات بشكل دوري ومنتظم.
- **المسؤوليات**:
    -   يعمل كل ساعة (تقريباً، حسب سياسات توفير الطاقة في النظام).
    -   يقوم بفحص `version.json` عن بعد ومقارنته بالإصدار المحلي.
    -   **لا يقوم بالتنزيل**. إذا وجد تحديثًا، يقوم بإظهار **إشعار (Notification)** للمستخدم.
    -   عند النقر على الإشعار، يتم فتح التطبيق ليبدأ المستخدم عملية التحديث من `MainActivity`.

### 4.5. `NotificationHandler.kt`، `MyFirebaseMessagingService.kt`، وباقي المدراء
-   (تبقى وظائفهم كما هي مشروحة سابقًا).

---

## 5. سيناريوهات العمل الرئيسية (Workflows)

### 5.1. بدء تشغيل التطبيق

(نفس المحتوى السابق)

### 5.2. آلية تحديث المحتوى (عندما يكون التطبيق مفتوحاً)
1.  بعد تحميل الصفحة الرئيسية، `MainActivity` تطلب من `UpdateManager.checkForUpdates` البدء في الفحص بصمت.
2.  `UpdateManager` يقوم بتنزيل `version.json` الجديد من GitHub.
3.  يقارن رقم الإصدار. إذا كانا متطابقين، تتوقف العملية.
4.  إذا كان الإصدار مختلفًا، `UpdateManager` يمرر `version.json` الجديد وإجمالي حجم التحديث بالبايت إلى `MainActivity`.
5. `MainActivity` تخزن `version.json` الجديد مؤقتًا وتعرض `AlertDialog` **غير قابل للإلغاء** للمستخدم مع حجم التحديث **دائماً بالميجابايت (MB)**، مع زيادة الدقة للأحجام الصغيرة.
6.  **إذا ضغط المستخدم على "تجاهل"**: يتم إغلاق الرسالة.
7.  **إذا ضغط المستخدم على "موافق"**:
    -   `MainActivity` تطلب من `UpdateManager.downloadAndApplyUpdate` بدء عملية التنزيل، وتمرر لها `version.json` الجديد.
    -   `UpdateManager` يقوم بتنزيل الملفات المطلوبة فقط.
    -   إذا فشلت أي عملية تنزيل، تتوقف العملية بأكملها.
    -   إذا نجحت جميع التنزيلات، يتم حفظ `version.json` الجديد في `SharedPreferences`.
    -   `UpdateManager` يطلب من `MainActivity` إعادة تشغيل التطبيق.

### 5.3. آلية التحديث الدوري (عندما يكون التطبيق في الخلفية)

(نفس المحتوى السابق)

### 5.4. تدفق الإشعارات الواردة

(نفس المحتوى السابق)

---

## 6. الجسر مع JavaScript

(نفس المحتوى السابق)

---

## 7. المكتبات والأذونات المستخدمة

(نفس المحتوى السابق)

---

## 8. بناء التطبيق: الضغط، التعمية، والتوقيع

(نفس المحتوى السابق)

---

## 9. اعتبارات الأمان وتوصيات

-   **حفظ المانيفست الجديد**: من الأهمية بمكان التأكد من أن `version.json` الجديد يتم حفظه في `SharedPreferences` فورًا بعد اكتمال عملية تنزيل الملفات بنجاح. هذه الخطوة تضمن أن التطبيق، عند إعادة التشغيل، سيعرف أنه يعمل على أحدث إصدار ولن يطالب المستخدم بالتحديث مرة أخرى بشكل خاطئ.
-   **مقارنة بصمة الملفات (Hash Comparison)**: (نفس المحتوى السابق).
-   **حماية محتوى `assets`**: (تبقى التوصية كما هي).
-   **إدارة المفاتيح الحساسة**: (تبقى التوصية كما هي).
