# دليل المصادقة والتوجيه الديناميكي (Auth & SPA Routing Guide)

يعتمد مشروع "بزار" على بنية **تطبيق الصفحة الواحدة (Single Page Application - SPA)**، حيث يتم التنقل بين الصفحات وإدارة جلسات المستخدمين مركزياً دون إعادة تحميل المتصفح بالكامل. يجمع هذا المستند بين جزأين أساسيين: نظام المصادقة ونظام التوجيه.

---

## 1. الإعدادات المركزية والأمان (`js/config.js`)

يعتبر هذا الملف العصب المركزي لإعدادات التطبيق، حيث يضمن اتساق العمل بين البيئات المختلفة (المحلية، الحساب التجريبي، والتطبيق):

*   **إدارة العناوين (API Base URL)**: 
    *   يحدد `baseURL` تلقائياً بناءً على `location.hostname` ومصفوفة `allowedHosts`.
    *   يضمن توجيه كافة الطلبات إلى السيرفر الصحيح (Vercel أو Localhost) دون تعديل يدوي في الكود.
*   **إدارة المسؤولين (`ADMIN_IDS`)**:
    *   يحتوي على المصفوفة الرسمية للمعرفات الفريدة (`user_key`) التي تملك صلاحيات إدارة النظام.
    *   يتم استهلاك هذه المصفوفة في `user-dashboard.js` لفتح لوحة التحكم، وفي `view_init.js` لإظهار بيانات البائعين للمسؤولين فقط.
    *   **ملاحظة**: تم استبدال نظام التحقق برقم الهاتف بهذا النظام الأكثر أماناً لضمان عدم تداخل الصلاحيات.
*   **التوافقية والأمان**:
    *   **التوافقية (Backward Compatibility)**: يظل `window.userSession` متاحاً عالمياً لضمان عدم تعطل الأجزاء القديمة من الكود، ولكن يمنع تعديله يدوياً؛ يجب استخدام `SessionManager`.
    *   **الأمان**: يتم التحقق من كلمة المرور (Re-authentication) قبل العمليات الحساسة (حذف الحساب، حفظ تغييرات الملف الشخصي، انتحال الشخصية).
    *   **تعدد المنصات**: منطق الخروج (`logout`) مدمج فيه استدعاءات `window.Android` لضمان مزامنة الحالة مع تطبيق الأندرويد.

---

## 2. نظام المصادقة وإدارة الجلسات (`js/auth/`)

يعتمد النظام على المركزية والموديولية (Modularity) وفصل المهام عبر ثلاث وحدات أساسية:

### أ. مدير الجلسة (`sessionManager.js`)
هو "مصدر الحقيقة" الوحيد والمتحكم في حالة المستخدم.
*   **الوظائف**: `init()` للتهيئة، `login()` لمعالجة الدخول، `logout()` للخروج الآمن، و `updateUser()` للتحديث الفوري.
*   **انتحال الشخصية (Impersonation)**: يوفر دوال `impersonate()` و `isImpersonating()` للتبديل بين الهويات مع حفظ الجلسة الأصلية للمسؤول.

### ب. المدقق الموحد (`validators.js` - `AuthValidators`)
يحتوي على كافة قواعد التحقق لضمان اتساق البيانات:
*   التحقق من الهاتف (`validatePhone`, `normalizePhone`) والأسماء (`validateUsername`) وكلمات المرور.
*   `validateAddress(address, hasCoordinates)`: تتحقق من وجود العنوان وتوفر حالة نجاح تتيح للواجهة عرض تفاصيل ذكية.

### ج. مساعد الواجهة (`uiHelpers.js` - `AuthUI`)
يوفر طبقة تجريد لمكتبة `SweetAlert2`:
*   إدارة شاشات التحميل (`showLoading`, `close`).
*   تنسيق التنبيهات (`showError`, `showSuccess`) ونوافذ تأكيد كلمة المرور.

---

## 3. تدفق العمليات (Auth Workflows)

*   **تسجيل الدخول**: يبدأ بالتدقيق عبر `AuthValidators` ثم API التحقق، وينتهي بـ `SessionManager.login` لتفعيل الجلسة والإشعارات.
*   **إنشاء حساب (خيار البائع)**: يدعم تكامل الخريطة وقفل النافذة العرضي. تمت إضافة خيار "تفعيل وضع البائع" عبر نافذة تفاعلية عصرية لجمع بيانات التوصيل الذاتي (`isDelevred`) والحد الأدنى للطلبات (`limitPackage`). يتم إرسال هذه الحقول ضمن كائن `register_newUser` إلى API الـ POST في `api/users.js` لضمان حفظها في قاعدة البيانات فور التأسيس، مع مزامنتها في جلسة المستخدم (`SessionManager`) فور التسجيل.
*   **الملف الشخصي (تحديث الخيارات)**: يتيح تعديل خيارات البائع عبر نافذة مخصصة. يتم حفظ التغييرات (`isDelevred`, `limitPackage`) ضمن كائن `updatedData` وإرسالها إلى API الـ PUT في `api/users.js`. يتم التحقق من التغييرات محلياً وتحديث كائن الجلسة فورياً لضمان انعكاس الإعدادات الجديدة على حسابات التوصيل في السلة دون الحاجة لإعادة التحميل.

---

## 4. نظام التوجيه والتحميل الديناميكي (SPA Routing)

يتم إدارة التنقل عبر محرك التحميل في `js/forms.js` لضمان تجربة مستخدم سلسة.

### أ. الدالة الأساسية: `mainLoader`
تُستخدم لجلب محتوى HTML وحقنه في حاوية محددة.
*   **Signature**: `async function mainLoader(pageUrl, containerId, waitMs, cssRules, callbackName, reload)`
*   **تقنية "التخزين المزدوج" (Double Buffering)**: تحميل المحتوى في Buffer مخفي أولاً لمنع وميض المحتوى غير المنسق (FOUC).
*   **معالجة السكربتات (IIFE Wrapping)**: تغليف السكربتات تلقائياً لمنع أخطاء إعادة تعريف المتغيرات (`const`/`let`) عند التنقل المتكرر.

### ب. إدارة التاريخ والعودة (`containerGoBack`)
*   تعتمد على سجل الحاويات `LOADER_REGISTRY`.
*   عند استدعاء `containerGoBack()`، يتم مسح الحاوية الحالية وإظهار السابقة، مما يحافظ على نظافة الـ DOM وتوفير الذاكرة.

### ج. سجل الحاويات والسلوك التلقائي
*   **التحكم الذكي**: عند فتح حاوية جديدة، يتم إخفاء كافة الحاويات الأخرى المسجلة تلقائياً.
*   **تحسين الأداء**: إذا كانت الصفحة مسجلة مسبقاً، يتم إظهارها فوراً بدلاً من إعادة تحميلها، ما لم يتم تفعيل خيار `reload: true`.

---

## 5. أدوات تحميل مساعدة بديلة (`js/tools.js`)

بالإضافة إلى `mainLoader` الأساسية، يوفر ملف `tools.js` دوال إضافية لحالات تحميل محددة:

### أ. دالة اللقطة الفريدة: `insertUniqueSnapshot`
تستخدم لتحميل المحتوى مع نظام تخزين مؤقت (Caching) داخلي لمنع تكرار الطلبات الشبكية.
*   **الوظيفة**: تقوم بجلب الصفحة لمرة واحدة وتخزينها في كائن `pageSnapshots`.
*   **إدارة السكربتات**: تدعم تغليف الـ IIFE للسكربتات الداخلية، وتضيف بصمة زمنية (`?v=`) للسكربتات الخارجية لضمان التحديث.
*   **الاستخدام**: مثالية للصفحات الثابتة التي يتم تكرار فتحها كثيراً وتتطلب سرعة استجابة فائقة.

### ب. دالة التحميل المبسطة: `loader`
دالة تحميل تقليدية تركز على التتابع البسيط والانتظار (Wait).
*   **الوظيفة**: جلب HTML، إفراغ الحاوية، وحقن المحتوى مع إعادة تشغيل السكربتات.
*   **الميزة**: توفر تحكماً بسيطاً في وقت الانتظار (`waitMs`) بعد اكتمال التحميل والتشغيل.

---

## 6. أفضل الممارسات (Best Practices)

1.  **في التوجيه**: استخدم `reload: true` فقط عند الحاجة لتحديث البيانات المباشرة، ويفضل دائماً تمرير الـ Callback كـ String.
2.  **في المصادقة**: لا تقم بتعديل `window.userSession` يدوياً أبداً؛ استخدم دوال `SessionManager`.
3.  **في التصميم**: وحد بادئة معرفات الحاويات (مثل `index-XXX-container`) لتسهيل التتبع البرمجي.
