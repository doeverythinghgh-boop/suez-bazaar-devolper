# توثيق تطبيق الويب التقدمي (PWA Architecture Report)

يوفر هذا التقرير شرحاً دقيقاً وشاملاً لكيفية عمل تقنية PWA في مشروع Suez Bazaar، بما في ذلك استراتيجيات التخزين المؤقت، إدارة الخدمات (Service Workers)، والعمل بدون اتصال.

---

## 1. المكونات الأساسية (Core Components)

### أ. ملف البيان (`manifest.json`)
- **الوظيفة:** يعرف هوية التطبيق للمتصفح ونظام التشغيل.
- **الإعدادات الرئيسية:**
    - `display: standalone`: يضمن ظهور التطبيق واجهة مستقلة بدون شريط أدوات المتصفح.
    - `start_url: /index.html`: نقطة دخول التطبيق.
    - `theme_color: #007bff`: لون شريط الحالة في الهواتف.
    - **الأيقونات:** يتضمن أيقونات بمقاسات (192x192) و (512x512) مع دعم `maskable` للتوافق مع مختلف منصات الهواتف.

### ب. عامل الخدمة الرئيسي (`sw.js`)
هو المحرك الأساسي لإدارة الشبكة والتخزين المؤقت. يقوم بدمج منطق الإشعارات مع منطق التخزين.
- **التثبيت (Install):** يقوم بتحميل الأصول الثابتة (Static Assets) مسبقاً (Precaching).
- **التفعيل (Activate):** ينظف النسخ الاحتياطية (Caches) القديمة لضمان تحديث التطبيق.

### ج. عامل خدمة الإشعارات (`firebase-messaging-sw.js`)
مسؤول حصرياً عن استقبال رسائل Push عبر Firebase في الخلفية (Background) حتى لو كان التطبيق مغلقاً.

---

## 2. استراتيجيات التخزين المؤقت (Caching Strategies)

يعتمد التطبيق على استراتيجيات مختلفة حسب نوع الطلب لتحقيق أفضل توازن بين السرعة والحداثة:

| نوع الملف                       | الاستراتيجية المتبعة | السلوك                                                        |
| :------------------------------ | :------------------- | :------------------------------------------------------------ |
| **صفحات HTML (Navigation)**     | **Network First**    | يحاول الشبكة أولاً، وفي حال الفشل يفتح صفحة `offline.html`.    |
| **أصول ثابتة (CSS, JS, Fonts)** | **Cache First**      | يبحث في الكاش أولاً للسرعة، وفي حال عدم الوجود يجلبها ويخزنها. |
| **الصور (Images)**              | **Cache First**      | يتم تخزين الصور لتقليل استهلاك البيانات والتحميل الفوري.      |
| **البيانات الديناميكية (APIs)** | **Network Only**     | لضمان دقة البيانات وحداثتها (مثل الأسعار والطلبات).           |

---

## 3. العمل بدون اتصال (Offline Support)

1. **الصفحة الاحتياطية:** عند فقدان الاتصال ومحاولة فتح الرابط، يعرض التطبيق صفحة `offline.html` المسجلة مسبقاً في الكاش.
2. **استمرارية الواجهة:** بفضل تخزين ملفات CSS و JS، تظل واجهة التطبيق الأساسية تعمل حتى بدون إنترنت، مع عرض تنبيهات للمستخدم بشأن حالة الاتصال.
3. **التوثيق المحلي:** يتم استخدام وقاعدة بيانات `IndexedDB` (عبر `notification-db-manager.js`) لحفظ سجلات الإشعارات محلياً، مما يسمح للمستخدم بتصفحها لاحقاً.

---

## 4. نظام الإشعارات في PWA

- **التكامل مع FCM:** يستخدم التطبيق إصدار Firebase v8 المتوافق مع Service Workers.
- **الاستقبال النشط (Foreground):** تتم معالجته في `notificationSetUp.js` لعرض تنبيهات داخلية فورية.
- **الاستقبال في الخلفية (Background):** تتم معالجته في `firebase-messaging-sw.js` باستخدام `onBackgroundMessage`.
- **التخزين في IndexedDB:** كل إشعار يصل يتم حفظه فوراً في مخزن `notificationsLog` داخل قاعدة بيانات `bazaarAppDB`.

---

## 5. آلية التسجيل والتحديث

1. يبدأ التسجيل عند تشغيل `DOMContentLoaded` في `js/index.js`.
2. يتم استدعاء `setupFCM()` التي تقرر تسجيل الويب أو الأندرويد.
3. يتم استخدام `navigator.serviceWorker.register` لتفعيل `sw.js`.
4. يدعم التطبيق التحديث الفوري عبر `skipWaiting()` و `clients.claim()` المضمنة في ملفات الـ Service Worker.

---

## 6. نظام الإصدارات والتحديث التلقائي (Version Management)

لضمان حصول المستخدين على أحدث نسخة من ملفات التطبيق (CSS, JS) وتجنب مشاكل الكاش القديم، يعتمد التطبيق على آلية تحديث قسرية:

### أ. ملف الإصدار (`version.json`)
يحتوي على رقم الإصدار الحالي (مثل `1.1.10`) وتاريخ آخر تحديث. يتم تحديثه يدوياً أو عبر أدوات الأتمتة عند رفع نسخة جديدة.

### ب. آلية التحقق (`checkAppVersionAndClearData`)
موجودة في ملف `js/tools.js` وتعمل كالتالي:
1. **الجلب:** استدعاء ملف `version.json` مع منع الكاش (`?t=timestamp`).
2. **المقارنة:** مقارنة الإصدار المجتلب مع الإصدار المخزن في `localStorage` (`app_version`).
3. **التحديث القسري:** في حال وجود إصدار جديد، يقوم التطبيق بـ:
    - مسح `sessionStorage` والكوكيز.
    - إلغاء تسجيل كافة الـ **Service Workers**.
    - مسح كافة ملفات الكاش في المتصفح (**Cache Storage**).
    - حفظ الإصدار الجديد وإعادة تحميل الصفحة من السيرفر فوراً.

### ج. دورية التحقق
يتم إجراء هذا الفحص في حالتين:
1. عند كل عملية تحميل أو تحديث للصفحة (DOMContentLoaded).
2. فحص دوري كل ساعة (ساعة واحدة) لضمان التحديث حتى لو كان التطبيق مفتوحاً لفترات طويلة.

---

## 7. معايير التثبيت والبيئة الآمنة (Installation & Security)

لكي يظهر خيار "تثبيت التطبيق" للمستخدم، يجب استيفاء المعايير التالية:
- **HTTPS:** يجب أن يعمل الموقع عبر بروتوكول آمن (يُستثنى من ذلك `localhost`).
- **Manifest:** وجود ملف `manifest.json` مكتمل (كما هو موضح في القسم 1).
- **Service Worker:** وجود SW مسجل ويحتوي على معالج لأحداث `fetch`.

## 8. الفروقات بين المنصات (Cross-Platform Handling)

يتعامل التطبيق بذكاء مع بيئتي التشغيل المختلفتين:

### أ. بيئة Android WebView
- لا يستخدم التطبيق مكتبات Firebase JS مباشرة، بل يعتمد على واجهة `window.Android`.
- يتم طلب التوكن من النظام الأصلي (Native) عبر `window.Android.onUserLoggedIn`.
- يتم استقبال التوكن في `localStorage` عبر دالة `waitForFcmKey`.

### ب. متصفحات الويب (Chrome, Safari, Edge)
- يتم تحميل مكتبات Firebase v8 ديناميكياً عند الحاجة.
- يتم طلب الإذن عبر `Notification.requestPermission()`.
- تُستخدم مفاتيح **VAPID** لتأمين عملية إرسال الإشعارات.

## 9. استكشاف الأخطاء وإصلاحها (Troubleshooting)

للمطورين، يمكن اتباع هذه الخطوات عند تعطل ميزات الـ PWA:

1. **فحص الـ Service Worker:** عبر Chrome DevTools -> Application -> Service Workers. تأكد من أنه "Activated and Running".
2. **فحص سجلات التوكن:** تأكد من ظهور `fcm_token` (للويب) أو `android_fcm_key` (للأندرويد) في الـ `localStorage`.
3. **أخطاء الشبكة:** في حال فشل جلب `version.json` أو `notification_config.json` بسبب مشاكل الاتصال، سيعتمد التطبيق على النسخ المحلية المخزنة.
4. **دعم النصائح البرمجية:** إذا لم تظهر الإشعارات، تأكد من أن حالة `notifications_enabled` في `localStorage` ليست `false`.

## 10. نظام تثبيت التطبيق وتوجيه المستخدم (App Installation & Welcome Flow)

يستخدم مشروع بزار نظاماً ذكياً لتشجيع المستخدمين على تثبيت التطبيق لضمان تجربة مستخدم أفضل واستقرار الإشعارات.

### أ. آلية التفعيل (Triggering Mechanism)
- يتم التقاط حدث `beforeinstallprompt` وتخزينه في المتغير العالمي `deferredPrompt`.
- عند تحميل التطبيق (`window.load`) وبعد مرور 3 ثوانٍ، يتم استدعاء `checkAndShowInstallPrompt`.
- يتم التحقق مما إذا كان المستخدم يتصفح عبر الموبايل وما إذا كان التطبيق مثبتاً بالفعل (Standalone Mode).

### ب. نافذة "اختر الطريقة المناسبة لك"
تظهر نافذة `SweetAlert2` مخصصة تعرض خيارين:
1.  **Google Play**: رابط مباشر لمتجر جوجل بلاي لمستخدمي أندرويد.
2.  **App Store (PWA Style)**: زر "تثبيت التطبيق" الذي يستخدم منطق الـ PWA.

### ج. منطق التثبيت الذكي (triggerPWAInstall)
- **للمتصفحات الداعمة**: يتم استدعاء `deferredPrompt.prompt()` لإظهار نافذة المتصفح الرسمية للتثبيت.
- **لمستخدمي iOS**: نظراً لعدم دعم Apple لحدث التحريض التلقائي، يتم عرض نافذة تعليمات توضح خطوات التثبيت اليدوي (زر المشاركة > إضافة للشاشة الرئيسية).
- **الموجّه الاحتياطي**: في حال عدم توفر طلب تثبيت، يتم توجيه المستخدم مباشرة لصفحة الترحيب.

### د. صفحة الترحيب والفوائد (`pages/welcome.html`)
سواء اختار المستخدم التثبيت من المتجر أو عبر المتصفح، يتم توجيهه في النهاية إلى دالة `showWelcomeAndThanksPage`:
- يتم إخفاء الهيدر الرئيسي للتطبيق (`index-app-header`).
- يتم تحميل صفحة `pages/welcome.html` وعرضها بملء الشاشة (`fixed position`).
- تهدف هذه الصفحة لتعريف المستخدم بمميزات Suez Bazaar وشكره على الانضمام.

---
> [!TIP]
> عند اختبار PWA محلياً، يفضل استخدام وضع "Incognito" أو "Guest" لتجنب تداخل الكاش من جلسات سابقة، وتذكر دائماً تنظيف الكاش من تبويب "Application" عند إجراء تغييرات جذرية في `sw.js`.
