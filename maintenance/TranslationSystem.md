# دليل نظام الترجمة الموحد (Unified Localization Guide)

يعتمد مشروع "بزار" على نظام ترجمة ديناميكي مركزي مصمم ليدعم كافة أجزاء المشروع تدريجياً. يسمح هذا النظام بتبديل اللغة (مثل العربية والإنجليزية) مع التغيير الفوري لاتجاه الواجهة (RTL/LTR) دون الحاجة لإعادة تحميل الموقع.

---

## 1. هيكلية ملفات الترجمة

يتم تنظيم النصوص في مجلد `lang/` وفق هيكلية موديولية (Modular) تعتمد على الدمج التلقائي:

### أ. الملف العام (`general.json`)
هو الملف الأساسي والمستودع المركزي لكافة النصوص التي تتكرر عبر النظام. يهدف هذا الملف إلى منع تكرار نفس المفاتيح في ملفات الترجمة الخاصة بالصفحات الأخرى، ويشمل:
*   عناصر الهيدر والفوتر (Header/Footer).
*   رسائل التنبيهات الموحدة (Alerts & Confirmations).
*   المصطلحات العامة (مثل: "موافق"، "إلغاء"، "حفظ").
*   رسائل حالات الشبكة والوقت.
*   أي نص يظهر في أكثر من مكان داخل التطبيق.

### ب. ملفات الصفحات (`pageName.json`)
لكل صفحة أو موديول جديد (مثل `login`, `profile`, `products`)، يتم إنشاء ملف JSON مستقل يحتوي فقط على النصوص الخاصة بتلك الواجهة. هذا يسهل الصيانة ويمنع تضخم الملفات.

---

## 2. المحرك البرمجي المركزي

يعمل النظام من خلال ثلاث ركائز أساسية في `js/index.js`:

1.  **المخزن العالمي (`window.appTranslations`)**: كائن واحد يتم فيه دمج كافة ملفات الـ JSON المحملة ليصبح "قاموس" التطبيق النشط.
2.  **دالة الجلب (`window.langu(key)`)**: الدالة المسؤولة عن استخراج النص بناءً على مفتاح الترجمة ولغة المستخدم الحالية في الـ `localStorage`.
3.  **دالة التطبيق الشامل (`window.applyAppTranslations()`)**:
    *   تقوم بتحديث اتجاه الصفحة (`dir`) ووسم اللغة (`lang`) في جذر الـ HTML (`#index-html-root`).
    *   تقوم بمسح الـ DOM وترجمة أي عنصر يحمل المفاتيح التالية:
        *   `data-lkey`: لترجمة المحتوى النصي للعنصر (`textContent`).
        *   `data-lkey-placeholder`: لترجمة النص التوضيحي داخل حقول الإدخال (`placeholder`).
        *   `data-lkey-title`: لترجمة التلميحات التي تظهر عند الوقوف على العنصر (`title`).
    *   تعيد مزامنة العناصر الحساسة (مثل اسم المستخدم في الهيدر).

---

## 3. ترجمة السمات والنصوص (Advanced Attributes)

*   **ثبات الأيقونات والرموز (Icon Preservation)**:
    *   **هام جداً**: عند ترجمة الأزرار أو العناوين التي تحتوي على أيقونات او رموز(`<i>` أو `<svg>`)، **يجب** وضع النص المراد ترجمته داخل وسم `<span>` يحمل `data-lkey`، بدلاً من وضع السمة على العنصر الأب.
    *   **مثال صحيح**:
        ```html
        <button><i class="fas fa-save"></i> <span data-lkey="save_btn">حفظ</span></button>
        ```
    *   **مثال خاطئ** (سيؤدي لاختفاء الأيقونة):
        ```html
        <button data-lkey="save_btn"><i class="fas fa-save"></i> حفظ</button>
        ```

*   **تلميحات العناصر (Tooltips)**: نستخدم السمة `data-lkey-title` لترجمة النصوص التي تظهر عند الوقوف على العنصر (Attribute `title`).

*   **حقول الإدخال (Input Placeholders)**: نستخدم السمة `data-lkey-placeholder` لترجمة النصوص التوضيحية داخل الـ `input` والـ `textarea`.
    *   **تنبيه**: استخدام `data-lkey-attr="placeholder"` غير مدعوم وقد لا يعمل بشكل صحيح. استخدم `data-lkey-placeholder` دائماً لهذا الغرض.

---

## 4. تدويل البيانات (Data Internationalization)

عند التعامل مع ملفات JSON ضخمة تحتوي على بيانات (مثل `shared/list.json` للتصنيفات)، يتم اتباع الهيكلية التالية:
1.  **تحويل القيم**: تحويل الحقول النصية (مثل `title`) من نص بسيط إلى كائن لغات: `"title": { "ar": "...", "en": "..." }`.
2.  **الاستهلاك البرمجي**: المكونات التي تقرأ هذه البيانات (مثل `CategoryModal`) يجب أن تختار اللغة المناسبة برمجياً:
    ```javascript
    const displayTitle = typeof titleObj === 'object' ? titleObj[window.app_language] : titleObj;
    ```

---

## 5. النصوص داخل الكود والأنيميشن (Logic & Animation)

بالنسبة للمكونات التي تعتمد على JavaScript لتوليد النصوص أو الأنيميشن (مثل الهيدر):
*   يتم استدعاء `window.langu("key")` مباشرة داخل الكود لتلقي النص المترجم.
*   بالنسبة للقوائم المتكررة (مثل شعارات الهيدر)، يتم تخزين المفاتيح في `general.json` بأسماء متسلسلة (`tagline_1`, `tagline_2`) واستدعاؤها عبر دورة برمجية (Loop).

---

## 6. التكامل مع نظام التحميل الديناميكي (`mainLoader`)

يضمن نظام `mainLoader` في `js/forms.js` تطبيق الترجمات تلقائياً عند تحميل أي صفحة أو موديول جديد:
*   بمجرد انتهاء تحميل الـ HTML وتشغيل السكربتات، تقوم `mainLoader` باستدعاء `window.applyAppTranslations()`.
*   هذا يضمن أن العناصر التي تحمل سمات `data-lkey` في الصفحات المحملة ديناميكياً ستتم ترجمتها فور ظهورها.

---

## 7. التنبيهات ونوافذ الحوار (Alerts & Modals)

لضمان تعريب النوافذ المنبثقة (SweetAlert2)، يتم اتباع إحدى الطريقتين:

### أ. استخدام المساعدات الموحدة (`AuthUI`)
يُفضل دائماً استخدام كائن `AuthUI` في `js/auth/uiHelpers.js` للمهام المتكررة، حيث أنه مترجم داخلياً بشكل تلقائي:
*   `AuthUI.showLoading(title, text)`: يعرض مؤشر تحميل.
*   `AuthUI.showSuccess(title, text)`: يعرض رسالة نجاح.
*   `AuthUI.showError(title, text)`: يعرض رسالة خطأ.
*   `AuthUI.confirmPassword(title, text)`: يطلب تأكيد كلمة المرور.

### ب. الاستدعاء المباشر (`Swal.fire`)
عند الحاجة لتخصيص كامل، يجب استدعاء `window.langu()` لكل نص يظهر للمستخدم:
```javascript
Swal.fire({
    title: window.langu("key_title"),
    text: window.langu("key_text"),
    confirmButtonText: window.langu("alert_confirm_btn"),
    cancelButtonText: window.langu("alert_cancel_btn")
});
```

---

## 8. كيفية البدء بترجمة موديول (صفحة) جديد
... (بقية الخطوات كما هي)

1.  **إنشاء الملف**: أضف ملفاً جديداً في مجلد `lang/` باسم الصفحة (مثال: `myPage.json`).
2.  **كتابة المفاتيح**: أضف النصوص بصيغة `{ "ar": "...", "en": "..." }`.
3.  **تحديث التسجيل**: أضف أمر تحميل الملف الجديد في دالة `loadIndexTranslations()` داخل `js/index.js` ليتم دمجه في الكائن العالمي.
4.  **تسمية العناصر**: أضف `data-lkey` للعناصر في ملف الـ HTML الخاص بالصفحة.
5.  **التنسيق المنطقي**: تأكد من أن ملف الـ CSS الخاص بالصفحة يستخدم **Logical Properties** لضمان عمل الاتجاهين:
    *   استخدم `inset-inline-start/end` بدلاً من `left/right`.
    *   استخدم `padding-inline-start` بدلاً من `padding-left`.
    *   استخدم `text-align: start` بدلاً من `text-align: right`.

---

9. الحفاظ على التفضيلات

يضمن النظام بقاء لغة المستخدم المختارة حتى في الحالات التالية:
*   **تسجيل الخروج**: يحفظ `SessionManager` اللغة قبل مسح البيانات ويعيد تعيينها فوراً لضمان بقاء الواجهة باللغة التي يفضلها المستخدم حتى بعد الخروج.
*   **تحديث الصفحة**: يتم استرجاع اللغة من الـ `localStorage` فور تشغيل التطبيق وقبل رندر أي عنصر.
