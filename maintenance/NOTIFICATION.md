# نظام الإشعارات المركزي (Architecture Report)

هذا التقرير يوضح الهيكل النهائي والمنطق البرمجي لنظام الإشعارات في المشروع، مع التركيز على ميزات الاستهداف الدقيق، الفلترة العالمية، ومرونة الرسائل.

---

## 1. إدارة الإعدادات والتحكم
يتم التحكم في تفعيل/تعطيل الإشعارات لكل طرف (مشتري، بائع، مندوب، إدارة) عبر ملف إعدادات مركزي.

### أ. التخزين المنسدل (`Cloudflare R2`)
- **الملف:** `notification_config.json` مخزن سحابياً لضمان المزامنة الفورية.
- **الإدارة:** واجهة `notification/page/settings.js` تسمح للمدير بتعديل الإعدادات في وقت التشغيل.

### ب. محرك التحقق (`notificationTools.js`)
- **الدالة:** `shouldNotify(stepId, role)`
- **الوظيفة:** تقوم بفحص الإعدادات العالمية قبل تنفيذ أي عملية إرسال، مما يضمن احترام خصوصية المستخدمين وقرارات الإدارة.

---

## 2. إدارة المحتوى والرسائل (Message Management)
تم فصل كافة النصوص والرسائل عن الكود المصدري وتجميعها في ملف JSON لسهولة الصيانة والترجمة.

### أ. ملف القوالب (`notification_messages.json`)
- **المسار:** `notification/notification_messages.json`
- **الوظيفة:** يحتوي على عناوين ونصوص الإشعارات مقسمة حسب الحدث (شراء، تفعيل مرحلة) وحسب الدور المستهدف.
- **آلية التحميل:** يتم تحميله محلياً كجزء من ملفات المشروع لضمان السرعة وسهولة الإدارة داخل الكود.
- **القوالب ديناميكية:** يدعم الملف استخدام المتغيرات مثل `${orderId}` و `${stepName}` التي يتم استبدالها برمجياً.

### ب. محرك القوالب (`Template Engine`)
- **الدالة:** `getMessageTemplate(path, placeholders)`
- **الوظيفة:** تستخرج القالب المناسب من ملف JSON وتقوم باستبدال كافة المتغيرات الممررة بالقيم الفعلية باستخدام Regular Expressions.
- **الأمان:** يوفر النظام رسائل احتياطية (Fallback) في حال فشل تحميل الملف لضمان استمرارية الخدمة.

---

## 3. استراتيجية الاستهداف (Targeting Strategy)

تم الانتقال من الإشعارات الجماعية للطلب بالكامل إلى **الإشعارات الموجهة على مستوى المنتج (Item-level Awareness)**.

### أ. تتبع الهوية في الذاكرة
يتم حفظ `seller_key` لكل منتج في بنية البيانات المحلية (`stateManagement.js`) عند تحميل الطلب، مما يسمح للنظام بمعرفة صاحب كل منتج فوراً.

### ب. الدوال الذكية للاستخراج (`steperNotificationLogic.js`)
- `extractRelevantSellerKeys`: ترجع قائمة بالبائعين المتأثرين فقط بالمنتجات التي تم تحديثها.
- `extractRelevantDeliveryKeys`: ترجع قائمة بالمناديب المسؤولين فقط عن شحن أو توصيل المنتجات المعنية.

---

## 4. الفلترة العالمية (Global Actor Filtering)

قاعدة ذهبية: **"لا أحد يتلقى إشعاراً عن فعل قام به هو بنفسه"**.

- **المعرف:** يتم تمرير `actingUserId` (معرف المستخدم الحالي) من واجهات الـ Popups إلى محرك الإشعارات.
- **التطبيق:** يتم استثناء القائم بالفعل من كافة قوائم المستلمين (مشتري، بائعين، مناديب) قبل البدء في عملية الإرسال الفعلي.

---

## 5. الاعتبارات التقنية والأداء

1. **تحميل كسول (Lazy Loading):** يتم جلب ملف الرسائل فقط عند الحاجة الأولى للإشعار وتخزينه في الكاش لتقليل استهلاك البيانات.
2. **إرسال متوازي (Parallel Dispatch):** يتم استخدام `Promise.all` لإرسال الإشعارات لجميع الأطراف في وقت واحد.
3. **الاستقلالية:** نظام الإشعارات مفصول تماماً عن منطق حفظ البيانات الأساسي.
4. **سجلات التتبع للمطور (Dev Logs):** يتضمن النظام جمل تتبع تفصيلية تتبع سير عمليات التفعيل، الأذونات، ومزامنة التوكنات، مع توضيح حالة إذن النظام (OS Permission) وبيئة التشغيل (Web vs Android).

---

## 6. إشعارات لوحة التحكم (Admin Panel Notifications)

يوفر النظام أدوات للمسؤولين للتواصل المباشر مع المستخدمين عبر إشعارات FCM فورية من خلال `adminPanel.html`.

### أ. الإرسال الفردي (`sendAdminNotification`)
- **الدالة:** `window.sendAdminNotification(userKey)` في ملف `adminPanel.js`.
- **الآلية:**
    1. تستخرج نص الرسالة من حقل الإدخال المقابل للمستخدم في الجدول.
    2. تجلب توكنات المستخدم المعني باستخدام `getUsersTokens([userKey])`.
    3. ترسل الإشعار باستخدام العنوان الافتراضي للمسؤول (`admin_manual`).

### ب. الإرسال الجماعي (`sendBroadcastNotification`)
- **الدالة:** `window.sendBroadcastNotification()` في ملف `adminPanel.js`.
- **الآلية:**
    1. **التصفية:** تجلب قائمة كافة المستخدمين وتصفي من لديهم `hasFCMToken`.
    2. **التجميع:** تستخرج كافة التوكنات الصالحة من السيرفر لهؤلاء المستخدمين.
    3. **البث:** ترسل الرسالة لكافة الأجهزة المستهدفة بالتوازي باستخدام `sendNotificationsToTokens`.
---

## 7. التحكم في حالة الإشعارات للمستخدم (User Notification Control)

يسمح النظام للمستخدمين بالتحكم الكامل في استقبال التنبيهات على أجهزتهم عبر مفتاح تبديل (Master Toggle) موجود في صفحة `notifications.html`.

### أ. واجهة التحكم (User Interface)
- **الموقع:** أعلى قائمة الإشعارات في صفحة `notifications.html`.
- **العنصر:** مفتاح تبديل (Switch) بمعرف `notification-master-toggle`.
- **التصميم:** يلتزم بالهوية البصرية للتطبيق مع توفير تغذية راجعة فورية عبر `SweetAlert2`.

### ب. المنطق البرمجي (`notifications.js`)
- **حفظ الحالة:** يتم تخزين اختيار المستخدم في `localStorage` تحت مفتاح `notifications_enabled`.
- **التحقق المزدوج:** عند تهيئة الصفحة، يقوم النظام بمطابقة `localStorage` مع **إذن المتصفح الفعلي** (`Notification.permission`). إذا كان الإذن مسحوباً، يظهر المفتاح كـ "معطل" حتى لو كان محفوظاً كـ "مفعل" سابقاً.
- **واجهة المستخدم الديناميكية (`updateToggleUI`):** تتغير نصوص العنوان والوصف فورياً بناءً على الحالة:
    - **في حالة التفعيل:** يظهر العنوان "الإشعارات مفعلة" مع نص وصفي يؤكد الاستعداد لاستقبال التنبيهات.
    - **في حالة التعطيل:** يظهر العنوان "تفعيل الإشعارات" مع نص يحث المستخدم على تشغيل الميزة.
- **عند التفعيل (`enableNotifications`):**
    1. **فحص الأذونات:** يتم التحقق من `Notification.permission`.
    2. **معالجة الرفض (Denied):** 
        - في **الويب**: يتم عرض تنبيه إرشادي للمستخدم لفك الحظر من إعدادات المتصفح.
        - في **أندرويد**: يتم استدعاء `window.Android.requestNotificationPermission()` لإظهار طلب الإذن الخاص بالنظام مرة أخرى.
    3. **الطلب والمزامنة:** إذا كان الإذن متاحاً، يتم استدعاء `Notification.requestPermission()` ثم `setupFCM()` لمزامنة التوكن.
- **عند التعطيل (`disableNotifications`):** يمسح التوكنات، يوقف التهيئة، ويغير النصوص فوراً لتعكس حالة الإيقاف.

### ج. التكامل عند بدء التشغيل (`index.js`)
يحترم التطبيق قرار المستخدم عند كل إقلاع؛ فإذا كانت الحالة معطلة في `localStorage` أو كانت الأذونات غير ممنوحة، يتم تجنب استدعاء `setupFCM()` تماماً لتوفير الموارد واحترام خصوصية المستخدم.

---

## 8. ميزة حذف الإشعارات (Notification Deletion)

يسمح النظام للمستخدمين بتنظيف سجلاتهم عن طريق حذف الإشعارات بشكل فردي ونهائي.

### أ. الآلية البرمجية
- **قاعدة البيانات:** يتم استدعاء الدالة `deleteNotificationFromDB(id)` في `notification-db-manager.js` لإزالة السجل نهائياً من `IndexedDB`.
- **واجهة المستخدم:** يتم استخدام زر "سلة مهملات" بجوار حالة القراءة، مع تأثير حركي (Fade-out & Slide) وتأكيد عبر `SweetAlert2`.
- **التزامن:** يتم بث حدث `notificationDeleted` لتحديث واجهة المستخدم في كافة التبويبات المفتوحة.

---

## 9. الهيكلية البرمجية المقسمة (Modular Architecture)

لضمان سهولة الصيانة، تم تقسيم منطق صفحة الإشعارات إلى أربعة ملفات متخصصة:

1. **`notifications.js` (Core):** الملف الأساسي الذي يحتوي على هيكل البيانات (`state`) وتنسيق التهيئة.
2. **`notifications-ui.js` (UI):** مسؤول عن رسم القائمة، الرسائل المنبثقة (Toast)، وتنسيق التواريخ.
3. **`notifications-logic.js` (Logic):** يعالج عمليات الفلترة، حساب الإحصائيات، وإدارة التخزين المحلي.
4. **`notifications-actions.js` (Actions):** يدير الأحداث، التفاعل مع قاعدة البيانات، وطلب أذونات نظام التشغيل.

---
> [!NOTE]
> هذا التحكم يتم على مستوى الجهاز (Device-level). إذا قام المستخدم بالتعطيل أو الحذف على هاتف، فلن يتأثر الجهاز الآخر المرتبط بنفس الحساب.
