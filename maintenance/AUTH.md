# توثيق نظام المصادقة وإدارة الجلسات (Centralized Auth & Session System)

يغطي هذا المستند البنية التحتية الجديدة لنظام المصادقة في المشروع، والتي تعتمد على المركزية، الموديولية (Modularity)، وفصل المهام (Separation of Concerns).

---

## 1. البنية التحتية والوحدات المركزية (`js/auth/`)

تم نقل المنطق المشتت سابقاً إلى ثلاث وحدات أساسية تعمل معاً:

### أ. مدير الجلسة (`sessionManager.js`)
هو "مصدر الحقيقة" الوحيد والمتحكم في حالة المستخدم.
*   **الحالة (State)**: يدير `window.userSession` تلقائياً ويضمن مزامنتها مع `localStorage`.
*   **الوظائف الرئيسية**:
    *   `init()`: تُستدعى عند بدء التطبيق (`index.js`) قراءة الجلسة، تحديث الواجهة، وتهيئة الإشعارات.
    *   `login(user, redirect)`: معالجة الدخول الناجح، حفظ البيانات، تفعيل FCM، والتوجيه التلقائي.
    *   `logout()`: عملية خروج آمنة شاملة (مسح localStorage، IndexedDB، إعلام تطبيق Android، وتفريغ الحاويات).
    *   `updateUser(updates)`: تحديث بيانات الجلسة الحالية ومزامنة الاسم في الهيدر فوراً.
    *   **انتحال الشخصية (Impersonation)**:
        *   `impersonate(targetUser)`: تبديل الهوية مع حفظ جلسة المسؤول الأصلية.
        *   `isImpersonating()`: التحقق من وضع التصفح بصلاحيات مستخدم آخر.

### ب. المدقق الموحد (`validators.js` - `AuthValidators`)
يحتوي على كافة قواعد التحقق من المدخلات لضمان اتساق البيانات.
*   `validatePhone(phone)`: التحقق من طول وصيغة رقم الهاتف وتطبيعه (Normalization).
*   `validatePassword(pass)`: حد أدنى 4 أحرف.
*   `validateUsername(name)`: اسم حقيقي (3-30 حرف).
*   `validateAddress(address, hasCoordinates)`: تتحقق من وجود العنوان. إذا توفرت الإحداثيات، تعيد حالة نجاح نصية تتيح للواجهة عرض رسائل الشكر والتفاصيل الذكية.
*   `normalizePhone(phone)`: تحويل الأرقام (٠-٩) وحذف الرموز غير الرقمية.

### ج. مساعد الواجهة (`uiHelpers.js` - `AuthUI`)
يوفر طبقة تجريد (Abstraction) لمكتبة `SweetAlert2` لتسهيل الاستخدام وتوحيد المظهر.
*   `showLoading(msg)` / `close()`: إدارة شاشات التحميل.
*   `showError`, `showSuccess`: عرض التنبيهات.
*   `confirmPassword()`: نافذة منبثقة تطلب كلمة المرور للتحقق قبل الإجراءات الحساسة.
*   `showFieldValidationMsg()`: إظهار رسائل الخطأ أسفل حقول الإدخال مباشرة.

---

## 2. تدفق العمليات (Workflows)

### أ. تسجيل الدخول (`pages/login/login.js`)
1.  التحقق من المدخلات عبر `AuthValidators`.
2.  استدعاء API `verifyUserPassword`.
3.  عند النجاح، استدعاء `SessionManager.login(userData)` الذي يتولى كل شيء (الحفظ، الإشعارات، التوجيه).
4.  الدخول كضيف يستخدم نفس مسار `login` مع كائن "Guest".

### ب. إنشاء حساب (`pages/register/register.js`)
1.  تدقيق البيانات عبر `AuthValidators` (تم إدراج العنوان كحقل إلزامي مع دعم `location`).
2.  **تكامل الخريطة وقفل النافذة**: 
    *   يتم فتح الخريطة في SweetAlert2 مع قفل الإغلاق العرضي (يغلق من زر X فقط).
    *   يتم إرسال الإحداثيات عبر `postMessage` لنموذج التسجيل ليتم تخزينها مؤقتاً في الصفحة.
3.  **الرسائل الذكية (Smart UI)**: تعتمد على وجود نص في حقل العنوان أو وجود إحداثيات محددة.
4.  تأكيد كلمة المرور عبر نافذة من `AuthUI`.
5.  **التحديث دفعة واحدة (Batch Update)**: عند الضغط على "إنشاء حساب"، يتم إرسال كافة البيانات (الاسم، الهاتف، العنوان، الموقع) في طلب API واحد (`addUser`) لضمان الكفاءة.

### ج. الملف الشخصي (`pages/profile-modal/profile-modal.js`)
1.  تدقيق التعديلات عبر `AuthValidators` مع تمرير حالة وجود إحداثيات.
2.  **استعادة البيانات**: يتم جلب الموقع ضمن كائن بيانات المستخدم مرة واحدة عند تسجيل الدخول (`userSession.location`).
3.  **تحديث محلي أولاً**: عند اختيار موقع جديد من الخريطة، يتم تحديث واجهة الملف الشخصي فقط (تحديث حقل `profile-coords` المخفي) دون إرسال أي بيانات للسيرفر.
4.  **الرسائل الذكية (Smart UI)**: 
    *   يتم استدعاء `AuthValidators.validateAddress` للتحقق من النص يدوياً.
    *   إذا اختار المستخدم موقعاً، يتغير لون زر الموقع وتظهر رسالة نجاح خضراء.
    *   الرسالة تتغير في `profileInitializeData`؛ فإذا كان العنوان مسجلاً مسبقاً تظهر رسالة "تم ربط الموقع"، وإذا كان فارغاً تطلب من المستخدم كتابة تفاصيل إضافية.
5.  **الحفظ النهائي السحابي**: يتم إرسال التحديثات (بما فيها الموقع الجديد إذا وُجد في حقل `location`) كدفعة واحدة للسيرفر فقط عند الضغط على زر "حفظ التغييرات".
6.  تحديث الجلسة والواجهة فوراً عبر `SessionManager.updateUser`.
7.  الحذف يتطلب تأكيداً نهائياً بكلمة المرور ثم استدعاء `SessionManager.logout`.

### د. لوحة التحكم (`js/user-dashboard.js`)
*   تعتمد كلياً على `SessionManager` للتحقق من الأدوار (Guest vs. Real User).
*   تستخدم `SessionManager.isImpersonating()` لعرض علامة "وضع المسؤول" المائية (Watermark).

---

## 3. التوافقية والأمان
*   **التوافقية (Backward Compatibility)**: يظل `window.userSession` متاحاً عالمياً لضمان عدم تعطل الأجزاء القديمة من الكود، ولكن يمنع تعديله يدوياً؛ يجب استخدام `SessionManager`.
*   **الأمان**: يتم التحقق من كلمة المرور (Re-authentication) قبل:
    *   حفظ تغييرات الملف الشخصي (إذا وجدت كلمة مرور).
    *   حذف الحساب.
    *   بدء عملية انتحال الشخصية.
*   **تعدد المنصات**: منطق الخروج (`logout`) مدمج فيه استدعاءات `window.Android` لضمان مزامنة حالة الخروج مع تطبيق الأندرويد.
