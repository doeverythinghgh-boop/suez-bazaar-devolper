# دليل تطبيق نظام تحديد الموقع (BidStory Location)

هذا المستند يشرح بنية ونظام عمل تطبيق تحديد الموقع الجغرافي، والذي تم إعادة هيكلته ليعمل بنظام الوحدات (Modules) لضمان سهولة الصيانة والتطوير.

## هيكل المجلدات والملفات

تم تقسيم الكود إلى مجلد `js/location/` يحتوي على الملفات التالية:

| الملف | الوصف |
| :--- | :--- |
| `config.js` | يحتوي على تعريف الكائن الرئيسي `location_app` والثوابت (مثل الإحداثيات الافتراضية ومستوى التكبير). |
| `ui.js` | مسؤول عن عناصر الواجهة مثل شاشات التحميل (Loading) والتنبيهات (SweetAlert2). |
| `storage.js` | يدير تخزين الموقع المختار بشكل مؤقت في الذاكرة (`memory state`) والتحقق من صحة الإحداثيات. |
| `map.js` | يحتوي على منطق تهيئة خريطة Leaflet، إضافة العلامات (Markers)، وتحديد الموقع الأولي بناءً على معاملات الرابط (URL Params) أو الإحداثيات الافتراضية. |
| `gps.js` | يدير خدمة تحديد الموقع عبر GPS والتعامل مع الأذونات والأخطاء الناتجة عنها (يدوي فقط). |
| `utils.js` | يحتوي على وظائف إضافية مثل مشاركة الإحداثيات (نسخ أو فتح في الخرائط) وإعادة تعيين الموقع. |
| `core.js` | يحتوي على دالة التهيئة الرئيسية `init` التي تربط جميع الوحدات ببعضها. |
| `location_app.js` | هو نقطة الدخول (Entry Point) التي تطلق التطبيق عند تحميل الصفحة وتدير الأخطاء الشاملة. |

## المميزات الرئيسية

1. **نظام التحديث بدفعة واحدة (Batch Update)**: لا يتم الاتصال بالسيرفر عند اختيار الموقع في الخريطة. بدلاً من ذلك، يتم إرسال الإحداثيات للنافذة الأم ليتم حفظها "محلياً" في حقل مخفي داخل النموذج. تتم المزامنة مع السيرفر فقط عندما يقوم المستخدم بالضغط على زر "حفظ التغييرات" أو "إنشاء حساب" النهائي.
2. **أزرار تحكم محليّة**:
   - **زر حفظ (Save)**: يقوم بإرسال الإحداثيات للنافذة الأم وتحديث واجهة المستخدم (مثل تغيير لون زر الموقع).
   - **زر إغلاق (Close)**: زر دائري عصري (X) يغلق النافذة مع إبلاغ النافذة الأم بالحالة الحالية للموقع لضمان اتساق البيانات قبل الحفظ النهائي.
3. **دعم GPS يدوي**: تم تعطيل تحديد الموقع التلقائي عند فتح الخريطة لتجنب التشتيت. تفتح الخريطة دائماً على "الموقع المحفوظ" (إذا وجد) أو "الموقع الافتراضي - السويس" (إذا لم يوجد). يمكن للمستخدم الضغط على زر "تحديد" (GPS) في أي وقت للحصول على موقعه الحالي يدوياً.
4. **تصميم عصري مستجيب**: 
   - أزرار تحكم مرتبة في حاوية عائمة (Floating Panel) بزوايا مستديرة وظل عميق.
   - تظهر في صف واحد دائماً حتى على الهواتف مع دعم التمرير الأفقي (Horizontal Scroll).
5. **الاعتماد على السيرفر**: يتم استرجاع الموقع المحفوظ تلقائياً من بيانات المستخدم عند تسجيل الدخول لضمان وصول المندوب بدقة دون الحاجة للتخزين المحلي.
6. **خيارات المشاركة المتقدمة**: نسخ الإحداثيات أو فتح الموقع مباشرة في تطبيق الخرائط.

## التواصل مع النافذة الأم (Parent Communication)

يعمل التطبيق داخل `iframe` ويتواصل مع الصفحة الرئيسية عبر `window.postMessage`:
- **`LOCATION_SELECTED`**: تُرسل عند الضغط على زر "حفظ" وتحتوي على الإحداثيات (lat, lng) لتحديث النموذج في النافذة الأم.
- **`LOCATION_RESET`**: تُرسل عند الضغط على زر "إعادة ضبط" لتصفير الإحداثيات وتنبيه الواجهة الأمامية.
- **`CLOSE_LOCATION_MODAL`**: تُرسل عند الضغط على زر الإغلاق (X) لطلب غلق النافذة من الصفحة الأم.

### استرجاع الموقع الحالي
يتم تمرير موقع المستخدم الحالي للخريطة عبر معاملات الرابط (URL Parameters) بصيغة:
`location/LOCATION.html?lat=...&lng=...`
ويقوم ملف `map.js` بالتقاطها لضبط العرض الأولي والمؤشر (Marker).

## المعايير التقنية والمطابقة

- **بدون تأثيرات تمرير (No Hover)**: جميع التفاعلات تعتمد على النقرات أو الضغط المطول، دون الاعتماد على حالة Hover لضمان التوافق مع اللمس.
- **ألوان مسطحة (Flat Colors)**: الالتزام بالألوان الصلبة والابتعاد عن التدرجات اللونية (No Gradients).
- **التوثيق**: جميع الوظائف موثقة باستخدام **JSDoc** باللغة الإنجليزية، بينما نصوص الواجهة باللغة العربية بالكامل.
- **حجم الخط الصغير للحقوق**: تم تصغير نص الحقوق الخاص بالخريطة (`leaflet-control-attribution`) لزيادة المساحة المرئية.

## التوافق مع WebView (Android)

التطبيق مُحسّن للعمل داخل WebView في تطبيقات أندرويد:
- دعم كامل لـ Geolocation API
- timeout محسّن (30 ثانية) للحصول على إشارة GPS في الأماكن الضعيفة
- دعم الأحداث اللمسية (touch events) والضغط المطول
- تصميم مستجيب يتكيف مع جميع أحجام الشاشات

> [!IMPORTANT]
> عند استخدام التطبيق في WebView، تأكد من:
> - إضافة أذونات الموقع في `AndroidManifest.xml`
> - تفعيل JavaScript و Geolocation في إعدادات WebView
> - تطبيق `WebChromeClient` لمعالجة طلبات الموقع

## كيفية الاستخدام البرمجي

يتم تحميل الملفات بالترتيب التالي في `location\LOCATION.html`:
1. `js/location/config.js`
2. `js/location/ui.js`
3. `js/location/storage.js`
4. `js/location/map.js`
5. `js/location/gps.js`
6. `js/location/utils.js`
7. `js/location/core.js`
8. `location_app.js`

> [!IMPORTANT]
> المتطلبات الخارجية: Leaflet JS, SweetAlert2, Material Icons.
