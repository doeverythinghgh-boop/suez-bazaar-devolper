<style>
  .products-container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .page-header {
    text-align: center;
    color: white;
    margin-bottom: 30px;
  }

  .page-header h1 {
    font-size: 2.5rem;
    margin-bottom: 10px;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  }

  .page-header p {
    font-size: 1.1rem;
    opacity: 0.9;
  }

  /* شريط البحث */
  .search-container {
    background: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  }

  .search-form {
    display: grid;
    grid-template-columns: 1fr auto auto;
    gap: 15px;
    align-items: end;
  }

  @media (max-width: 768px) {
    .search-form {
      grid-template-columns: 1fr;
    }
  }

  .form-group {
    display: flex;
    flex-direction: column;
  }

  .form-label {
    font-weight: 600;
    margin-bottom: 8px;
    color: #2c3e50;
  }

  .form-input,
  .form-select {
    padding: 12px 15px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 16px;
    transition: all 0.3s ease;
  }

  .form-input:focus,
  .form-select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .search-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px 25px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .search-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
  }

  /* شبكة البطاقات */
  .products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 25px;
    margin-bottom: 40px;
  }

  /* البطاقة */
  .product-card {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .product-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
  }

  .product-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 3rem;
  }

  .product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .product-content {
    padding: 20px;
  }

  .product-name {
    font-size: 1.2rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 15px;
    line-height: 1.4;
  }

  .product-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
  }

  .btn {
    flex: 1;
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .btn-edit {
    background: #3498db;
    color: white;
  }

  .btn-edit:hover {
    background: #2980b9;
  }

  .btn-delete {
    background: #e74c3c;
    color: white;
  }

  .btn-delete:hover {
    background: #c0392b;
  }

  /* حالات التحميل والفراغ */
  .loading-state,
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  }

  .loading-state i {
    font-size: 3rem;
    color: #667eea;
    margin-bottom: 20px;
  }

  .empty-state i {
    font-size: 4rem;
    color: #bdc3c7;
    margin-bottom: 20px;
  }

  .loading-state p,
  .empty-state p {
    font-size: 1.2rem;
    color: #7f8c8d;
    margin-bottom: 15px;
  }

  /* نافذة تفاصيل المنتج */
  .product-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }

  .modal-content {
    background: transparent;

    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-header {
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-title {
    font-size: 1.5rem;
    color: #2c3e50;
    font-weight: 600;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #7f8c8d;
    cursor: pointer;
  }

  .modal-body {
    padding: 20px;
  }

  .modal-image {
    width: 100%;
    height: 250px;
    object-fit: cover;
    border-radius: 10px;
    margin-bottom: 20px;
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 4rem;
  }

  .modal-details {
    display: grid;
    gap: 15px;
  }

  .detail-item {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid #f8f9fa;
  }

  .detail-label {
    font-weight: 600;
    color: #2c3e50;
  }

  .detail-value {
    color: #7f8c8d;
    text-align: left;
  }

  /* التجاوب مع الأجهزة المختلفة */
  @media (max-width: 768px) {
    .products-grid {
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
    }

    .page-header h1 {
      font-size: 2rem;
    }
  }

  @media (max-width: 480px) {
    .products-grid {
      grid-template-columns: 1fr;
    }

    .product-actions {
      flex-direction: column;
    }
  }
</style>

<div class="products-container">

  <!-- Search and Filter Bar -->
  <div class="search-container">
    <form class="search-form" id="search-form">
      <div class="form-group">
        <label class="form-label">بحث بالاسم</label>
        <input type="text" class="form-input" id="search-input" placeholder="ابحث باسم المنتج..." />
      </div>
      <div class="form-group">
        <label class="form-label">الفئة الرئيسية</label>
        <select class="form-select" id="main-category-filter">
          <option value="">جميع الفئات</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">الفئة الفرعية</label>
        <select class="form-select" id="sub-category-filter">
          <option value="">جميع الفئات الفرعية</option>
        </select>
      </div>
      <button type="submit" class="search-btn">
        <i class="fas fa-search"></i> بحث
      </button>
    </form>
  </div>

  <!-- Cards Container -->
  <div class="products-grid" id="products-grid">
    <!-- Cards will be populated here via JS -->
  </div>

  <!-- Loading State -->
  <div class="loading-state" id="loading-state" style="display: none">
    <i class="fas fa-spinner fa-spin"></i>
    <p>جاري تحميل المنتجات...</p>
  </div>

  <!-- Empty State -->
  <div class="empty-state" id="empty-state" style="display: none">
    <i class="fas fa-box-open"></i>
    <p>لا توجد منتجات لعرضها</p>
    <p>قم بإضافة منتجك الأول للبدء</p>
  </div>
</div>

<script>
  /**
   * @fileoverview User Products Management Page (product2Me)
   * @description Handles listing, searching, editing, and deleting user's products.
   */

  // Product Data
  let myProducts = []; // To be populated from actual source

  // Main DOM Elements
  const productsGrid = document.getElementById("products-grid");
  const loadingState = document.getElementById("loading-state");
  const emptyState = document.getElementById("empty-state");
  const searchForm = document.getElementById("search-form");
  const searchInput = document.getElementById("search-input");
  const mainCategoryFilter = document.getElementById("main-category-filter");
  const subCategoryFilter = document.getElementById("sub-category-filter");

  // Base Image URL
  const CLOUDFLARE_BASE_URL = "https://pub-e828389e2f1e484c89d8fb652c540c12.r2.dev/";

  /**
   * @function loadProducts
   * @description Fetches the user's products from server with optional filters.
   * @param {object} [filters={}] - Optional filters object containing searchName, MainCategory, SubCategory
   */
  async function loadProducts(filters = {}) {
    console.log("%c[Products] Loading products with filters:", "color: blue;", filters);
    // Show loading state
    productsGrid.innerHTML = "";
    loadingState.style.display = "block";
    emptyState.style.display = "none";

    // Fetch products from database with filters (server-side filtering)
    myProducts = await getProductsByUser(userSession.user_key, filters);

    console.log(`%c[Products] Loaded ${myProducts ? myProducts.length : 0} products`, "color: green;");

    // Check if no products found
    if (!myProducts || myProducts.length === 0) {
      showEmptyState();
      return;
    }

    // Render products (already filtered by server)
    renderProducts(myProducts);
    loadingState.style.display = "none";
  }

  /**
   * @function showEmptyState
   * @description Displays the empty state UI when no products are found.
   */
  function showEmptyState() {
    loadingState.style.display = "none";
    emptyState.style.display = "block";
    productsGrid.innerHTML = "";
  }

  /**
   * @function renderProducts
   * @description Renders the list of products into the grid.
   * @param {Array} products - Array of product objects.
   */
  function renderProducts(products) {
    productsGrid.innerHTML = "";

    products.forEach((product) => {
      const card = createProductCard(product);
      productsGrid.appendChild(card);
    });
  }

  /**
   * @function createProductCard
   * @description Creates a DOM element for a single product card.
   * @param {object} product - Product data object.
   * @returns {HTMLElement} The product card element.
   */
  function createProductCard(product) {
    const card = document.createElement("div");
    card.className = "product-card";
    card.setAttribute("data-product-id", product.id);

    // Get the first image
    const firstImage = product.ImageName
      ? product.ImageName.split(",")[0].trim()
      : null;

    const imageUrl = firstImage ? CLOUDFLARE_BASE_URL + firstImage : null;

    // Truncate product name if too long
    const displayName =
      product.productName.length > 15
        ? product.productName.substring(0, 15) + "..."
        : product.productName;

    card.innerHTML = `
                <div class="product-image">
                    ${imageUrl
        ? `<img src="${imageUrl}" alt="${product.productName}" loading="lazy" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\'fas fa-box\\'></i>';" />`
        : '<i class="fas fa-box"></i>'
      }
                </div>
                <div class="product-content">
                    <h3 class="product-name">${displayName}</h3>
                    <div class="product-actions">
                        <button class="btn btn-edit" onclick="editProduct(${product.id
      })">
                            <i class="fas fa-edit"></i> تعديل
                        </button>
                        <button class="btn btn-delete" onclick="deleteProduct(${product.id
      })">
                            <i class="fas fa-trash"></i> حذف
                        </button>
                    </div>
                </div>
            `;

    // Add click event to show details
    card.addEventListener("click", (e) => {
      // Check that click was not on edit or delete buttons
      if (!e.target.closest(".btn")) {
        // Log product data to console instead of showing modal directly (as per logic)
        console.log(
          "%c[Developer] Product card clicked. Data:",
          "color: #007bff; font-weight: bold;",
          product
        );
        // Prepare product data for modal/view
        const productDataForModal = {
          product_key: product.product_key,
          productName: product.productName,
          user_key: product.user_key,
          pricePerItem: product.product_price,
          original_price: product.original_price,
          imageSrc: product.ImageName
            ? product.ImageName.split(",").map(
              (name) => `${CLOUDFLARE_BASE_URL}${name.trim()}`
            )
            : [],
          availableQuantity: product.product_quantity,
          sellerMessage: product.user_message,
          description: product.product_description,
          serviceType: product.serviceType,
        };
        productSession = [productDataForModal, false];
        productViewLayout(product.serviceType);
      }
    });

    return card;
  }

  /**
   * @function editProduct
   * @description Handles product editing logic (Category selection -> Edit Page).
   * @param {number} productId - ID of the product to edit.
   */
  async function editProduct(productId) {
    const product = myProducts.find((p) => p.id === productId);
    if (!product) {
      console.error(
        "%c[Products] Product not found:",
        "color: red;",
        productId
      );
      return;
    }

    console.log("%c[Products] Editing product:", "color: blue;", product);
    const result = await CategoryModal.show(product.MainCategory, product.SubCategory, "Edit Product Market");
    if (result.status === 'success') {
      console.log('Selected:', result.mainId, result.subId);

      // result.mainId, result.subId are selected category IDs

      product.MainCategory = result.mainId;
      product.SubCategory = result.subId;

      productSession = product;
      mainLoader("./pages/productEdit.html", "index-product-container", 0, undefined, "showHomeIcon", true);
    }
  }

  /**
   * @function deleteProduct
   * @description Handles product deletion logic with confirmation.
   * @param {number} productId - ID of the product to delete.
   */
  async function deleteProduct(productId) {
    const product = myProducts.find((p) => p.id === productId);
    console.log("%c[Products] Deleting product:", "color: red;", product);
    Swal.fire({
      title: 'هل أنت متأكد؟',
      text: `سيتم حذف المنتج "${product.productName}" بشكل نهائي. لا يمكن التراجع عن هذا الإجراء.`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'نعم، احذفه!',
      cancelButtonText: 'إلغاء',
      showLoaderOnConfirm: true,
      preConfirm: async () => {
        try {
          if (product.ImageName) {
            const imageNames = product.ImageName.split(',').filter(name => name);
            if (imageNames.length > 0) {
              await Promise.all(imageNames.map(name =>
                deleteFile2cf(name).catch(err => console.error(`[Delete] Failed to delete image ${name}:`, err))
              ));
            }
          }
          const dbResult = await deleteProduct_(product.product_key);
          console.log("%c[Products] Deleting product:", "color: red;", dbResult);
          if (dbResult && dbResult.error) throw new Error(dbResult.error);
          return true;
        } catch (error) {
          Swal.showValidationMessage(`فشل الحذف: ${error.message}`);
          return false;
        }
      },
      allowOutsideClick: () => !Swal.isLoading()
    }).then((result) => {
      if (result.isConfirmed) {
        // Remove from local array
        const index = myProducts.findIndex((p) => p.id === productId);
        if (index > -1) {
          myProducts.splice(index, 1);
        }

        // Reload display
        loadProducts();

        Swal.fire("تم الحذف!", "تم حذف المنتج بنجاح", "success");

      }
    });
  }
  /**
   * @function loadCategoryFilters
   * @description Fetches categories from `shared/list.json` and populates main/sub category filters.
   *   Sets up event listeners to update sub-categories when main category changes.
   * @returns {Promise<void>}
   * @throws {Error} - If loading categories fails.
   */
  async function loadCategoryFilters() {
    console.log("[Products] Starting to load category filters from 'list.json'.");
    try {
      const response = await fetch("../shared/list.json");
      if (!response.ok) throw new Error("Failed to load category filters");
      const data = await response.json();
      const categories = data.categories;

      console.log("[Products] 'list.json' loaded and parsed successfully.", categories);

      // Clear existing options except the first one
      mainCategoryFilter.innerHTML = '<option value="">جميع الفئات</option>';

      // Populate Main Category Filter
      categories.forEach((category) => {
        const option = document.createElement("option");
        option.value = category.id;
        option.textContent = category.title;
        // Store subcategories in dataset
        option.dataset.subcategories = JSON.stringify(category.subcategories || []);
        mainCategoryFilter.appendChild(option);
      });

      // Add event on Main Category change
      console.log("[Products] Attaching 'change' event listener to the main category filter.");
      mainCategoryFilter.addEventListener("change", () => {
        // Reset Sub Categories
        subCategoryFilter.innerHTML = '<option value="">جميع الفئات الفرعية</option>';
        const selectedOption = mainCategoryFilter.options[mainCategoryFilter.selectedIndex];

        if (selectedOption.value) {
          const subcategories = JSON.parse(selectedOption.dataset.subcategories);
          if (subcategories.length > 0) {
            subcategories.forEach((sub) => {
              const subOption = document.createElement("option");
              subOption.value = sub.id;
              subOption.textContent = sub.title;
              subCategoryFilter.appendChild(subOption);
            });
            subCategoryFilter.disabled = false; // Enable sub category filter
          } else {
            subCategoryFilter.disabled = true; // Disable if no sub categories
          }
        } else {
          subCategoryFilter.innerHTML = '<option value="">جميع الفئات الفرعية</option>';
          subCategoryFilter.disabled = true; // Disable
        }
        console.log("[Products] Sub-category filter updated based on main category selection.");
      });
    } catch (error) {
      console.error("%c[Products] Error loading category filters:", "color: red;", error);
    }
    console.log("[Products] Category filters have been fully loaded and configured.");
  }
  /**
   * @function filterProducts
   * @description Collects search criteria and fetches filtered products from server.
   */
  async function filterProducts() {
    // Collect search criteria
    const searchName = searchInput.value.trim();
    const mainCategory = mainCategoryFilter.value;
    const subCategory = subCategoryFilter.value;

    console.log("%c[Products] Searching with criteria:", "color: blue;", {
      searchName,
      mainCategory,
      subCategory
    });

    // Build filters object (only include non-empty values)
    const filters = {};
    if (searchName) filters.searchName = searchName;
    if (mainCategory) filters.MainCategory = mainCategory;
    if (subCategory) filters.SubCategory = subCategory;

    // Load products with server-side filtering
    await loadProducts(filters);
  }


  // Initialize immediately (not waiting for DOMContentLoaded since page is loaded via mainLoader)
  // Load category filters on page load
  loadCategoryFilters();

  // Search Event - only load products when search button is clicked
  searchForm.addEventListener("submit", function (e) {
    e.preventDefault();
    filterProducts();
  });

  // Make functions globally available
  window.editProduct = editProduct;
  window.deleteProduct = deleteProduct;
</script>