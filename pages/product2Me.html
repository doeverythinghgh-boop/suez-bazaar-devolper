<style>
  /* Container */
  .p2m-products-container {
    margin: 40px;
    background-color: transparent;
    animation: p2m-slide-down 0.5s ease-out forwards;
    text-align: right;
  }

  @keyframes p2m-slide-down {
    from {
      transform: translateY(-50px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  /* Search Container */
  .p2m-search-container {
    background: transparent;
    margin-bottom: 30px;
  }

  /* Search Input Container - matches search.html */
  .p2m-input-container {
    display: flex;
    align-items: center;
    position: relative;
    border: 1px solid var(--border-color-input);
    border-radius: 50px;
    overflow: hidden;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    background-color: var(--bg-color-light);
    flex-grow: 1;
  }

  .p2m-input-container:focus-within {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px var(--primary-color-light);
  }

  .p2m-input-icon {
    font-style: normal;
    font-weight: bold;
    color: var(--primary-color);
    font-size: 1rem;
    transition: color 0.3s ease;
    padding-right: 20px;
  }

  .p2m-input-icon.fa-search::before {
    content: "txt";
    font-family: "Tajawal", sans-serif;
  }

  .p2m-input-icon.fa-search {
    font-family: "Font Awesome 5 Free";
  }

  .p2m-input-container:focus-within .p2m-input-icon {
    color: var(--primary-color);
  }

  .p2m-input-container input {
    flex-grow: 1;
    border: none;
    padding: 15px 20px;
    font-size: 1.1rem;
    outline: none;
    background-color: transparent;
    width: 100%;
    box-sizing: border-box;
    font-family: "Tajawal", sans-serif;
  }

  .p2m-form-group {
    position: relative;
    display: flex;
    align-items: center;
  }

  .p2m-filter-icon {
    position: absolute;
    right: 18px;
    color: var(--primary-color);
    pointer-events: none;
    transition: color 0.3s ease;
  }

  .p2m-form-group:focus-within .p2m-filter-icon {
    color: var(--primary-color);
  }

  .p2m-form-input,
  .p2m-form-select {
    width: 100%;
    padding: 12px 45px 12px 20px;
    border: 1px solid var(--border-color-input);
    border-radius: 50px;
    background-color: var(--bg-color-light);
    font-family: "Tajawal", sans-serif;
    font-size: 0.95rem;
    color: var(--text-color-medium);
    cursor: pointer;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
  }

  .p2m-form-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='var(--text-color-dark)' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: left 0.75rem center;
    background-size: 16px 12px;
  }

  .p2m-form-input:focus,
  .p2m-form-select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px var(--primary-color-light);
  }

  .p2m-search-btn {
    flex-shrink: 0;
    background: transparent;
    color: var(--primary-color);
    border: 1px solid var(--border-color-input);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
    box-shadow: var(--shadow-interactive);
    font-family: "Tajawal", sans-serif;
  }

  .p2m-search-btn:active {
    transform: scale(0.98);
  }

  /* Pulse animation for search button */
  @keyframes p2m-pulse-animation {
    0% {
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
    }
    70% {
      transform: scale(1.05);
      box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
    }
    100% {
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
    }
  }

  .p2m-search-btn.is-pulsing {
    animation: p2m-pulse-animation 1.5s infinite;
  }

  /* Products Grid */
  .p2m-products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
  }

  /* Product Card */
  .p2m-product-card {
    background: var(--bg-color-white);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: var(--shadow-soft);
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    display: flex;
    flex-direction: column;
    text-align: right;
  }

  .p2m-product-card:active {
    transform: scale(0.98);
  }

  .p2m-product-image {
    width: 100%;
    height: 160px;
    object-fit: cover;
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 3rem;
  }

  .p2m-product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .p2m-product-content {
    padding: 15px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }

  .p2m-product-name {
    font-size: 1rem;
    font-weight: bold;
    color: var(--text-color-dark);
    margin: 0 0 15px 0;
    line-height: 1.4;
  }

  .p2m-product-actions {
    display: flex;
    gap: 10px;
    margin-top: auto;
  }

  .p2m-btn i {
    font-size: 1.2rem;
  }

  .p2m-btn {
    flex: 1;
    padding: 8px 10px;
    border: 1px solid;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex !important;
    flex-direction: column !important;
    align-items: center;
    justify-content: center;
    gap: 4px;
    font-family: "Tajawal", sans-serif;
  }

  .p2m-btn-edit {
    background: transparent;
    color: #3498db;
    border-color: #3498db;
  }

  .p2m-btn-edit:active {
    transform: scale(0.95);
    background: rgba(52, 152, 219, 0.1);
  }

  .p2m-btn-delete {
    background: transparent;
    color: #e74c3c;
    border-color: #e74c3c;
  }

  .p2m-btn-delete:active {
    transform: scale(0.95);
    background: rgba(231, 76, 60, 0.1);
  }

  /* Loading and Empty States */
  .p2m-loading-state,
  .p2m-empty-state {
    text-align: center;
    padding: 60px 20px;
    background: var(--bg-color-white);
    border-radius: 12px;
    box-shadow: var(--shadow-soft);
  }

  .p2m-loading-state i {
    font-size: 3rem;
    color: var(--primary-color);
    margin-bottom: 20px;
  }

  .p2m-empty-state i {
    font-size: 4rem;
    color: #bdc3c7;
    margin-bottom: 20px;
  }

  .p2m-loading-state p,
  .p2m-empty-state p {
    font-size: 1.2rem;
    color: #7f8c8d;
    margin-bottom: 15px;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .p2m-products-container {
      margin: 20px;
    }

    .p2m-products-grid {
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 15px;
    }
  }

  @media (max-width: 480px) {
    .p2m-products-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<div class="p2m-products-container" id="p2m-products-container">

  <!-- Search and Filter Bar -->
  <div class="p2m-search-container" id="p2m-search-container">
    <table id="p2m-search-table" style="width: 100%; border-spacing: 10px; table-layout: fixed">
      <tbody id="p2m-search-tbody">
        <!-- First Row: Main and Sub Categories -->
        <tr id="p2m-filters-row">
          <td id="p2m-main-category-cell">
            <div class="p2m-form-group" id="p2m-main-category-group">
              <i class="fas fa-layer-group p2m-filter-icon" id="p2m-main-category-icon"></i>
              <select class="p2m-form-select" id="main-category-filter" aria-label="الفئة الرئيسية">
                <option value="" id="p2m-main-category-default">كل الاسواق الرئيسية</option>
              </select>
            </div>
          </td>
          <td id="p2m-sub-category-cell">
            <div class="p2m-form-group" id="p2m-sub-category-group">
              <i class="fas fa-tags p2m-filter-icon" id="p2m-sub-category-icon"></i>
              <select class="p2m-form-select" id="sub-category-filter" aria-label="الفئة الفرعية">
                <option value="" id="p2m-sub-category-default">كل الاسواق الفرعية</option>
              </select>
            </div>
          </td>
        </tr>
        <!-- Second Row: Search Field -->
        <tr id="p2m-search-input-row">
          <td colspan="2" id="p2m-search-input-cell">
            <div class="p2m-input-container" id="p2m-input-container" style="padding-right: 0px">
              <i class="fas fa-search p2m-input-icon" id="p2m-search-icon" aria-hidden="true"></i>
              <input type="search" id="search-input" placeholder="اكتب اسم المنتج الذي تبحث عنه..." autocomplete="off" />
            </div>
          </td>
        </tr>
        <!-- Third Row: Sort Filter and Search Button -->
        <tr id="p2m-action-row">
          <td id="p2m-sort-cell">
            <div class="p2m-form-group" id="p2m-sort-group">
              <i class="fas fa-sort-amount-down p2m-filter-icon" id="p2m-sort-icon"></i>
              <select class="p2m-form-select" id="sort-filter" aria-label="ترتيب حسب">
                <option value="default" id="p2m-sort-default">الترتيب الافتراضي</option>
                <option value="price-asc" id="p2m-sort-price-asc">الأقل سعراً</option>
                <option value="price-desc" id="p2m-sort-price-desc">الأعلى سعراً</option>
              </select>
            </div>
          </td>
          <td id="p2m-search-btn-cell">
            <button type="button" class="p2m-search-btn" id="search-btn" aria-label="بحث" style="width: 100%; height: 50px; border-radius: 50px">
              <i class="fas fa-search" id="p2m-search-btn-icon"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Cards Container -->
  <div class="p2m-products-grid" id="products-grid">
    <!-- Cards will be populated here via JS -->
  </div>

  <!-- Loading State -->
  <div class="p2m-loading-state" id="loading-state" style="display: none">
    <i class="fas fa-spinner fa-spin" id="p2m-loading-icon"></i>
    <p id="p2m-loading-text">جاري تحميل المنتجات...</p>
  </div>

  <!-- Empty State -->
  <div class="p2m-empty-state" id="empty-state" style="display: none">
    <i class="fas fa-box-open" id="p2m-empty-icon"></i>
    <p id="p2m-empty-text-1">لا توجد منتجات لعرضها</p>
    <p id="p2m-empty-text-2">قم بإضافة منتجك الأول للبدء</p>
  </div>
</div>

<script>
  /**
   * @fileoverview User Products Management Page (product2Me)
   * @description Handles listing, searching, editing, and deleting user's products.
   */

  // Product Data
  let myProducts = []; // To be populated from actual source

  // Main DOM Elements
  const productsGrid = document.getElementById("products-grid");
  const loadingState = document.getElementById("loading-state");
  const emptyState = document.getElementById("empty-state");
  const searchInput = document.getElementById("search-input");
  const mainCategoryFilter = document.getElementById("main-category-filter");
  const subCategoryFilter = document.getElementById("sub-category-filter");

  // Base Image URL
  const CLOUDFLARE_BASE_URL = "https://pub-e828389e2f1e484c89d8fb652c540c12.r2.dev/";

  /**
   * @function loadProducts
   * @description Fetches the user's products from server with optional filters.
   * @param {object} [filters={}] - Optional filters object containing searchTerm, MainCategory, SubCategory
   */
  async function loadProducts(filters = {}) {
    console.log("%c[Products] جارٍ تحميل المنتجات بالفلاتر:", "color: blue;", filters);
    // Show loading state
    productsGrid.innerHTML = "";
    loadingState.style.display = "block";
    emptyState.style.display = "none";

    // Build URL params
    const params = new URLSearchParams();
    params.append("user_key", userSession.user_key || ""); // Filter by current user
    
    // Normalize Arabic text and use searchTerm
    if (filters.searchTerm) {
       params.append("searchTerm", normalizeArabicText(filters.searchTerm));
    }
    if (filters.MainCategory) params.append("MainCategory", filters.MainCategory);
    if (filters.SubCategory) params.append("SubCategory", filters.SubCategory);

    // Reuse existing API endpoint
    const url = `${baseURL}/api/products?${params.toString()}`;

    try {
       const response = await fetch(url);
       if (!response.ok) throw new Error("فشل جلب المنتجات");
       myProducts = await response.json();

       console.log(`%c[Products] تم تحميل ${myProducts ? myProducts.length : 0} منتجات`, "color: green;");

       // Check if no products found
       if (!myProducts || myProducts.length === 0) {
         showEmptyState();
         return;
       }

       // Render products (already filtered by server)
       renderProducts(myProducts);
       loadingState.style.display = "none";

    } catch (error) {
       console.error("[Products] خطأ في جلب المنتجات:", error);
       // Hide loader, but show no error to user (as requested)
       loadingState.style.display = "none"; 
       // Optionally show empty state if fetch failed to avoid broken UI
       if(productsGrid.innerHTML === "") {
          showEmptyState(); 
       }
    }
  }

  /**
   * @function showEmptyState
   * @description Displays the empty state UI when no products are found.
   */
  function showEmptyState() {
    loadingState.style.display = "none";
    emptyState.style.display = "block";
    productsGrid.innerHTML = "";
  }

  /**
   * @function renderProducts
   * @description Renders the list of products into the grid with optional sorting.
   * @param {Array} products - Array of product objects.
   */
  function renderProducts(products) {
    productsGrid.innerHTML = "";

    // Apply sorting based on sort filter
    const sortFilter = document.getElementById("sort-filter");
    const sortValue = sortFilter ? sortFilter.value : "default";
    let sortedProducts = [...products];

    if (sortValue === "price-asc") {
      sortedProducts.sort((a, b) => parseFloat(a.product_price) - parseFloat(b.product_price));
    } else if (sortValue === "price-desc") {
      sortedProducts.sort((a, b) => parseFloat(b.product_price) - parseFloat(a.product_price));
    }

    sortedProducts.forEach((product) => {
      const card = createProductCard(product);
      productsGrid.appendChild(card);
    });
  }

  /**
   * @function createProductCard
   * @description Creates a DOM element for a single product card.
   * @param {object} product - Product data object.
   * @returns {HTMLElement} The product card element.
   */
  function createProductCard(product) {
    const card = document.createElement("div");
    card.className = "p2m-product-card";
    card.setAttribute("data-product-id", product.id);

    // Get the first image
    const firstImage = product.ImageName
      ? product.ImageName.split(",")[0].trim()
      : null;

    const imageUrl = firstImage ? CLOUDFLARE_BASE_URL + firstImage : null;

    // Truncate product name if too long
    const displayName =
      product.productName.length > 15
        ? product.productName.substring(0, 15) + "..."
        : product.productName;

    card.innerHTML = `
                <div class="p2m-product-image">
                    ${imageUrl
        ? `<img src="${imageUrl}" alt="${product.productName}" loading="lazy" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\'fas fa-box\\'></i>';" />`
        : '<i class="fas fa-box"></i>'
      }
                </div>
                <div class="p2m-product-content">
                    <h3 class="p2m-product-name">${displayName}</h3>
                    <div class="p2m-product-actions">
                        <button class="p2m-btn p2m-btn-edit" onclick="editProduct(${product.id})">
                            <i class="fas fa-edit"></i> <span>تعديل</span>
                        </button>
                        <button class="p2m-btn p2m-btn-delete" onclick="deleteProduct(${product.id})">
                            <i class="fas fa-trash"></i> <span>حذف</span>
                        </button>
                    </div>
                </div>
            `;

    // Add click event to show details
    card.addEventListener("click", (e) => {
      // Check that click was not on edit or delete buttons
      if (!e.target.closest(".p2m-btn")) {
        // Log product data to console instead of showing modal directly (as per logic)
        console.log(
          "%c[Developer] تم النقر على بطاقة المنتج. البيانات:",
          "color: #007bff; font-weight: bold;",
          product
        );
        // Prepare product data for modal/view
        const productDataForModal = {
          product_key: product.product_key,
          productName: product.productName,
          user_key: product.user_key,
          pricePerItem: product.product_price,
          original_price: product.original_price,
          imageSrc: product.ImageName
            ? product.ImageName.split(",").map(
              (name) => `${CLOUDFLARE_BASE_URL}${name.trim()}`
            )
            : [],
          availableQuantity: product.product_quantity,
          sellerMessage: product.user_message,
          description: product.product_description,
          serviceType: product.serviceType,
        };
        productSession = [productDataForModal, false];
        productViewLayout(product.serviceType);
      }
    });

    return card;
  }

  /**
   * @function editProduct
   * @description Handles product editing logic (Category selection -> Edit Page).
   * @param {number} productId - ID of the product to edit.
   */
  async function editProduct(productId) {
    const product = myProducts.find((p) => p.id === productId);
    if (!product) {
      console.error(
        "%c[Products] المنتج غير موجود:",
        "color: red;",
        productId
      );
      return;
    }

    console.log("%c[Products] تعديل المنتج:", "color: blue;", product);
    const result = await CategoryModal.show(product.MainCategory, product.SubCategory, "السوق الحالي للمنتج");
    if (result.status === 'success') {
      console.log('تم الاختيار:', result.mainId, result.subId);

      // result.mainId, result.subId are selected category IDs

      product.MainCategory = result.mainId;
      product.SubCategory = result.subId;
      productSession = product;
      mainCategorySelectToAdd=result.mainId;
      subCategorySelectToAdd=result.subId;

    productAddSetType();

    }
  }

  /**
   * @function deleteProduct
   * @description Handles product deletion logic with confirmation.
   * @param {number} productId - ID of the product to delete.
   */
  async function deleteProduct(productId) {
    const product = myProducts.find((p) => p.id === productId);
    console.log("%c[Products] حذف المنتج:", "color: red;", product);
    Swal.fire({
      title: 'هل أنت متأكد؟',
      text: `سيتم حذف المنتج "${product.productName}" بشكل نهائي. لا يمكن التراجع عن هذا الإجراء.`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'نعم، احذفه!',
      cancelButtonText: 'إلغاء',
      showLoaderOnConfirm: true,
      preConfirm: async () => {
        try {
          if (product.ImageName) {
            const imageNames = product.ImageName.split(',').filter(name => name);
            if (imageNames.length > 0) {
              await Promise.all(imageNames.map(name =>
                deleteFile2cf(name).catch(err => console.error(`[Delete] فشل حذف الصورة ${name}:`, err))
              ));
            }
          }
          const dbResult = await deleteProduct_(product.product_key);
          console.log("%c[Products] حذف المنتج:", "color: red;", dbResult);
          if (dbResult && dbResult.error) throw new Error(dbResult.error);
          return true;
        } catch (error) {
          Swal.showValidationMessage(`فشل الحذف: ${error.message}`);
          return false;
        }
      },
      allowOutsideClick: () => !Swal.isLoading()
    }).then((result) => {
      if (result.isConfirmed) {
        // Remove from local array
        const index = myProducts.findIndex((p) => p.id === productId);
        if (index > -1) {
          myProducts.splice(index, 1);
        }

        // Reload display
        loadProducts();

        Swal.fire("تم الحذف!", "تم حذف المنتج بنجاح", "success");

      }
    });
  }
  /**
   * @function loadCategoryFilters
   * @description Fetches categories from `shared/list.json` and populates main/sub category filters.
   *   Sets up event listeners to update sub-categories when main category changes.
   * @returns {Promise<void>}
   * @throws {Error} - If loading categories fails.
   */
  async function loadCategoryFilters() {
    console.log("[Products] بدء تحميل فلاتر الفئات من 'list.json'.");
    try {
      const response = await fetch("../shared/list.json");
      if (!response.ok) throw new Error("Failed to load category filters");
      const data = await response.json();
      const categories = data.categories;

      console.log("[Products] تم تحميل وتحليل 'list.json' بنجاح.", categories);

      // Clear existing options except the first one
      mainCategoryFilter.innerHTML = '<option value="">جميع الفئات</option>';

      // Populate Main Category Filter
      categories.forEach((category) => {
        const option = document.createElement("option");
        option.value = category.id;
        option.textContent = category.title;
        // Store subcategories in dataset
        option.dataset.subcategories = JSON.stringify(category.subcategories || []);
        mainCategoryFilter.appendChild(option);
      });

      // Add event on Main Category change
      console.log("[Products] ربط حدث 'change' بفلتر الفئة الرئيسية.");
      mainCategoryFilter.addEventListener("change", () => {
        // Reset Sub Categories
        subCategoryFilter.innerHTML = '<option value="">جميع الفئات الفرعية</option>';
        const selectedOption = mainCategoryFilter.options[mainCategoryFilter.selectedIndex];

        if (selectedOption.value) {
          const subcategories = JSON.parse(selectedOption.dataset.subcategories);
          if (subcategories.length > 0) {
            subcategories.forEach((sub) => {
              const subOption = document.createElement("option");
              subOption.value = sub.id;
              subOption.textContent = sub.title;
              subCategoryFilter.appendChild(subOption);
            });
            subCategoryFilter.disabled = false; // Enable sub category filter
          } else {
            subCategoryFilter.disabled = true; // Disable if no sub categories
          }
        } else {
          subCategoryFilter.innerHTML = '<option value="">جميع الفئات الفرعية</option>';
          subCategoryFilter.disabled = true; // Disable
        }
        console.log("[Products] تم تحديث فلتر الفئة الفرعية بناءً على اختيار الفئة الرئيسية.");
      });
    } catch (error) {
      console.error("%c[Products] خطأ في تحميل فلاتر الفئات:", "color: red;", error);
    }
    console.log("[Products] تم تحميل وتكوين فلاتر الفئات بالكامل.");
  }
  /**
   * @function filterProducts
   * @description Collects search criteria and fetches filtered products from server.
   */
  async function filterProducts() {
    // Collect search criteria
    const searchTerm = searchInput.value.trim();
    const mainCategory = mainCategoryFilter.value;
    const subCategory = subCategoryFilter.value;

    console.log("%c[Products] بحث بالمعايير:", "color: blue;", {
      searchTerm,
      mainCategory,
      subCategory
    });

    // Build filters object (only include non-empty values)
    const filters = {};
    if (searchTerm) filters.searchTerm = searchTerm;
    if (mainCategory) filters.MainCategory = mainCategory;
    if (subCategory) filters.SubCategory = subCategory;

    // Load products with server-side filtering
    await loadProducts(filters);
  }


  // Initialize immediately (not waiting for DOMContentLoaded since page is loaded via mainLoader)
  // Load category filters on page load
  loadCategoryFilters();

  // Sort filter change event
  const sortFilter = document.getElementById("sort-filter");
  if (sortFilter) {
    sortFilter.addEventListener("change", () => {
      // Re-render current products with new sort
      if (myProducts && myProducts.length > 0) {
        renderProducts(myProducts);
      }
    });
  }

  // Search Event - only load products when search button is clicked
  const searchBtn = document.getElementById("search-btn");
  if (searchBtn) {
    searchBtn.addEventListener("click", function () {
      filterProducts();
    });
  }

  // Make functions globally available
  window.editProduct = editProduct;
  window.deleteProduct = deleteProduct;
</script>