<style>
    /*
    * ========================================
    * ProductView Styles (productView_)
    * ========================================
    */



    .productView_modal_content {
        padding: 20px;
        max-width: 700px;

        animation: productView_fadeInScaleUp 0.4s ease-out forwards;
    }

    #productView_image {
        width: 100%;
        animation: productView_zoomInEffect 0.5s ease-out 0.1s forwards;
        opacity: 0;
        /* يبدأ مخفياً */
        max-height: 400px;
        /* تحديد ارتفاع أقصى */
        border-radius: 8px;
        background-color: var(--bg-color-light, #f9f9f9);
        /* خلفية للصورة */
    }

    #productView_details_container {
        animation: productView_slideInFromTop 0.5s ease-out 0.2s forwards;
        opacity: 0;
        /* يبدأ مخفياً */
        text-align: right;
    }

    /* حركة متدرجة للتفاصيل */
    #productView_details_container>* {
        animation: productView_slideInFromTop 0.5s ease-out forwards;
        opacity: 0;
        /* يبدأ مخفياً */
    }

    /* حاويات الوصف والرسالة */
    .productView_description_box,
    .productView_seller_message_box {
        background-color: var(--bg-color-white, #fff);
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        border: 1px solid var(--border-color-soft, #eef2f7);
        box-shadow: var(--shadow-soft);
    }

    .productView_description_box h4,
    .productView_seller_message_box h4 {
        margin-top: 0;
        color: var(--dark-blue, #03478f);
        border-bottom: 1px solid var(--border-color, #e9ecef);
        padding-bottom: 10px;
    }

    .productView_description_box p,
    .productView_seller_message_box p {
        color: var(--text-color-medium, #4a5568);
        line-height: 1.6;
    }

    .productView_description_box h4 i,
    .productView_seller_message_box h4 i {
        color: var(--primary-color, #007bff);
        margin-left: 8px;
        /* تغيير جهة الهامش */
    }

    .productView_image_container {
        width: 100%;
        position: relative;
        overflow: hidden;
        margin-bottom: 15px;
    }

    .productView_thumbnails_container {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 10px;
        flex-wrap: wrap;
    }

    .productView_thumbnails_container img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 4px;
        cursor: pointer;
        border: 2px solid var(--border-color, #e9ecef);
        transition: transform 0.3s, border-color 0.3s, box-shadow 0.3s;
    }

    .productView_thumbnails_container img.active {
        border-color: var(--primary-color, #007bff);
        box-shadow: var(--shadow-focus);
        transform: scale(1.1);
    }

    /* الطباعة والمسافات الحديثة */
    #productView_name {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--primary-color, #007bff);
        margin-bottom: 1.5rem !important;
    }

    #productView_details_container p {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.1rem;
        color: var(--dark-blue, #03478f);
        margin-bottom: 1rem;
    }

    #productView_details_container p i {
        color: var(--primary-color, #007bff);
        font-size: 1.2rem;
    }

    #productView_original_price {
        text-decoration: line-through;
        color: var(--text-color-light, #7f8c8d);
        font-size: 0.9em;
    }

    #productView_price {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary-color, #007bff);
    }

    /* إجراءات السلة الحديثة */
    .productView_quantity_selector {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin: 1.5rem 0;
    }

    .productView_quantity_btn {
        background-color: var(--primary-color-light, #e6f2ff);
        border: 1px solid var(--border-color-active, #9bc1eb);
        color: var(--primary-color, #007bff);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.2s;
    }

    #productView_selected_quantity_input {
        width: 60px;
        height: 40px;
        text-align: center;
        border: 1px solid var(--border-color-input, #d1d5db);
        border-radius: 8px;
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-color-dark, #222);
    }

    .productView_total_price_container {
        text-align: center;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background-color: var(--bg-color-light, #f9f9f9);
        border-radius: 8px;
    }

    #productView_total_price_label {
        font-size: 1.1rem;
        color: var(--text-color-dark, #222);
    }

    #productView_total_price {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--primary-color, #007bff);
    }

    .productView_add_to_cart_btn {
        width: 100%;
        padding: 15px;
        font-size: 1.2rem;
        font-weight: bold;
        background: var(--primary-color, #007bff);
        color: var(--bg-color-white, #fff);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
    }

    /* Keyframes للحركات */
    @keyframes productView_fadeInScaleUp {
        from {
            opacity: 0;
            transform: scale(0.9);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    @keyframes productView_zoomInEffect {
        from {
            opacity: 0;
            transform: scale(0.5);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    @keyframes productView_slideInFromTop {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<div class="productView_modal_content" id="productView_modal_content">
    <div class="productView_image_container" id="productView_image_container">
        <img id="productView_image" src="" alt="صورة المنتج" />
        <div class="productView_thumbnails_container" id="productView_thumbnails_container">
        </div>
    </div>
    <div class="productView_details" id="productView_details_container">
        <h3 id="productView_name" style="text-align: center; margin-bottom: 1rem; color: var(--text-color-dark, #222)">
        </h3>

        <p id="productView_quantity_container">
            <i class="fas fa-archive" id="productView_quantity_icon"></i>
            الكمية المتاحة:
            <span id="productView_quantity_value"></span>
        </p>
        <p id="productView_original_price_container" style="display: none">
            <i class="fas fa-tags"></i> السعر قبل الخصم:
            <span id="productView_original_price"></span>
        </p>
        <p id="productView_price_container">
            <i class="fas fa-tag" id="productView_price_icon"></i> سعر القطعة:
            <span id="productView_price"></span>
        </p>
        <div class="productView_description_box" id="productView_description_container">
            <h4 id="productView_description_header">
                <i class="fas fa-file-alt"></i> وصف المنتج
            </h4>
            <p id="productView_description_text"></p>
        </div>

        <div class="productView_seller_message_box" id="productView_seller_message_container">
            <h4 id="productView_seller_message_header">
                <i class="fas fa-comment-dots" id="productView_seller_message_icon"></i>
                رسالة من البائع
            </h4>
            <p id="productView_seller_message_text"></p>
        </div>

        <div class="productView_cart_actions_container" id="productView_cart_actions">
            <div class="productView_quantity_selector" id="productView_quantity_selector">
                <button class="productView_quantity_btn" id="productView_decrease_quantity_btn" title="إنقاص الكمية">
                    -
                </button>
                <input type="number" id="productView_selected_quantity_input" value="1" min="1"
                    aria-label="الكمية المختارة" />
                <button class="productView_quantity_btn" id="productView_increase_quantity_btn" title="زيادة الكمية">
                    +
                </button>
            </div>

            <div class="productView_total_price_container" id="productView_total_price_container">
                <strong id="productView_total_price_label">الإجمالي:</strong>
                <span id="productView_total_price"></span>
            </div>
            <button class="productView_add_to_cart_btn" id="productView_add_to_cart_btn">
                <i class="fas fa-cart-plus" id="productView_add_to_cart_icon"></i>
                إضافة إلى السلة
            </button>
        </div>
    </div>
</div>
<script>
    /**
     * @fileoverview Product View Details Logic (productView_ module)
     * @description Handles displaying product details, image gallery, managing quantity selection, and adding to cart.
     */

    // ==============================================
    //  DOM Access (Separation of Concerns - SRP)
    // ==============================================

    /**
     * @constant {Object} productView_domElements
     * @description Cache of DOM elements to avoid repeated `document.getElementById` calls.
     */
    const productView_domElements = {
        // Main Containers
        quantityContainer: document.getElementById("productView_quantity_container"),
        priceContainer: document.getElementById("productView_price_container"),
        cartActionsContainer: document.getElementById("productView_cart_actions"),
        originalPriceContainer: document.getElementById("productView_original_price_container"),

        // Product Data Elements
        name: document.getElementById("productView_name"),
        quantityValue: document.getElementById("productView_quantity_value"),
        price: document.getElementById("productView_price"),
        originalPrice: document.getElementById("productView_original_price"),
        description: document.getElementById("productView_description_text"),
        sellerMessage: document.getElementById("productView_seller_message_text"),

        // Images
        mainImage: document.getElementById("productView_image"),
        thumbnailsContainer: document.getElementById("productView_thumbnails_container"),

        // Controls
        decreaseBtn: document.getElementById("productView_decrease_quantity_btn"),
        increaseBtn: document.getElementById("productView_increase_quantity_btn"),
        selectedQuantityInput: document.getElementById("productView_selected_quantity_input"),
        totalPriceEl: document.getElementById("productView_total_price"),
        addToCartBtn: document.getElementById("productView_add_to_cart_btn"),
    };


    // ==============================================
    //  Helper Functions (Modularity)
    // ==============================================

    /**
     * @function productView_updateTotalPrice
     * @description Updates the total price display based on selected quantity and price per item.
     * @param {number} pricePerItem - The price of a single item.
     */
    function productView_updateTotalPrice(pricePerItem) {
        try {
            const price = parseFloat(pricePerItem);
            // Get value from input field
            const quantity = parseInt(productView_domElements.selectedQuantityInput.value, 10) || 1;
            const total = price * quantity;
            productView_domElements.totalPriceEl.textContent = `${total.toFixed(2)} جنيه`;
        } catch (error) {
            console.error("productView_updateTotalPrice - خطأ في تحديث السعر الإجمالي:", error);
        }
    }

    /**
     * @function productView_populateThumbnails
     * @description Creates and handles product image thumbnails.
     * @param {string[]} imageSrcArray - Array of image source URLs.
     * @param {HTMLElement} mainImageEl - The main image element (<img>).
     * @param {HTMLElement} thumbnailsContainerEl - The container for thumbnails.
     */
    function productView_populateThumbnails(imageSrcArray, mainImageEl, thumbnailsContainerEl) {
        try {
            thumbnailsContainerEl.innerHTML = ""; // Clear old thumbnails
            mainImageEl.src = imageSrcArray[0] || ""; // Show first image

            imageSrcArray.forEach((src) => {
                const thumb = document.createElement("img");
                thumb.alt = "Product Thumbnail";
                thumb.src = src;

                thumb.onclick = () => { // On click, update main image
                    mainImageEl.src = src;
                    // Remove 'active' class from all and add to selected
                    document.querySelectorAll('.productView_thumbnails_container img').forEach(t => t.classList.remove('active'));
                    thumb.classList.add('active');
                };

                thumb.onerror = () => {
                    console.warn("[productView_] فشل تحميل الصورة المصغرة:", src);
                    // Replace failed image with placeholder (CSS can improve this)
                    const placeholder = document.createElement("div");
                    placeholder.className = "image-load-error-placeholder";
                    placeholder.innerHTML = `<i class="fas fa-exclamation-triangle"></i><span>فشل التحميل</span>`;
                    thumb.replaceWith(placeholder);
                };
                thumbnailsContainerEl.appendChild(thumb);
            });

            // Activate first thumbnail by default (small delay to ensure append)
            setTimeout(() => {
                if (thumbnailsContainerEl.firstChild) thumbnailsContainerEl.firstChild.classList.add('active');
            }, 0);

        } catch (error) {
            console.error("productView_populateThumbnails - خطأ في إنشاء الصور المصغرة:", error);
        }
    }

    /**
     * @function productView_setupQuantityControls
     * @description Sets up logic for increasing/decreasing quantity and updating total price.
     * @param {object} productData - The product data object.
     */
    function productView_setupQuantityControls(productData) {
        try {
            const { decreaseBtn, increaseBtn, selectedQuantityInput } = productView_domElements;

            // Set max quantity available
            selectedQuantityInput.max = productData.availableQuantity;

            // Use productData.pricePerItem to ensure price is updated correctly
            const pricePerItem = productData.pricePerItem;

            // Shared handler to avoid code duplication
            const quantityChangeHandler = () => {
                // Ensure value does not exceed max or fall below min (1)
                let quantity = parseInt(selectedQuantityInput.value, 10);
                const max = parseInt(selectedQuantityInput.max, 10);

                if (quantity < 1 || isNaN(quantity)) {
                    selectedQuantityInput.value = 1;
                } else if (quantity > max) {
                    selectedQuantityInput.value = max;
                }
                productView_updateTotalPrice(pricePerItem);
            };

            // Add events for increase/decrease buttons
            decreaseBtn.onclick = () => {
                if (parseInt(selectedQuantityInput.value, 10) > 1) {
                    selectedQuantityInput.value = parseInt(selectedQuantityInput.value, 10) - 1;
                    productView_updateTotalPrice(pricePerItem);
                }
            };

            increaseBtn.onclick = () => {
                const max = parseInt(selectedQuantityInput.max, 10);
                if (parseInt(selectedQuantityInput.value, 10) < max) {
                    selectedQuantityInput.value = parseInt(selectedQuantityInput.value, 10) + 1;
                    productView_updateTotalPrice(pricePerItem);
                }
            };

            // Handle manual input change
            selectedQuantityInput.onchange = quantityChangeHandler;
            selectedQuantityInput.onblur = quantityChangeHandler;

            productView_updateTotalPrice(pricePerItem); // Initial price calculation

        } catch (error) {
            console.error("productView_setupQuantityControls - خطأ في تهيئة أدوات التحكم بالكمية:", error);
        }
    }

    /**
     * @function productView_setupAddToCart
     * @description Initializes logic for adding the product to the shopping cart.
     * @param {object} productData - The product data object.
     */
    function productView_setupAddToCart(productData) {
        try {
            productView_domElements.addToCartBtn.onclick = async () => {

                if (userSession && Number(userSession.is_seller) > -1) {
                    console.log("[productView_] المستخدم مسجل دخول، جاري الإضافة للسلة...");
                    const quantity = parseInt(productView_domElements.selectedQuantityInput.value, 10);

                    const productInfoForCart = {
                        product_key: productData.product_key,
                        productName: productData.productName,
                        price: productData.pricePerItem,
                        original_price: productData.original_price,
                        image: productData.imageSrc[0],
                        seller_key: productData.user_key,
                    };
                    addToCart(productInfoForCart, quantity); // Defined externally
                } else {
                    console.warn("[productView_] مستخدم زائر. جاري التوجيه لتسجيل الدخول.");
                    // Use preset SweetAlert2 style
                    Swal.fire({
                        icon: "info",
                        title: "تنبيه",
                        text: "يرجى تسجيل الدخول أولاً لإضافة منتجات إلى السلة.",
                        showCancelButton: true,
                        confirmButtonText: "تسجيل الدخول",
                        cancelButtonText: "إلغاء",
                        customClass: { popup: 'fullscreen-swal' }, // Apply custom style
                    }).then((result) => {
                        if (result.isConfirmed) {
                            mainLoader("./pages/login.html", "index-user-container", 0, undefined, "hiddenLoginIcon", true);
                        }
                    });
                }
            };
        } catch (error) {
            console.error("productView_setupAddToCart - Error initializing add to cart button:", error);
        }
    }


    // ==============================================
    //  Main Function (SRP)
    // ==============================================

    /**
     * @function productView_viewDetails
     * @description Displays product details in the modal and initializes interactive functions.
     *   This is the main entry point for displaying product data.
     * @param {object} productData - Product data object to display.
     * @param {object} options - Additional display options (e.g., { showAddToCart: true }).
     */
    function productView_viewDetails(productData, options = {}) {
        try {
            console.log("[productView_] عرض تفاصيل المنتج...", options.showAddToCart);
            const {
                name, quantityValue, price, description, sellerMessage,
                quantityContainer, priceContainer, cartActionsContainer,
                originalPriceContainer, originalPrice,
                mainImage, thumbnailsContainer,
            } = productView_domElements;

            const showAddToCart = options.showAddToCart !== false; // Default is true

            // Populate basic data
            name.textContent = productData.productName || "غير متوفر";
            description.textContent = productData.description || "لا يوجد وصف متاح.";
            sellerMessage.textContent = productData.sellerMessage || "لا توجد رسالة من البائع.";

            // Configure display based on showAddToCart option
            if (showAddToCart) {
                quantityContainer.style.display = "flex";
                priceContainer.style.display = "flex";
                cartActionsContainer.style.display = "block";
                quantityValue.textContent = productData.availableQuantity;
                price.textContent = `${productData.pricePerItem} جنيه`;
                productView_setupQuantityControls(productData);
                productView_setupAddToCart(productData);
            } else {
                quantityContainer.style.display = "none";
                priceContainer.style.display = "none";
                cartActionsContainer.style.display = "none";
            }

            // Populate image gallery
            productView_populateThumbnails(
                productData.imageSrc || [],
                mainImage,
                thumbnailsContainer
            );

            // Show original price if exists and greater than current price
            const originalPriceVal = productData.original_price ? parseFloat(productData.original_price) : 0;
            const currentPriceVal = productData.pricePerItem ? parseFloat(productData.pricePerItem) : 0;

            if (originalPriceVal > 0 && originalPriceVal > currentPriceVal) {
                console.log("[productView_] إظهار السعر الأصلي.");
                originalPrice.textContent = `${originalPriceVal.toFixed(2)} جنيه`;
                originalPriceContainer.style.display = "flex";
            } else {
                console.log("[productView_] إخفاء السعر الأصلي.");
                originalPriceContainer.style.display = "none";
                originalPrice.textContent = "";
            }

        } catch (error) {
            console.error("productView_viewDetails - خطأ عام في عرض التفاصيل:", error);
        
        }
    }

    // ==============================================
    //  Entry Point (Initialization)
    // ==============================================

    try {
        console.log("Initializing product view module with received state:", productSession);
        // productSession[0] is product data, productSession[1] is showAddToCart option
        productView_viewDetails(productSession[0], productSession[1]);
    } catch (error) {
        console.error("Error initializing product view window:", error);
    }
</script>