<!--
  @file pages/Advertiesment.html (v2 - Redesigned)
  @description نموذج إدارة إعلانات الصور (HTML Fragment) للمدير.

  هذا الملف هو جزء من واجهة المستخدم يتم تحميله ديناميكيًا داخل نافذة منبثقة (modal)
  عندما ينقر المسؤول على زر "إدارة الإعلانات". يحتوي على نموذج لإدارة صور الإعلان:
  - موديول متقدم لرفع الصور مع ضغطها من جهة العميل.
  - تحميل وعرض الصور الموجودة مسبقًا من Cloudflare R2.
  - إمكانية حذف الصور القديمة وإضافة صور جديدة.
  - شيفرة JavaScript مدمجة للتحقق من صحة النموذج، ومعالجة الصور، ورفع/حذف البيانات من R2.
-->

<!-- ✅ جديد: إضافة أنماط مخصصة لتحسين تصميم الموديول -->
<style>
  /* إعادة تصميم منطقة رفع الصور */
  #adver-form .image-uploader {
    background-color: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    transition: background-color 0.3s, border-color 0.3s;
    cursor: pointer;
  }

  #adver-form .image-uploader:hover {
    background-color: #f1f3f5;
    border-color: #007bff;
  }

  /* أيقونة السحابة في المنتصف */
  .dropzone-icon {
    font-size: 3rem;
    color: #adb5bd;
    margin-bottom: 1rem;
    transition: color 0.3s;
  }

  #adver-form .image-uploader:hover .dropzone-icon {
    color: #007bff;
  }

  /* رسالة السحب والإفلات */
  .dropzone-text {
    color: #495057;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  /* أزرار التحكم في الرفع */
  #adver-form .uploader-actions {
    margin-top: 1rem;
    border-top: 1px solid #e9ecef;
    padding-top: 1rem;
  }

  /* تحسين شبكة عرض الصور */
  #adver-form .previews {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 1rem;
    margin-top: 1.5rem;
  }

  /* تحسين بطاقة الصورة المصغرة */
  #adver-form .preview {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 8px rgba(0,0,0,0.07);
    transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
    background-color: #e9ecef;
  }

  #adver-form .preview:hover {
    transform: translateY(-4px) scale(1.03);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
  }

  #adver-form .preview img {
    width: 100%;
    height: 120px;
    object-fit: cover;
    display: block;
  }

  /* زر الحذف الأنيق */
  #adver-form .preview .remove {
    position: absolute;
    top: 5px;
    right: 5px;
    background-color: rgba(239, 68, 68, 0.8);
    color: white;
    border: none;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transform: scale(0.8);
    transition: opacity 0.2s, transform 0.2s;
  }

  #adver-form .preview:hover .remove {
    opacity: 1;
    transform: scale(1);
  }

  /* حالة التحميل */
  #adver-form .preview .meta {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.6);
    color: white;
    font-size: 0.75rem;
    padding: 4px;
    text-align: center;
  }

  /* ✅ إصلاح: إضافة القاعدة لإخفاء حقل إدخال الملف الأصلي */
  #adver-form .hidden-file {
    position: absolute; left: -9999px;
  }
</style>

<div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="adverTitle">
  <button class="close-button" id="adver-modal-close-btn" aria-label="إغلاق"><i class="fas fa-times"></i></button>

  <h2 id="adverTitle"><i class="fas fa-bullhorn"></i> إدارة صور الإعلان</h2>

  <form id="adver-form" novalidate>
    <!-- موديول رفع الصور -->
    <section class="form-group" aria-labelledby="imagesHeading">
      <label id="imagesHeading"><i class="fas fa-images"></i> صور الإعلان</label>

      <div class="image-uploader" id="image-uploader" tabindex="0" role="group" aria-label="منطقة رفع الصور">
        <!-- ✅ جديد: هيكل منطقة السحب والإفلات -->
        <div class="dropzone-content">
          <i class="fas fa-cloud-upload-alt dropzone-icon"></i>
          <p class="dropzone-text">اسحب وأفلت الصور هنا، أو انقر للاختيار</p>
          <p class="hint">يمكنك إضافة صور جديدة أو حذف الصور الحالية.</p>
        </div>
        
        <input class="hidden-file" id="file-input" type="file" accept="image/*" multiple aria-hidden="true">
        
        <div class="uploader-actions" id="uploader-actions">
          <button type="button" class="btn btn-ghost btn-icon" id="pick-files-btn" title="اختر صورًا"><i class="fas fa-folder-open"></i></button>
          <button type="button" class="btn btn-ghost btn-icon" id="take-photo-btn" title="التقاط من الكاميرا"><i class="fas fa-camera"></i></button>
          <button type="button" class="btn btn-ghost btn-icon" id="clear-all-btn" title="مسح الكل"><i class="fas fa-trash-alt"></i></button>
        </div>

        <div class="previews" id="previews" aria-live="polite" aria-atomic="false">
            <div class="loader" id="images-loader" style="margin: 20px auto; display: none;"></div>
        </div>

      </div>
    </section>

    <!-- زر إرسال النموذج -->
    <div class="submit-container">
      <button type="submit" class="btn btn-primary">نشر الإعلان الآن</button>
    </div>
  </form>
</div>

<script>
/**
 * دالة لتهيئة نموذج إدارة الإعلان.
 */
async function initializeAdvertiesmentForm() {
  console.log('%c[AdverForm] Initializing form...', 'color: #20c997;');
  
  // الوصول إلى مصفوفة الصور وحالة الموديول من النطاق الخارجي
  const images = window.adverModule.images;
  images.length = 0; // إفراغ مصفوفة الصور عند كل تهيئة
  window.adverModule.originalImageNames = []; // إعادة تعيين عند كل تهيئة

  // تحميل الصور الموجودة مسبقًا
  await window.adverModule.loadExistingAdverImages();
}

// جعل الدوال والمتغيرات متاحة عالميًا ضمن نطاق النافذة
window.adverModule = (function() {
  const IMAGE_MAX_WIDTH = 1600;
  const IMAGE_MAX_HEIGHT = 1600;
  const IMAGE_QUALITY = 0.75;
  const MAX_FILES = 10;
  const R2_PUBLIC_URL = 'https://pub-e828389e2f1e484c89d8fb652c540c12.r2.dev';

  const fileInput = document.getElementById('file-input');
  const pickFilesBtn = document.getElementById('pick-files-btn');
  const takePhotoBtn = document.getElementById('take-photo-btn');
  const clearAllBtn = document.getElementById('clear-all-btn');
  const previewsEl = document.getElementById('previews');
  const uploaderEl = document.getElementById('image-uploader');
  const form = document.getElementById('adver-form');
  const imagesLoader = document.getElementById('images-loader');
  
  // ✅ جديد: ربط النقر على منطقة الرفع بأكملها
  uploaderEl.addEventListener('click', (e) => {
    // تجنب تفعيل النقر إذا كان الهدف هو زر أو عنصر تفاعلي آخر
    if (e.target.closest('button') || e.target.closest('.preview')) return;
    fileInput.click();
  });

  const images = [];
  let originalImageNames = [];
  let idCounter = 1;

  function genId() { return 'ad_img_' + (Date.now() + idCounter++); }

  async function supportsWebP() {
    if (!self.createImageBitmap) return false;
    const blob = await fetch('data:image/webp;base64,UklGRiIAAABXRUJQVlA4TAYAAAAvAAAAAAfQ//73v/+BiOh/AAA=')
      .then(r => r.blob()).catch(()=>null);
    if (!blob) return false;
    try { await createImageBitmap(blob); return true; } catch(e) { return false; }
  }
  const WEBP_SUPPORTED_PROMISE = supportsWebP();

  async function compressImage(file) {
    const imgBitmap = await createImageBitmap(file);
    let { width, height } = imgBitmap;
    const ratio = Math.min(1, IMAGE_MAX_WIDTH / width, IMAGE_MAX_HEIGHT / height);
    const newWidth = Math.round(width * ratio);
    const newHeight = Math.round(height * ratio);
    const canvas = Object.assign(document.createElement('canvas'), { width: newWidth, height: newHeight });
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0,0,newWidth,newHeight);
    ctx.drawImage(imgBitmap, 0, 0, newWidth, newHeight);
    const webpSupported = await WEBP_SUPPORTED_PROMISE;
    const mime = webpSupported ? 'image/webp' : 'image/jpeg';
    const blob = await new Promise((res) => canvas.toBlob(res, mime, IMAGE_QUALITY));
    try { imgBitmap.close(); } catch(e){}
    return blob;
  }

  function createPreviewItem(state, existingImageUrl = null) {
    const wrapper = document.createElement('div');
    wrapper.className = 'preview';
    wrapper.setAttribute('data-id', state.id);

    const removeBtn = document.createElement('button');
    removeBtn.type = "button";
    removeBtn.className = 'remove';
    removeBtn.setAttribute('title', 'إزالة الصورة');
    removeBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
    removeBtn.addEventListener('click', () => removeImage(state.id));

    const img = document.createElement('img');
    const meta = document.createElement('div');
    meta.className = 'meta';

    wrapper.appendChild(removeBtn);
    wrapper.appendChild(img);
    wrapper.appendChild(meta);

    if (existingImageUrl) {
      img.src = existingImageUrl;
      meta.textContent = 'صورة حالية';
    } else {
      const reader = new FileReader();
      reader.onload = (e) => { img.src = e.target.result; };
      reader.readAsDataURL(state.file);
      meta.textContent = 'جاري الضغط...';
    }

    previewsEl.appendChild(wrapper);
    state._el = wrapper;
    state._metaEl = meta;
  }

  function removeImage(id) {
    // ✅ تعديل: تحسين رسالة التأكيد عند الحذف
    Swal.fire({
      title: 'تأكيد الحذف',
      text: "هل أنت متأكد من رغبتك في حذف هذه الصورة؟ لا يمكن التراجع عن هذا الإجراء.",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'موافق',
      cancelButtonText: 'إلغاء'
    }).then((result) => {
      if (result.isConfirmed) {
        const idx = images.findIndex(i => i.id === id);
        if (idx > -1) {
          const state = images[idx];
          if (state._el) state._el.remove();
          images.splice(idx, 1);
        }
      }
    });
  }

  function clearAll() {
    if (images.length === 0) return;
    Swal.fire({
      title: 'هل أنت متأكد؟',
      text: "سيتم حذف جميع الصور المضافة!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'نعم، احذف الكل!',
      cancelButtonText: 'إلغاء'
    }).then((result) => {
      if (result.isConfirmed) {
        previewsEl.innerHTML = '';
        images.length = 0;
      }
    });
  }

  async function handleNewFiles(fileList){
    const filesArr = Array.from(fileList).slice(0, MAX_FILES - images.length);
    for(const file of filesArr){
      if(!file.type.startsWith('image/')) continue;
      const id = genId();
      const state = { id, file, compressedBlob: null, status:'pending' };
      images.push(state);
      createPreviewItem(state);
      try{
        state.status = 'compressing';
        const compressed = await compressImage(file);
        state.compressedBlob = compressed;
        state.status = 'ready';
        if (state._metaEl) state._metaEl.textContent = 'جاهزة للرفع';
      } catch(err){
        state.status = 'error';
        if (state._metaEl) state._metaEl.textContent = 'خطأ';
      }
    }
    fileInput.value = '';
  }

  async function loadExistingAdverImages() {
    console.log('[AdverForm] Loading existing advertisement images...');
    imagesLoader.style.display = 'block';
    previewsEl.innerHTML = '';
    images.length = 0;
    originalImageNames = [];

    // ✅ إصلاح: استخدام طريقة تحميل الصور مباشرة لتجنب مشاكل CORS
    const imagePromises = [];
    for (let i = 1; i <= MAX_FILES; i++) {
      const imageName = `pic${i}.webp`;
      const imageUrl = `${R2_PUBLIC_URL}/${imageName}`;

      const promise = new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          console.log(`[AdverForm] Found existing image: ${imageName}`);
          resolve({ success: true, name: imageName, url: imageUrl });
        };
        img.onerror = () => {
          resolve({ success: false });
        };
        img.src = imageUrl;
      });
      imagePromises.push(promise);
    }

    const results = await Promise.all(imagePromises);
    results.forEach(result => {
      if (result.success) {
        originalImageNames.push(result.name);
        const id = genId();
        const state = { id, file: null, compressedBlob: null, status: 'uploaded', fileName: result.name };
        images.push(state);
        createPreviewItem(state, result.url);
      }
    });

    window.adverModule.originalImageNames = originalImageNames;
    imagesLoader.style.display = 'none';
  }

  pickFilesBtn.addEventListener('click', () => {
    fileInput.removeAttribute('capture');
    fileInput.click();
  });
  takePhotoBtn.addEventListener('click', () => {
    fileInput.setAttribute('capture', 'environment');
    fileInput.click();
  });
  clearAllBtn.addEventListener('click', clearAll);
  fileInput.addEventListener('change', (e) => handleNewFiles(e.target.files));
  uploaderEl.addEventListener('dragover', (e)=>{ e.preventDefault(); uploaderEl.style.borderColor = '#007bff'; });
  uploaderEl.addEventListener('dragleave', (e)=>{ uploaderEl.style.borderColor = ''; });
  uploaderEl.addEventListener('drop', (e)=>{ e.preventDefault(); uploaderEl.style.borderColor = ''; handleNewFiles(e.dataTransfer.files); });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    console.log('%c[AdverForm] Submit event triggered.', 'color: #20c997;');

    Swal.fire({
      title: 'جاري نشر الإعلان...',
      text: 'الرجاء الانتظار بينما يتم تحديث الصور.',
      allowOutsideClick: false,
      didOpen: () => { Swal.showLoading(); },
    });

    try {
      // --- ✅ إصلاح شامل لمنطق الحفظ ---

      // 1. تحديد الحالة النهائية للصور في الواجهة (UI)
      const finalImagesInUI = images.map((state, index) => ({
        state: state,
        newName: `pic${index + 1}.webp`
      }));
      const finalImageNamesInUI = finalImagesInUI.map(item => item.newName);

      // 2. تحديد الصور التي يجب حذفها من السحابة
      // هي الصور التي كانت موجودة في البداية ولكنها غير موجودة في القائمة النهائية للأسماء
      const allPossibleNames = Array.from({ length: MAX_FILES }, (_, i) => `pic${i + 1}.webp`);
      const imagesToDelete = allPossibleNames.filter(name => !finalImageNamesInUI.includes(name));

      // 3. تنفيذ عمليات الحذف
      if (imagesToDelete.length > 0) {
        console.log("[AdverForm] Deleting images from cloud:", imagesToDelete);
        await Promise.all(imagesToDelete.map(name =>
          deleteFile2cf(name).catch(err => console.error(`Failed to delete ${name}:`, err))
        ));
      }

      // 4. تنفيذ عمليات الرفع (للصور الجديدة) وإعادة الرفع (للقديمة التي تغير ترتيبها)
      const uploadPromises = finalImagesInUI.map(async (item) => {
        const { state, newName } = item;

        // الحالة أ: صورة جديدة جاهزة للرفع
        if (state.status === 'ready' && state.compressedBlob) {
          console.log(`Uploading new image to: ${newName}`);
          return uploadFile2cf(state.compressedBlob, newName);
        }

        // الحالة ب: صورة قديمة موجودة بالفعل ولكن ترتيبها تغير (اسمها القديم لا يساوي اسمها الجديد)
        if (state.status === 'uploaded' && state.fileName !== newName) {
          console.log(`Re-ordering image from ${state.fileName} to ${newName}`);
          try {
            // تحميل محتوى الصورة القديمة كـ Blob
            const blob = await downloadFile2cf(state.fileName);
            // إعادة رفعها بالاسم الجديد
            return uploadFile2cf(blob, newName);
          } catch (error) {
            console.error(`Failed to re-order image ${state.fileName}:`, error);
            // في حالة الفشل، يمكن إرجاع Promise مرفوض أو معالجة الخطأ
            return Promise.reject(error);
          }
        }

        // الحالة ج: صورة قديمة لم يتغير ترتيبها، لا تفعل شيئًا
        if (state.status === 'uploaded' && state.fileName === newName) {
            console.log(`Image ${newName} is already in correct position. Skipping.`);
            return Promise.resolve(); // لا توجد عملية مطلوبة
        }
      });

      // انتظار اكتمال جميع عمليات الرفع وإعادة الرفع
      await Promise.all(uploadPromises);

      // --- نهاية الإصلاح ---

      Swal.fire('تم بنجاح!', 'تم نشر الإعلان بنجاح.', 'success').then(() => {
        // إعادة تحميل المعاينة لتحديث الحالة
        initializeAdvertiesmentForm();
      });

    } catch (error) {
      console.error('%c[AdverForm] Submission failed with critical error:', 'color: red; font-weight: bold;', error);
      Swal.fire('خطأ!', `فشل في نشر الإعلان: ${error.message}`, 'error');
    }
  });

  return {
    images,
    originalImageNames: [],
    genId,
    createPreviewItem,
    loadExistingAdverImages
  };

})();
</script>