<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>اختبار الكاميرا + IndexedDB - Suze Bazaar</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans',Arial;direction:rtl;padding:18px}
    .wrap{max-width:720px;margin:0 auto}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    button{padding:8px 12px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer}
    img.thumb{width:140px;height:auto;border-radius:8px;display:block}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;margin-top:12px}
    .card{padding:8px;border-radius:8px;border:1px solid #eee;background:#fafafa}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>اختبار التقاط الصورة وحفظها في IndexedDB</h1>
    <p>زر "فتح الكاميرا" يفتح الكاميرا/المعرض. يتم حفظ الصورة في مخزن باسم <code>myStore</code>.</p>

    <div class="row">
      <button id="captureBtn">فتح الكاميرا / اختيار صورة</button>
      <button id="refreshBtn">عرض صور myStore</button>
      <button id="clearBtn">مسح myStore</button>
    </div>

    <div id="status" style="margin-top:12px;color:#333">حالة: جاهز</div>

    <div class="grid" id="imagesGrid"></div>
  </div>

  <script src="/js/cameraCapture.js"></script>
  <script>
    const captureBtn = document.getElementById('captureBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const clearBtn = document.getElementById('clearBtn');
    const status = document.getElementById('status');
    const imagesGrid = document.getElementById('imagesGrid');
    const STORE = 'myStore'; // اسم المخزن الديناميكي كما طلبت

    function setStatus(t) { status.textContent = 'حالة: ' + t; }

    captureBtn.addEventListener('click', function () {
      setStatus('فتح الكاميرا...');
      window.suzeBazaarCamera.openCameraAndCapture().then(function (res) {
        if (!res) {
          setStatus('ألغيت العملية أو حدث خطأ.');
          return;
        }
        setStatus('حفظ الصورة في IndexedDB...');
        return window.suzeBazaarCamera.saveImage(STORE, res.blob).then(function (id) {
          setStatus('تم الحفظ (id=' + id + '). تحديث العرض...');
          refreshImages();
        }).catch(function (err) {
          console.error(err);
          setStatus('فشل الحفظ: ' + (err && err.message));
        });
      }).catch(function (err) {
        console.error(err);
        setStatus('خطأ أثناء التقاط الصورة.');
      });
    });

    refreshBtn.addEventListener('click', refreshImages);
    clearBtn.addEventListener('click', function () {
      if (!confirm('هل تريد حذف كل الصور في myStore؟')) return;
      setStatus('مسح myStore...');
      window.suzeBazaarCamera.clearStore(STORE).then(function () {
        setStatus('تم المسح.');
        refreshImages();
      }).catch(function (err) {
        console.error(err);
        setStatus('فشل المسح: ' + (err && err.message));
      });
    });

    function refreshImages() {
      setStatus('تحميل صور myStore...');
      imagesGrid.innerHTML = '';
      window.suzeBazaarCamera.getImages(STORE).then(function (list) {
        if (!list || list.length === 0) {
          setStatus('لا توجد صور في myStore.');
          return;
        }
        setStatus('عرض ' + list.length + ' صورة.');
        list.forEach(function (rec) {
          var div = document.createElement('div');
          div.className = 'card';
          var img = document.createElement('img');
          img.className = 'thumb';
          img.src = rec.url;
          img.alt = 'صورة ' + rec.id;
          // عند النقر نحفظ نسخة ونسجل الحذف لاحقاً
          var info = document.createElement('div');
          info.style.fontSize = '12px';
          info.style.marginTop = '6px';
          info.textContent = 'id: ' + rec.id + ' — ' + Math.round(rec.size/1024) + ' KB';
          var del = document.createElement('button');
          del.textContent = 'حذف';
          del.style.marginTop = '6px';
          del.addEventListener('click', function () {
            if (!confirm('حذف الصورة id=' + rec.id + '?')) return;
            window.suzeBazaarCamera.deleteImage(rec.id).then(function () {
              // نفك URL ونحدّفه من الDOM
              URL.revokeObjectURL(rec.url);
              div.remove();
              setStatus('حُذفت الصورة ' + rec.id);
            }).catch(function (err) {
              console.error(err);
              setStatus('فشل الحذف');
            });
          });
          div.appendChild(img);
          div.appendChild(info);
          div.appendChild(del);
          imagesGrid.appendChild(div);
        });
      }).catch(function (err) {
        console.error(err);
        setStatus('فشل التحميل: ' + (err && err.message));
      });
    }

    // عرض تلقائي عند تحميل الصفحة إن وُجد شيء
    window.addEventListener('load', function () {
      refreshImages();
    });
  </script>
</body>
</html>
