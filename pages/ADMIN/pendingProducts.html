<!--
    @file pages/ADMIN/pendingProducts.html
    @description Admin page for managing product approvals.
    Contains two main sections:
    1. Pending Products: A list of products waiting for approval (Card layout).
    2. Published Products: A table of currently active products (Table layout).
    Includes responsive CSS and inline JavaScript logic for fetching and updating data.
-->
<style>
    /* 
     * Container styles for the pending products page
     */
    .pending-products-container {
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        text-align: right;
        direction: rtl;
        margin-bottom: 30px;
    }

    /* 
     * Header section containing title and refresh button
     */
    .pending-products-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 10px;
    }

    /* 
     * Pending Cards (Top Section) Styles 
     */
    .pending-product-card {
        border: 1px solid #ffc107;
        /* Yellow border indicates pending/warning state */
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        display: flex;
        gap: 15px;
        align-items: flex-start;
        background: #fffbf0;
        /* Light yellow background */
        transition: transform 0.2s;
    }

    .pending-product-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .pending-product-image {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid #eee;
    }

    .pending-product-details {
        flex: 1;
    }

    .pending-product-title {
        font-size: 1.1em;
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
    }

    .pending-product-info {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 3px;
    }

    .pending-product-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-width: 120px;
    }

    /* 
     * Published Table (Bottom Section) Styles 
     */
    .pending-products-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    .pending-products-table th,
    .pending-products-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
        text-align: right;
    }

    .pending-products-table th {
        background-color: #f8f9fa;
        color: #333;
        font-weight: bold;
    }

    .pending-products-table tr:hover {
        background-color: #f1f1f1;
    }

    /* 
     * Action Buttons Styles 
     */
    .btn-approve {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }

    .btn-reject {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }

    .btn-unpublish {
        background-color: #ffc107;
        color: #000;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }

    .btn-view {
        background-color: #17a2b8;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }

    .section-title {
        font-size: 1.25em;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
        color: #555;
    }

    .no-data-msg {
        text-align: center;
        padding: 20px;
        color: #888;
        background: #fafafa;
        border-radius: 6px;
    }

    /* 
     * Responsive Styles for Mobile Devices 
     */
    @media (max-width: 768px) {

        /* Stack card elements vertically on small screens */
        .pending-product-card {
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .pending-product-image {
            width: 100%;
            height: 200px;
            max-width: 300px;
            margin-bottom: 10px;
        }

        .pending-product-details {
            width: 100%;
            margin-bottom: 15px;
        }

        .pending-product-actions {
            flex-direction: row;
            width: 100%;
            justify-content: center;
            flex-wrap: wrap;
        }

        .pending-product-actions button {
            flex: 1;
            min-width: 100px;
        }

        /* Convert Table to Card Layout on Mobile */
        .pending-products-table,
        .pending-products-table thead,
        .pending-products-table tbody,
        .pending-products-table th,
        .pending-products-table td,
        .pending-products-table tr {
            display: block;
        }

        /* Hide table headers on mobile */
        .pending-products-table thead tr {
            position: absolute;
            top: -9999px;
            left: -9999px;
        }

        .pending-products-table tr {
            border: 1px solid #ccc;
            margin-bottom: 15px;
            background: #fff;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .pending-products-table td {
            border: none;
            border-bottom: 1px solid #eee;
            position: relative;
            padding-right: 50%;
            text-align: left;
            padding-top: 10px;
            padding-bottom: 10px;
        }

        /* Add labels before cell content */
        .pending-products-table td:before {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 45%;
            padding-right: 10px;
            white-space: nowrap;
            font-weight: bold;
            text-align: right;
            color: #333;
        }

        /* Specific Labels for mobile table view */
        .pending-products-table td:nth-of-type(1):before {
            content: "اسم المنتج";
        }

        .pending-products-table td:nth-of-type(2):before {
            content: "اسم البائع";
        }

        .pending-products-table td:nth-of-type(3):before {
            content: "الإجراءات";
        }

        .pending-products-table td:last-child {
            border-bottom: none;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
            padding-right: 10px;
            /* Reset padding for actions */
        }

        .pending-products-table td:last-child:before {
            display: none;
            /* Hide label for actions */
        }
    }
</style>

<div class="pending-products-container">
    <div class="pending-products-header">
        <h2 style="margin: 0; color: #333;">إدارة المنتجات</h2>
        <!-- Using fetchAllData globally accessible -->
        <button onclick="window.fetchAllData()"
            style="background: none; border: 1px solid #ccc; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
            <i class="fas fa-sync-alt"></i> تحديث الكل
        </button>
    </div>

    <!-- PENDING PRODUCTS LIST (Cards) -->
    <div style="margin-bottom: 40px;">
        <div class="section-title" style="color: #d39e00;">
            <i class="fas fa-clock"></i> المنتجات المعلقة (بانتظار الموافقة)
        </div>
        <div id="pending-list-container">
            <div class="loader"></div>
        </div>
    </div>

    <!-- PUBLISHED PRODUCTS LIST (Table) -->
    <div>
        <div class="section-title" style="color: #28a745;">
            <i class="fas fa-check-circle"></i> المنتجات المنشورة
        </div>
        <div id="published-list-container">
            <div class="loader"></div>
        </div>
    </div>
</div>

<script>
    /**
     * Logic for fetching, displaying, and managing products.
     * Functions are attached to window object for accessibility from HTML attributes.
     */

    /**
     * Fetches all product data (both pending and published) and updates the UI.
     * @async
     * @function fetchAllData
     * @returns {Promise<void>}
     */
    async function fetchAllData() {
        console.log("Fetching all data...");
        fetchPendingItems();
        fetchPublishedItems();
    }

    // Attach to window to ensure global access for onclick handlers
    window.fetchAllData = fetchAllData;

    /**
     * Fetches pending products (status = 0) from the API and renders them as cards.
     * @async
     * @function fetchPendingItems
     * @returns {Promise<void>}
     */
    async function fetchPendingItems() {
        const container = document.getElementById('pending-list-container');
        container.innerHTML = '<div class="loader"></div>';

        try {
            const response = await fetch(`${baseURL}/api/products?status=0`);
            const products = await response.json();

            if (!products || products.length === 0) {
                container.innerHTML = '<div class="no-data-msg">لا توجد منتجات معلقة حالياً.</div>';
                return;
            }

            let html = '';
            products.forEach(p => {
                const firstImage = p.ImageName ? p.ImageName.split(',')[0] : null;
                const imgUrl = firstImage ? `https://pub-e828389e2f1e484c89d8fb652c540c12.r2.dev/${firstImage}` : 'images/placeholder.png';

                html += `
                    <div class="pending-product-card" id="card-${p.product_key}">
                        <img src="${imgUrl}" class="pending-product-image" alt="${p.productName}">
                        <div class="pending-product-details">
                            <div class="pending-product-title">${p.productName}</div>
                            <div class="pending-product-info"><strong>البائع:</strong> ${p.seller_username || 'غير معروف'} (${p.seller_phone || '-'})</div>
                            <div class="pending-product-info"><strong>السعر:</strong> ${p.product_price} ج.م</div>
                            <div class="pending-product-info">${p.product_description.substring(0, 80)}...</div>
                        </div>
                        <div class="pending-product-actions">
                            <button class="btn-approve" onclick="window.updateStatus('${p.product_key}', '${p.productName}', 1)">
                                <i class="fas fa-check"></i> موافقة
                            </button>
                             <button class="btn-reject" onclick="window.deleteProduct('${p.product_key}', '${p.productName}', '${p.ImageName || ''}')">
                                <i class="fas fa-times"></i> رفض
                            </button>
                             <button class="btn-view" onclick="window.previewProduct('${p.product_key}')">
                                <i class="fas fa-eye"></i> معاينة
                            </button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;

        } catch (e) {
            console.error(e);
            container.innerHTML = '<div class="no-data-msg" style="color:red">خطأ في التحميل</div>';
        }
    }

    /**
     * Fetches published products (status = 1) from the API and renders them as a table.
     * @async
     * @function fetchPublishedItems
     * @returns {Promise<void>}
     */
    async function fetchPublishedItems() {
        const container = document.getElementById('published-list-container');
        container.innerHTML = '<div class="loader"></div>';

        try {
            const response = await fetch(`${baseURL}/api/products?status=1`);
            const products = await response.json();

            if (!products || products.length === 0) {
                container.innerHTML = '<div class="no-data-msg">لا توجد منتجات منشورة.</div>';
                return;
            }

            let html = `
                <table class="pending-products-table">
                    <thead>
                        <tr>
                            <th>اسم المنتج</th>
                            <th>اسم البائع</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            products.forEach(p => {
                html += `
                    <tr id="row-${p.product_key}">
                        <td>
                            <strong>${p.productName}</strong><br>
                            <span style="color:#777; font-size:0.85em">${p.product_price} ج.م</span>
                        </td>
                        <td>
                            ${p.seller_username || 'غير معروف'}<br>
                            <span style="color:#777; font-size:0.85em">${p.seller_phone || '-'}</span>
                        </td>
                        <td>
                             <button class="btn-unpublish" onclick="window.updateStatus('${p.product_key}', '${p.productName}', 0)" title="إلغاء النشر">
                                <i class="fas fa-ban"></i> إلغاء النشر
                            </button>
                            <div style="height:5px"></div>
                             <button class="btn-reject" style="width:100%" onclick="window.deleteProduct('${p.product_key}', '${p.productName}', '${p.ImageName || ''}')">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;

        } catch (e) {
            console.error(e);
            container.innerHTML = '<div class="no-data-msg" style="color:red">خطأ في التحميل</div>';
        }
    }

    /**
     * Updates the approval status of a product.
     * Used for both Approving (0 -> 1) and Unpublishing (1 -> 0).
     * @async
     * @function updateStatus
     * @param {string} key - The product key.
     * @param {string} name - The product name.
     * @param {number} newStatus - The new status (1 for approved, 0 for pending).
     * @returns {Promise<void>}
     */
    async function updateStatus(key, name, newStatus) {
        const actionName = newStatus === 1 ? 'موافقة ونشر' : 'إلغاء نشر';
        const color = newStatus === 1 ? '#28a745' : '#ffc107';

        const confirm = await Swal.fire({
            title: `تأكيد ${actionName}`,
            text: `هل أنت متأكد من ${actionName} للمنتج "${name}"؟`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'نعم',
            cancelButtonText: 'لا',
            confirmButtonColor: color
        });

        if (!confirm.isConfirmed) return;

        try {
            Swal.showLoading();
            const res = await fetch(`${baseURL}/api/products`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_key: key, is_approved: newStatus })
            });

            if (!res.ok) throw new Error('فشل التحديث');

            Swal.fire({
                icon: 'success',
                title: 'تم بنجاح',
                text: `تم ${actionName} بنجاح`,
                timer: 1500,
                showConfirmButton: false
            });

            // Refresh Both Lists
            fetchAllData();

        } catch (e) {
            Swal.fire('خطأ', e.message, 'error');
        }
    }

    // Attach to window
    window.updateStatus = updateStatus;

    /**
     * Permanently deletes a product from the database.
     * Used for Rejecting pending products or Deleting published ones.
     * @async
     * @function deleteProduct
     * @param {string} key - The product key.
     * @param {string} name - The product name.
     * @returns {Promise<void>}
     */
    async function deleteProduct(key, name, imageNamesStr) {
        const confirm = await Swal.fire({
            title: 'حذف المنتج',
            text: `هل أنت متأكد من حذف "${name}" نهائياً؟ سيتم أيضاً حذف جميع صور المنتج من التخزين السحابي.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'نعم، حذف',
            confirmButtonColor: '#dc3545',
            cancelButtonText: 'إلغاء',
            showLoaderOnConfirm: true,
            preConfirm: async () => {
                try {
                    // 1. Delete images from Cloudflare R2
                    if (imageNamesStr) {
                        const imageNames = imageNamesStr.split(',').map(s => s.trim()).filter(s => s);
                        if (imageNames.length > 0) {
                            console.log(`[Admin] Deleting ${imageNames.length} images from R2...`);
                            await Promise.all(imageNames.map(img =>
                                deleteFile2cf(img).catch(err => console.error(`[Delete] فشل حذف الصورة ${img}:`, err))
                            ));
                        }
                    }

                    // 2. Delete from database
                    const res = await fetch(`${baseURL}/api/products?product_key=${key}`, { method: 'DELETE' });
                    if (!res.ok) throw new Error('فشل حذف المنتج من قاعدة البيانات');

                    return true;
                } catch (e) {
                    Swal.showValidationMessage(`خطأ: ${e.message}`);
                    return false;
                }
            },
            allowOutsideClick: () => !Swal.isLoading()
        });

        if (confirm.isConfirmed) {
            Swal.fire({
                icon: 'success',
                title: 'تم الحذف',
                text: 'تم حذف المنتج وصوره بنجاح',
                timer: 1500,
                showConfirmButton: false
            });

            fetchAllData();
        }
    }
    // Attach to window
    window.deleteProduct = deleteProduct;

    /**
     * Opens a full product preview modal using the same layout as the main product view.
     * Fetches product details and sets the global session variable before calling productViewLayout.
     * @async
     * @function previewProduct
     * @param {string} key - The product key.
     * @returns {Promise<void>}
     */
    async function previewProduct(key) {
        try {
            const response = await fetch(`${baseURL}/api/products?product_key=${key}&status=0`);
            const p = await response.json();

            if (!p) {
                console.error("Product not found");
                return;
            }

            // Map keys exactly as search.html does
            const productDataForModal = {
                product_key: p.product_key,
                productName: p.productName,
                user_key: p.user_key,
                pricePerItem: p.product_price,
                original_price: p.original_price,
                imageSrc: p.ImageName
                    ? p.ImageName.split(",").map(
                        (name) =>
                            `https://pub-e828389e2f1e484c89d8fb652c540c12.r2.dev/${name}`
                    )
                    : [],
                availableQuantity: p.product_quantity,
                sellerMessage: p.user_message,
                description: p.product_description,
                sellerName: p.seller_username,
                sellerPhone: p.seller_phone,
                MainCategory: p.MainCategory,
                SubCategory: p.SubCategory,
                realPrice: p.real_price || p.realPrice,
                type: p.serviceType,
            };

            // Use new loadProductView function
            if (typeof loadProductView === 'function') {
                loadProductView(productDataForModal, true);
            } else {
                console.error("loadProductView function is missing!");
                // Fallback
                Swal.fire({
                    title: p.productName,
                    text: p.product_description,
                    imageUrl: productDataForModal.imageSrc[0]
                });
            }

        } catch (e) { console.error(e); }
    }

    // Attach to window
    window.previewProduct = previewProduct;

    // Init
    fetchAllData();
</script>