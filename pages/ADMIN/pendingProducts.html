<style>
    .pending-products-container {
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        text-align: right;
        direction: rtl;
        margin-bottom: 30px;
    }

    .pending-products-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 10px;
    }

    /* Pending Cards Style */
    .pending-product-card {
        border: 1px solid #ffc107;
        /* Yellow border for warning/pending */
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        display: flex;
        gap: 15px;
        align-items: flex-start;
        background: #fffbf0;
        /* Light yellow bg */
        transition: transform 0.2s;
    }

    .pending-product-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .pending-product-image {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid #eee;
    }

    .pending-product-details {
        flex: 1;
    }

    .pending-product-title {
        font-size: 1.1em;
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
    }

    .pending-product-info {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 3px;
    }

    .pending-product-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-width: 120px;
    }

    /* Table Styles */
    .pending-products-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    .pending-products-table th,
    .pending-products-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
        text-align: right;
    }

    .pending-products-table th {
        background-color: #f8f9fa;
        color: #333;
        font-weight: bold;
    }

    .pending-products-table tr:hover {
        background-color: #f1f1f1;
    }

    /* Buttons */
    .btn-approve {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }

    .btn-reject {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }

    .btn-unpublish {
        background-color: #ffc107;
        color: #000;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }

    .btn-view {
        background-color: #17a2b8;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }

    .section-title {
        font-size: 1.25em;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
        color: #555;
    }

    .no-data-msg {
        text-align: center;
        padding: 20px;
        color: #888;
        background: #fafafa;
        border-radius: 6px;
    }
</style>

<div class="pending-products-container">
    <div class="pending-products-header">
        <h2 style="margin: 0; color: #333;">إدارة المنتجات</h2>
        <!-- Using fetchAllData globally accessible -->
        <button onclick="window.fetchAllData()"
            style="background: none; border: 1px solid #ccc; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
            <i class="fas fa-sync-alt"></i> تحديث الكل
        </button>
    </div>

    <!-- PENDING LIST (Cards) -->
    <div style="margin-bottom: 40px;">
        <div class="section-title" style="color: #d39e00;">
            <i class="fas fa-clock"></i> المنتجات المعلقة (بانتظار الموافقة)
        </div>
        <div id="pending-list-container">
            <div class="loader"></div>
        </div>
    </div>

    <!-- PUBLISHED LIST (Table) -->
    <div>
        <div class="section-title" style="color: #28a745;">
            <i class="fas fa-check-circle"></i> المنتجات المنشورة
        </div>
        <div id="published-list-container">
            <div class="loader"></div>
        </div>
    </div>
</div>

<script>
    async function fetchAllData() {
        console.log("Fetching all data...");
        fetchPendingItems();
        fetchPublishedItems();
    }

    // Attach to window to ensure global access for onclick handlers
    window.fetchAllData = fetchAllData;

    // 1. Fetch Pending (Status = 0)
    async function fetchPendingItems() {
        const container = document.getElementById('pending-list-container');
        container.innerHTML = '<div class="loader"></div>';

        try {
            const response = await fetch(`${baseURL}/api/products?status=0`);
            const products = await response.json();

            if (!products || products.length === 0) {
                container.innerHTML = '<div class="no-data-msg">لا توجد منتجات معلقة حالياً.</div>';
                return;
            }

            let html = '';
            products.forEach(p => {
                const firstImage = p.ImageName ? p.ImageName.split(',')[0] : null;
                const imgUrl = firstImage ? `https://pub-e828389e2f1e484c89d8fb652c540c12.r2.dev/${firstImage}` : 'images/placeholder.png';

                html += `
                    <div class="pending-product-card" id="card-${p.product_key}">
                        <img src="${imgUrl}" class="pending-product-image">
                        <div class="pending-product-details">
                            <div class="pending-product-title">${p.productName}</div>
                            <div class="pending-product-info"><strong>البائع:</strong> ${p.seller_username || 'غير معروف'} (${p.seller_phone || '-'})</div>
                            <div class="pending-product-info"><strong>السعر:</strong> ${p.product_price} ج.م</div>
                            <div class="pending-product-info">${p.product_description.substring(0, 80)}...</div>
                        </div>
                        <div class="pending-product-actions">
                            <button class="btn-approve" onclick="window.updateStatus('${p.product_key}', '${p.productName}', 1)">
                                <i class="fas fa-check"></i> موافقة
                            </button>
                             <button class="btn-reject" onclick="window.deleteProduct('${p.product_key}', '${p.productName}')">
                                <i class="fas fa-times"></i> رفض
                            </button>
                             <button class="btn-view" onclick="window.previewProduct('${p.product_key}')">
                                <i class="fas fa-eye"></i> معاينة
                            </button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;

        } catch (e) {
            console.error(e);
            container.innerHTML = '<div class="no-data-msg" style="color:red">خطأ في التحميل</div>';
        }
    }

    // 2. Fetch Published (Status = 1)
    async function fetchPublishedItems() {
        const container = document.getElementById('published-list-container');
        container.innerHTML = '<div class="loader"></div>';

        try {
            const response = await fetch(`${baseURL}/api/products?status=1`);
            const products = await response.json();

            if (!products || products.length === 0) {
                container.innerHTML = '<div class="no-data-msg">لا توجد منتجات منشورة.</div>';
                return;
            }

            let html = `
                <table class="pending-products-table">
                    <thead>
                        <tr>
                            <th>اسم المنتج</th>
                            <th>اسم البائع</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            products.forEach(p => {
                html += `
                    <tr id="row-${p.product_key}">
                        <td>
                            <strong>${p.productName}</strong><br>
                            <span style="color:#777; font-size:0.85em">${p.product_price} ج.م</span>
                        </td>
                        <td>
                            ${p.seller_username || 'غير معروف'}<br>
                            <span style="color:#777; font-size:0.85em">${p.seller_phone || '-'}</span>
                        </td>
                        <td>
                             <button class="btn-unpublish" onclick="window.updateStatus('${p.product_key}', '${p.productName}', 0)" title="إلغاء النشر">
                                <i class="fas fa-ban"></i> إلغاء النشر
                            </button>
                            <div style="height:5px"></div>
                             <button class="btn-reject" style="width:100%" onclick="window.deleteProduct('${p.product_key}', '${p.productName}')">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;

        } catch (e) {
            console.error(e);
            container.innerHTML = '<div class="no-data-msg" style="color:red">خطأ في التحميل</div>';
        }
    }

    // Unified Update Status Function (1 = Approve, 0 = Unpublish)
    async function updateStatus(key, name, newStatus) {
        const actionName = newStatus === 1 ? 'موافقة ونشر' : 'إلغاء نشر';
        const color = newStatus === 1 ? '#28a745' : '#ffc107';

        const confirm = await Swal.fire({
            title: `تأكيد ${actionName}`,
            text: `هل أنت متأكد من ${actionName} للمنتج "${name}"؟`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'نعم',
            cancelButtonText: 'لا',
            confirmButtonColor: color
        });

        if (!confirm.isConfirmed) return;

        try {
            Swal.showLoading();
            const res = await fetch(`${baseURL}/api/products`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_key: key, is_approved: newStatus })
            });

            if (!res.ok) throw new Error('فشل التحديث');

            Swal.fire({
                icon: 'success',
                title: 'تم بنجاح',
                text: `تم ${actionName} بنجاح`,
                timer: 1500,
                showConfirmButton: false
            });

            // Refresh Both Lists
            fetchAllData();

        } catch (e) {
            Swal.fire('خطأ', e.message, 'error');
        }
    }

    // Attach to window
    window.updateStatus = updateStatus;

    async function deleteProduct(key, name) {
        const confirm = await Swal.fire({
            title: 'حذف المنتج',
            text: `هل أنت متأكد من حذف "${name}" نهائياً؟`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'نعم، حذف',
            confirmButtonColor: '#dc3545',
            cancelButtonText: 'إلغاء'
        });

        if (!confirm.isConfirmed) return;

        try {
            Swal.showLoading();
            const res = await fetch(`${baseURL}/api/products?product_key=${key}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('فشل الحذف');

            Swal.fire({
                icon: 'success',
                title: 'تم الحذف',
                text: 'تم حذف المنتج بنجاح',
                timer: 1500,
                showConfirmButton: false
            });

            fetchAllData();

        } catch (e) {
            Swal.fire('خطأ', e.message, 'error');
        }
    }

    // Attach to window
    window.deleteProduct = deleteProduct;

    async function previewProduct(key) {
        try {
            const response = await fetch(`${baseURL}/api/products?product_key=${key}&status=0`);
            const p = await response.json();
            const firstImage = p.ImageName ? p.ImageName.split(',')[0] : null;
            const imgUrl = firstImage ? `https://pub-e828389e2f1e484c89d8fb652c540c12.r2.dev/${firstImage}` : '';

            Swal.fire({
                title: p.productName,
                text: p.product_description,
                footer: `السعر: ${p.product_price} ج.م`,
                imageUrl: imgUrl,
                imageAlt: 'Product Image',
                confirmButtonText: 'إغلاق'
            });
        } catch (e) { console.error(e); }
    }

    // Attach to window
    window.previewProduct = previewProduct;

    // Init
    fetchAllData();
</script>