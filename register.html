<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <!--
    @file register.html
    @description ุตูุญุฉ ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ.

    ุชุญุชูู ูุฐู ุงูุตูุญุฉ ุนูู ูููุฐุฌ ูุณูุญ ูููุณุชุฎุฏููู ุงูุฌุฏุฏ ุจุฅุฏุฎุงู ุงุณููู ูุฑูู ูุงุชููู ูุฅูุดุงุก ุญุณุงุจ.
    - ุชููู ุจุงูุชุญูู ูู ุตุญุฉ ุงููุฏุฎูุงุช.
    - ุชูุดุฆ ุฑูููุง ุชุณูุณูููุง ูุฑูุฏูุง (`user_key`) ููู ูุณุชุฎุฏู.
    - ุชุณุชุฏุนู ูุงุฌูุฉ ุจุฑูุฌุฉ ุงูุชุทุจููุงุช (API) ูุญูุธ ุงููุณุชุฎุฏู ุงูุฌุฏูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.
  -->
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ - Suez Bazaar</title>
    <!-- Link to shared styles -->
    <link rel="stylesheet" href="css/style.css" />
    <!-- Link to login-specific styles (reused for consistency) -->
    <link rel="stylesheet" href="css/login.css" />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap"
      rel="stylesheet"
    />
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <!-- SweetAlert2 for modern alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body>
    <!-- Header ุจุณูุท ููุงุชุณุงู -->
    <div class="container" id="header-container">
      <a
        href="index.html"
        class="header-title-group"
        style="text-decoration: none; color: inherit"
      >
        <h1 class="bazaar-title final-text">SB</h1>
        <p class="tagline" style="opacity: 1; margin-right: 1.5rem">
          ุจุงุฒุงุฑ ุงูุณููุณ
        </p>
      </a>
      <a
        href="index.html"
        class="back-to-home-btn"
        title="ุงูุนูุฏุฉ ููุตูุญุฉ ุงูุฑุฆูุณูุฉ"
      >
        <i class="fas fa-home"></i>
        <span>ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ</span>
      </a>
    </div>

    <div class="login-page-wrapper">
      <div class="login-container">
        <h2>ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ</h2>
        <form id="register-form" novalidate>
          <div class="form-group">
            <label for="username"><i class="fas fa-user"></i> ุงูุงุณู</label>
            <input type="text" id="username" name="username" required />
            <div id="username-error" class="error-message"></div>
          </div>
          <div class="form-group">
            <label for="phone"><i class="fas fa-phone"></i> ุฑูู ุงููุงุชู</label>
            <input type="tel" id="phone" name="phone" required />
            <div id="phone-error" class="error-message"></div>
          </div>

          <button type="submit" class="button login-btn">ุฅูุดุงุก ุงูุญุณุงุจ</button>
          <div class="form-footer">
            <a href="login.html"
              >ูุฏูู ุญุณุงุจ ุจุงููุนูุ <strong>ุณุฌู ุงูุฏุฎูู</strong></a
            >
          </div>
        </form>
      </div>
    </div>

    <!-- Global Config & API functions -->
    <script src="js/config.js"></script>
    <script src="js/turo.js"></script>
    <script>
      const form = document.getElementById("register-form");
      const username = document.getElementById("username");
      const phone = document.getElementById("phone");

      /**
       * ูููู ุจุฅูุดุงุก ุฑูู ุชุณูุณูู ูุฑูุฏ ูููู ูู 4 ุฃุญุฑู ุตุบูุฑุฉ ู 4 ุฃุฑูุงู ุนุดูุงุฆูุฉ.
       * ูุชู ุฎูุท ุงูุฃุญุฑู ูุฌุนู ุงูุฑูู ุงูุชุณูุณูู ุฃูู ูุงุจููุฉ ููุชูุจุค.
       * @returns {string} ุฑูู ุชุณูุณูู ุนุดูุงุฆู ูููู ูู 8 ุฃุญุฑู.
       */
      function generateSerialNumber() {
        const letters = "abcdefghijklmnopqrstuvwxyz";
        const digits = "0123456789";
        let chars = [];

        // 1. ุฅุถุงูุฉ 4 ุฃุญุฑู ุตุบูุฑุฉ ุนุดูุงุฆูุฉ
        for (let i = 0; i < 4; i++) {
          chars.push(letters.charAt(Math.floor(Math.random() * letters.length)));
        }

        // 2. ุฅุถุงูุฉ 4 ุฃุฑูุงู ุนุดูุงุฆูุฉ
        for (let i = 0; i < 4; i++) {
          chars.push(digits.charAt(Math.floor(Math.random() * digits.length)));
        }

        // 3. ุฎูุท ุงููุตูููุฉ ูุถูุงู ุงูุนุดูุงุฆูุฉ
        for (let i = chars.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [chars[i], chars[j]] = [chars[j], chars[i]]; // ุชุจุฏูู ุงูุนูุงุตุฑ
        }

        // 4. ุฏูุฌ ุงููุตูููุฉ ูุชูููู ุงูุณูุณูุฉ ุงูููุงุฆูุฉ
        return chars.join("");
      }

      // Function to show error message
      const showError = (input, message) => {
        const errorDiv = document.getElementById(`${input.id}-error`);
        input.classList.add("input-error");
        errorDiv.textContent = message;
      };

      // Function to clear error message
      const clearError = (input) => {
        const errorDiv = document.getElementById(`${input.id}-error`);
        input.classList.remove("input-error");
        errorDiv.textContent = "";
      };

      // ุฅุถุงูุฉ ูุณุชูุน ูุญุฏุซ ุงูุฅุฏุฎุงู ูุชูููุฉ ุฑูู ุงููุงุชู ูู ุงูููุช ุงููุนูู
      phone.addEventListener("input", function (e) {
        let value = e.target.value;
        // ุชุนุฑูู ูุงููุณ ูุชุญููู ุงูุฃุฑูุงู ุงูููุฏูุฉ ุฅูู ุงูุฅูุฌููุฒูุฉ
        const hindiToArabic = {
          "ู": "0", "ูก": "1", "ูข": "2", "ูฃ": "3", "ูค": "4",
          "ูฅ": "5", "ูฆ": "6", "ูง": "7", "ูจ": "8", "ูฉ": "9",
        };

        // ุงุณุชุจุฏุงู ุงูุฃุฑูุงู ุงูููุฏูุฉ ุจุงูุฅูุฌููุฒูุฉ
        value = value.replace(/[ู-ูฉ]/g, (d) => hindiToArabic[d]);

        // ุฅุฒุงูุฉ ุฃู ุญุฑู ููุณ ุฑูููุง (0-9)
        value = value.replace(/[^0-9]/g, "");

        // ุชุญุฏูุซ ูููุฉ ุงูุญูู
        e.target.value = value;
      });

      form.addEventListener("submit", async function (e) {
        e.preventDefault(); // Prevent form from submitting
        let isValid = true;

        // --- Validation ---

        // 1. Username validation
        clearError(username);
        const usernameValue = username.value.trim();
        if (usernameValue === "") {
          showError(username, "ุงูุงุณู ูุทููุจ.");
          isValid = false;
        } else if (usernameValue.length < 8 || usernameValue.length > 30) {
          showError(username, "ุงูุงุณู ูุฌุจ ุฃู ูููู ุจูู 8 ู 30 ุญุฑููุง.");
          isValid = false;
        }

        // 2. Phone validation
        clearError(phone);
        const phoneValue = phone.value.trim();
        if (phoneValue === "") {
          showError(phone, "ุฑูู ุงููุงุชู ูุทููุจ.");
          isValid = false;
        } else if (phoneValue.length < 11) {
          showError(phone, "ุฑูู ุงููุงุชู ูุฌุจ ุฃูุง ููู ุนู 11 ุฑูููุง.");
          isValid = false;
        }

        if (isValid) {
          const userKey = generateSerialNumber(); // ๐ ุชูููุฏ ุงูุฑูู ุงูุชุณูุณูู
          const newUser = {
            username: username.value.trim(),
            phone: phone.value.trim(),
            user_key: userKey, // ุฅุถุงูุฉ ุงูุฑูู ุงูุชุณูุณูู ููุจูุงูุงุช
          };

          // ุฅุธูุงุฑ ุฑุณุงูุฉ ุงูุชุธุงุฑ ุจุงุณุชุฎุฏุงู SweetAlert2
          Swal.fire({
            title: "ุฌุงุฑู ุฅูุดุงุก ุงูุญุณุงุจ...",
            text: "ุงูุฑุฌุงุก ุงูุงูุชุธุงุฑ ููููุงู.",
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            },
          });

          try {
            const result = await addUser(newUser);
            Swal.close(); // ุฅุบูุงู ุฑุณุงูุฉ ุงูุงูุชุธุงุฑ

            if (result && result.message) {
              // ุญูุธ ุจูุงูุงุช ุงููุณุชุฎุฏู ูู ุงูุชุฎุฒูู ุงููุญูู ูุชุณุฌูู ุฏุฎููู
              localStorage.setItem("loggedInUser", JSON.stringify(newUser));

              // ุฅุธูุงุฑ ุฑุณุงูุฉ ุชุฑุญูุจ ูุจู ุงูุชูุฌูู ุฅูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
              Swal.fire({
                icon: "success",
                title: "ุชู ุฅูุดุงุก ุงูุญุณุงุจ ุจูุฌุงุญ!",
                text: "ูุฑุญุจุง ุจู ูู ุจุงุฒุงุฑ ุงูุณููุณ",
                confirmButtonText: "ูุชุงุจุนุฉ ุฅูู ุงูุฑุฆูุณูุฉ",
              }).then((result) => {
                // ุจุนุฏ ุงูุถุบุท ุนูู ุฒุฑ ุงููุชุงุจุนุฉุ ูุชู ุชูุฌูู ุงููุณุชุฎุฏู
                if (result.isConfirmed) {
                  window.location.href = "index.html";
                }
              });
            } else if (result && result.error) {
              // ุฅุฐุง ูุงู ููุงู ุฎุทุฃ ูู ุงูุฎุงุฏู (ูุซู ุฑูู ูุงุชู ููุฑุฑ)
              showError(phone, result.error);

            } else {
              // ูู ุญุงูุฉ ูุดู ุบูุฑ ูุนุฑูู ุงูุณุจุจ ูู ุงูุฎุงุฏู
              showError(form, "ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.");
            }
          } catch (error) {
            Swal.close(); // ุชุฃูุฏ ูู ุฅุบูุงู ุงูุฑุณุงูุฉ ูู ุญุงูุฉ ุญุฏูุซ ุฎุทุฃ
            console.error("Error during registration:", error);
            // ูุฐุง ุงูุฎุทุฃ ูุญุฏุซ ุฅุฐุง ูุงูุช ููุงู ูุดููุฉ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู ุฃู ุงูููุฏ
            showError(form, "ุญุฏุซ ุฎุทุฃ ูู ุงูุชุทุจูู. ูุฑุฌู ุงููุญุงููุฉ ูุงุญูุงู.");
          }
        }
      });
    </script>
  </body>
</html>
